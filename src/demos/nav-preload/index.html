<!DOCTYPE html>
<html>
<head>
  <title>Navigation preload demo</title>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
<script>
  (function() {
    const button = document.createElement('button');
    button.textContent = 'Loadingâ€¦';
    button.disabled = true;
    document.body.appendChild(button);

    if (!('serviceWorker' in navigator)) {
      button.textContent = 'Service worker not supported';
    }

    navigator.serviceWorker.register('sw.js');
    
    navigator.serviceWorker.ready.then(reg => {
      new Promise(resolve => {
        const worker = reg.active;

        if (worker.state == 'activated') {
          resolve();
          return;
        }

        worker.addEventListener('statechange', () => resolve(), {once: true});
      }).then(() => {
        if (!reg.navigationPreload) {
          button.textContent = 'Navigation preload not supported';
          return;
        }

        let enabled = false;

        function updateUi() {
          button.disabled = false;
          button.textContent = enabled ? 'Disable navigation preload' : 'Enable navigation preload';
        }

        reg.navigationPreload.getState().then(state => {
          enabled = state.enabled;
          updateUi();
        });

        button.addEventListener('click', () => {
          enabled = !enabled;
          updateUi();
          if (enabled) {
            reg.navigationPreload.enable();
          }
          else {
            reg.navigationPreload.disable();
          }
        });
      });
    });
    // Log performance details:
    window.addEventListener('load', () => {
      for (const key of ['fetchStart', 'connectStart', 'connectEnd', 'requestStart', 'responseStart', 'responseEnd', 'domComplete']) {
        console.log(key, performance.timing[key] - performance.timing.navigationStart);
      }
    });
  })();
</script>
<div class="content">
  <div class="container new-discussion-timeline experiment-repo-nav">
  <div class="repository-content">


<div class="issues-listing" data-pjax="">
    <div id="show_issue" class="js-issues-results">



    <div id="discussion_bucket" class="clearfix">
      

      <div class="discussion-timeline js-quote-selection-container ">

        <div class="js-discussion js-socket-channel" data-channel="tenant:1:marked-as-read:issue:162585129">
          

  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/slightlyoff"></a>
    

<div id="issue-162585129" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="502f93d7576c349587b8d420768a826f">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/slightlyoff" class="author">slightlyoff</a> 
    </strong>

    commented

      <a href="#issue-162585129" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-06-28T01:46:24Z">Jun 28, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body markdown-format js-comment-body">
              <p>Apologies in advance for the length of this issue.</p>
<p>A few weeks ago I was discussing the topic of the upcoming <a href="https://bugs.chromium.org/p/chromium/issues/detail?id=368813">"PlzNavigate" feature</a> with <a href="https://github.com/naskooskov" class="user-mention">@naskooskov</a>, <a href="https://github.com/n8schloss" class="user-mention">@n8schloss</a>, and <a href="https://github.com/bmaurer" class="user-mention">@bmaurer</a>.</p>
<p>The TL;DR of PlzNavigate is that navigation actions in Chromium will not be handled as they currently are -- sending them through a Renderer process which then routes them to the Browser process for eventual dispatch by the network stack -- and will instead be immediately routed to the Browser-side network stack, improving time-to-navigation in the common (non-SW-controlled) case. This is beneficial in the PlzNavigate world which is much more aggressively multi-process oriented. Saving the time to create processes is a big win, particularly on Android which "features" particularly slow native process creation.</p>
<p>In Chromium (and one assumes similarly architected browsers), this means that PlzNavigate-style request optimisation runs afoul of Service Worker handling of these requests. This isn't particularly satisfying as the SW may indeed choose to make a request for the top-level resource from the network. Indeed, waiting to issue these requests on Service Worker startup is being reported by large sites as a regression in the 10s or even hundred+ millisecond range. This is notable on sites which do not handle fetches for top-level documents but only want to use SWs for caching.</p>
<p>What if we could enable PlzNavigate <em>and</em> remove the hit generated by SW startup?</p>
<p>The idea in the following proposal is to allow a style of declarative navigation request decoration for these "preflight" navigation requests, allowing the Service Worker to use (or discard) the response. If no decoration is added and the site's SW decides to handle the request directly (e.g. with a <code>e.respondWith(fetch(e.request))</code>), nothing should break. Similarly, it's a goal to avoid sending the results of the "preflight" request to the document without the Service Worker's involvement.</p>
<p>To accomplish this, the proposal we sketched out on the whiteboard was to allow the <code>onfetch</code> event that corresponds to the navigation to have access to the original (preflight) response. To enable a savvy server-side to repurpose this preflight navigation to, e.g., send up-to-date data in a different format than HTML (imagine JSON or similar), we'd also allow the Service Worker to register a header to pass along with the preflight'd navigation request. All together, the strawman looks roughly like:</p>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">self</span>.<span class="pl-en">onactivate</span> <span class="pl-k">=</span> (<span class="pl-smi">e</span>) <span class="pl-k">=&gt;</span> {
  <span class="pl-c">// If unset, preflight requests are sent without special marking</span>
  <span class="pl-smi">e</span>.<span class="pl-en">setPreflightHeader</span>(<span class="pl-s"><span class="pl-pds">"</span>X-Site-Specific-Header<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>thinger<span class="pl-pds">"</span></span>);

  <span class="pl-c">// ...</span>
}

<span class="pl-smi">self</span>.<span class="pl-en">onfetch</span> <span class="pl-k">=</span> (<span class="pl-smi">e</span>) <span class="pl-k">=&gt;</span> {
  <span class="pl-k">if</span> (<span class="pl-smi">e</span>.<span class="pl-smi">preflightResponse</span>) {
    <span class="pl-c">// This is a navigation fetch which has already been issued.</span>
    <span class="pl-c">// If the `preflightResponse` isn't used, then everything proceeds as</span>
    <span class="pl-c">// if it hadn't been sent in the first place.</span>
  }
}</pre></div>
<p>Obviously the names are bike-sheddable. The goal however isn't to be super declarative about deciding what "routes" are handled in which style. Instead, it's to allow the maximum of flexibility for cooperating servers and clients to eliminate SW startup latency.</p>
<p>Thoughts?</p>
<p>/cc <a href="https://github.com/jakearchibald" class="user-mention">@jakearchibald</a> <a href="https://github.com/wanderview" class="user-mention">@wanderview</a> <a href="https://github.com/jungkees" class="user-mention">@jungkees</a> <a href="https://github.com/mkruisselbrink" class="user-mention">@mkruisselbrink</a></p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/annevk"></a>
    

<div id="issuecomment-228964442" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="05695f9f0a6fc8a5cc26ebd86e26f5f9">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      text-bold
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user is a member of the World Wide Web Consortium organization.
      ">
      Member
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/annevk" class="author">annevk</a> 
    </strong>

    commented

      <a href="#issuecomment-228964442" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-06-28T06:46:10Z">Jun 28, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>I'd like to know how specific this is to Chrome. From a high-level perspective it seems like a very weird hack.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/NekR"></a>
    

<div id="issuecomment-228971342" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="ef81ca4632e82bf1e24d4c0023877c69">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>



  <div class="timeline-comment-header-text">

    <strong>
      <a href="/NekR" class="author">NekR</a> 
    </strong>

    commented

      <a href="#issuecomment-228971342" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-06-28T07:20:57Z">Jun 28, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p><a href="https://github.com/annevk" class="user-mention">@annevk</a> I guess we need feedback from all implementers here, i.e. include Edge team to this conversation. Does anyone know who is working on SW in Microsoft?</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/jakearchibald"></a>
    

<div id="issuecomment-228987668" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="08ec7dd9cecd93718e63542337ef5968">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/jakearchibald" class="author">jakearchibald</a> 
    </strong>

    commented

      <a href="#issuecomment-228987668" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-06-28T08:39:43Z">Jun 28, 2016</relative-time></a>

      â€¢
      <span class="timestamp timestamp-edited tooltipped tooltipped-n" aria-label="jakearchibald edited this comment 5 months ago">
        edited
      </span>
  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>Going to tackle this in two replies, one addressing the problem &amp; another addressing the proposed solution - because I don't think they match up right now.</p>
<p><a href="https://github.com/slightlyoff" class="user-mention">@slightlyoff</a></p>
<p>Back when we started work on SW there were calls for higher level APIs, manifests and such, because SW <em>may</em> present performance issues in some cases, and your response to that was roughly "We shouldn't try and solve performance problems until we know we have them, and what shape &amp; size they are". This is still a good plan.</p>
<p>I want us to present solid data here that shows the size &amp; shape of the problem, and I want other vendors to verify that SW startup is the bottleneck here, and not something specific to Chrome.</p>
<p>There are multiple ways to solve this problem, and the way to pick the best solution is for us all to have good visibility into the issue.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/jakearchibald"></a>
    

<div id="issuecomment-229015463" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="1058016f1b07ef9eab328d7d5a5e34b2">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/jakearchibald" class="author">jakearchibald</a> 
    </strong>

    commented

      <a href="#issuecomment-229015463" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-06-28T10:47:55Z">Jun 28, 2016</relative-time></a>

      â€¢
      <span class="timestamp timestamp-edited tooltipped tooltipped-n" aria-label="jakearchibald edited this comment 5 months ago">
        edited
      </span>
  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>Without concrete data on the problem, it's difficult to assess solutions. Service worker startup is not free - but we need to assess when that cost significantly detracts from the benefits. It could be:</p>
<p><strong>I have no fetch event. I'm paying the startup cost for no reason.</strong></p>
<p>We solved this in <a href="https://github.com/w3c/ServiceWorker/issues/718" class="issue-link js-issue-link" data-url="https://github.com/w3c/ServiceWorker/issues/718" data-id="92573396" data-error-text="Failed to load issue title" data-permission-text="Issue title is private">#718</a>, but <a href="https://bugs.chromium.org/p/chromium/issues/detail?id=605844">Chrome hasn't landed it yet</a>. This is the case for at least one of the large sites reporting this regression.</p>
<p><strong>I have a fetch event but it doesn't <code>respondWith</code>. The result is blocked on SW startup, despite the SW having no impact on the result.</strong></p>
<p>We have an existing solution that we can apply here: <a href="https://github.com/WICG/EventListenerOptions/blob/gh-pages/explainer.md">passive listeners</a>. Although we may need to disable reading the request body in this case.</p>
<p><strong>I have a fetch event, it sometimes calls <code>respondWith</code>. If it does, it sometimes fetches <code>event.request</code>.</strong></p>
<p>I <em>think</em> this is the case the proposed solution is aiming for, but I really want to hear more about sites that use this pattern.</p>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">self</span>.<span class="pl-en">onactivate</span> <span class="pl-k">=</span> (<span class="pl-smi">e</span>) <span class="pl-k">=&gt;</span> {
  <span class="pl-c">// If unset, preflight requests are sent without special marking</span>
  <span class="pl-smi">e</span>.<span class="pl-en">setPreflightHeader</span>(<span class="pl-s"><span class="pl-pds">"</span>X-Site-Specific-Header<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>thinger<span class="pl-pds">"</span></span>);

  <span class="pl-c">// ...</span>
}</pre></div>
<p>This suggests the preflight will happen for each and every request (or just navigation requests for some reason?), which feels like a huge change. If I serve a 3gb video from the cache, what happens to the preflight? Is the user going to end up downloading the 3gb again, or will the stream be aborted? Either way, as a developer, I feel like I've just lost a lot of control.</p>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">self</span>.<span class="pl-en">onfetch</span> <span class="pl-k">=</span> (<span class="pl-smi">e</span>) <span class="pl-k">=&gt;</span> {
  <span class="pl-k">if</span> (<span class="pl-smi">e</span>.<span class="pl-smi">preflightResponse</span>) {
    <span class="pl-c">// This is a navigation fetch which has already been issued.</span>
    <span class="pl-c">// If the `preflightResponse` isn't used, then everything proceeds as</span>
    <span class="pl-c">// if it hadn't been sent in the first place.</span>
  }
}</pre></div>
<p>If the fetch event is blocked on a preflight response, you've killed service worker as a means for creating offline-first experiences. One way around this is to make <code>e.preflightResponse</code> undefined if the fetch event can fire before we have the preflight response. This becomes unpredictable and another loss of control. But furthermore:</p>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">self</span>.<span class="pl-en">onfetch</span> <span class="pl-k">=</span> <span class="pl-smi">event</span> <span class="pl-k">=&gt;</span> {
  <span class="pl-c1">event</span>.<span class="pl-en">respondWith</span>(
    <span class="pl-c1">event</span>.<span class="pl-smi">preflightResponse</span> <span class="pl-k">||</span> <span class="pl-en">fetch</span>(<span class="pl-c1">event</span>.<span class="pl-smi">request</span>)
  )
}</pre></div>
<p>If <code>preflightResponse</code> is fired because the fetch event won the race, we execute <code>fetch(event.request)</code>, making the request a second time. You could work around this by making <code>preflightResponse</code> a promise, but things are getting messy. You're still going to get the double request for existing service workers.</p>
<p>Additionally, using the response is still blocked on the SW, as the fetch event is always consulted. Is that ok? Again I want more concrete data.</p>
<p>The preflight is always going to happen, but I have to opt into using it. It seems really weird that the preflight isn't an opt-in, there isn't an opt-out, yet <em>using</em> the preflight is opt-in.</p>
<blockquote>
<p>The goal however isn't to be super declarative about deciding what "routes" are handled in which style. Instead, it's to allow the maximum of flexibility for cooperating servers and clients to eliminate SW startup latency.</p>
</blockquote>
<p>I see you put that bit in because I'm in favour of a route-based solution. <g-emoji alias="smile" fallback-src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f604.png" ios-version="6.0">ðŸ˜„</g-emoji>  But I don't see how routes are a worse solution, and your proposal doesn't feel awfully flexible, easy to reason about, or even address (what seems to be) the route of the problem.</p>
<p>A route-based solution should allow a developer to declare "for requests that look like this, do this", in a way that can at the very least started while the service worker boots up. This wins over the proposed preflight solution because:</p>
<ul>
<li>It needn't be restricted to navigation requests</li>
<li>It's opt-in, removing the need for redundant requests &amp; bandwidth usage</li>
<li>It can reach completion prior to service worker boot up</li>
<li>Whether the service worker is needed <em>at all</em> for a particular request can be determined in advance</li>
</ul>
<p>But again, I think we need clear data before we do something like this. We shouldn't rubber-stamp a scenario-solving solution, especially while we're so vague on the scenario.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/jakearchibald"></a>
    

<div id="issuecomment-229016073" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="7fe67e8069a7ce6a2713bf1abe9d8981">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/jakearchibald" class="author">jakearchibald</a> 
    </strong>

    commented

      <a href="#issuecomment-229016073" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-06-28T10:51:18Z">Jun 28, 2016</relative-time></a>

      â€¢
      <span class="timestamp timestamp-edited tooltipped tooltipped-n" aria-label="jakearchibald edited this comment 5 months ago">
        edited
      </span>
  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>A route-based sketch:</p>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">self</span>.<span class="pl-c1">addEventListener</span>(<span class="pl-s"><span class="pl-pds">'</span>install<span class="pl-pds">'</span></span>, <span class="pl-smi">event</span> <span class="pl-k">=&gt;</span> {
  <span class="pl-c1">event</span>.<span class="pl-en">waitUntil</span>(
    <span class="pl-c">// populate caches</span>
  );

  <span class="pl-c1">event</span>.<span class="pl-en">declareRoute</span>(<span class="pl-s"><span class="pl-pds">"</span>/<span class="pl-pds">"</span></span>, <span class="pl-k">new</span> <span class="pl-en">FallbackSources</span>(
    <span class="pl-k">new</span> <span class="pl-en">CachesSource</span>(),
    <span class="pl-k">new</span> <span class="pl-en">FetchSource</span>(),
    <span class="pl-k">new</span> <span class="pl-en">FetchEventSource</span>()
  ));
});</pre></div>
<p>This API is up for debate wayyyyyy beyond the naming, and I still think we need better data before we'd proceed with this. But here's how the above sketch could work:</p>
<p><strong><code>installEvent.declareRoute(requestDescriptor, action, opts)</code></strong></p>
<ul>
<li><code>requestDescriptor</code> - the requests this route this should handle. I'm doing a lot of hand-waving with this param right now, but it should be able to describe specific paths, path prefixes, path suffixes, origin (or any origin), method, maybe more. This could also be used in an API like <code>request.matches(descriptor)</code>. Could also include ways to modify the request, such as <code>appendHeaders</code>.</li>
<li><code>action</code> - where to get the response from.</li>
<li><code>opts.fireFetchEvent = "no"</code> - (<code>"yes"</code>/<code>"no"</code>/<code>"passive"</code>) - should the fetch event trigger after the action has resolved? The response, if any, will be available in <code>fetchEvent.routeResponse</code>. This allows JS to handle the response either directly or passively.</li>
</ul>
<p><strong><code>new FallbackSources(...sources)</code></strong></p>
<p>Attempt each source in series until an acceptable response is found. Alternatives could be <code>new AnySource(...sources)</code> which races sources until one provides an acceptable response.</p>
<p><strong><code>new CachesSource(opts)</code></strong></p>
<p>Look for a match in the cache. <code>opts</code> can handle the request to match on, which would be the current request by default, but could be set to something static (for getting a fallback page from the cache). Other options would cover specific caches, and things like <code>ignoreSearch</code>.</p>
<p><strong><code>new FetchSource(opts)</code></strong></p>
<p>Try to get a response from the network. <code>opts</code> could include the request to fetch, which would be the current request by default. <code>opts</code> could also include things like timeouts and such.</p>
<p><strong><code>new FetchEventSource()</code></strong></p>
<p>Defer to the fetch event.</p>
<p>So the example above:</p>
<ol>
<li>Looks for a response in the cache</li>
<li>Else attempts to request from the network</li>
<li>Else fires the fetch event a usual</li>
</ol>
<p>The whole thing can complete without the service worker starting up unless we hit step 3, and I'm pretty confident it could be polyfilled.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/wanderview"></a>
    

<div id="issuecomment-229094714" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="70e3ae0332125b08511430280c6f33a5">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/wanderview" class="author">wanderview</a> 
    </strong>

    commented

      <a href="#issuecomment-229094714" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-06-28T15:56:41Z">Jun 28, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>Can we tie this "preflight request" to the concept of "preload"?  We already have a rel=preload concept in the specs I believe.  The PlzNavigate effort to preload the site before the user finishes typing could be seen as the same mechanism.  This would give us a consistent mechanism to hang this optimization on without directly tying it to browser-specific mechanisms.</p>
<p>This does some like it could be useful, but its complex enough that it would probably only be used by a minority of sites.  Maybe its worth it if those sites are extremely high traffic?</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/wanderview"></a>
    

<div id="issuecomment-229096612" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="7748c8ae56e52e052ae8ea87249f68d0">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/wanderview" class="author">wanderview</a> 
    </strong>

    commented

      <a href="#issuecomment-229096612" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-06-28T16:02:53Z">Jun 28, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p><a href="https://github.com/jakearchibald" class="user-mention">@jakearchibald</a> So, the following would allow service worker startup to happen simultaneous with the network request?</p>
<pre><code>  event.declareRoute("/", new FetchSource(), { fireFetchEvent: 'yes' });
</code></pre>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/jakearchibald"></a>
    

<div id="issuecomment-229098327" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="04a69e2698fb97f574bbb1f2be03ed1b">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/jakearchibald" class="author">jakearchibald</a> 
    </strong>

    commented

      <a href="#issuecomment-229098327" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-06-28T16:08:48Z">Jun 28, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>Yep!</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/wanderview"></a>
    

<div id="issuecomment-229101543" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="4dacb86025631f2878cd6b328558c9dc">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/wanderview" class="author">wanderview</a> 
    </strong>

    commented

      <a href="#issuecomment-229101543" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-06-28T16:19:35Z">Jun 28, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>But the load would be delayed by bad network connections.  I guess maybe your AnySource() solution would allow you to handle this, but its not clear to me exactly how the pre-flight proposal would like to handle flaky network, either.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/jakearchibald"></a>
    

<div id="issuecomment-229108256" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="1e445fc37dc4db8659609d27858d2145">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/jakearchibald" class="author">jakearchibald</a> 
    </strong>

    commented

      <a href="#issuecomment-229108256" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-06-28T16:43:27Z">Jun 28, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>Yeah, <code>AnySource</code> would handle this, as would a <code>FallbackSource</code> that favoured the cache</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/wanderview"></a>
    

<div id="issuecomment-229109689" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="179fae26650458827fe420a11d52c72e">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/wanderview" class="author">wanderview</a> 
    </strong>

    commented

      <a href="#issuecomment-229109689" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-06-28T16:48:19Z">Jun 28, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <blockquote>
<p>I'd like to know how specific this is to Chrome. From a high-level perspective it seems like a very weird hack.</p>
</blockquote>
<p>I don't think this is particularly chrome specific.  Starting a worker thread, parsing js, interpreting, running the jit if necessary, etc are all overhead to letting the SW handle the fetch event.  Coming up with a mechanism to allow this overhead to be performed in parallel with an initial network request would benefit all browsers.</p>
<p>I guess ultimately its a tradeoff between complexity and those overhead costs.  Firefox might be slightly faster to start a service worker right now (I don't really know though), but we will likely end up with overhead similar to chrome once we fix our infrastructure to handle multiple content processes.</p>
<p>If we can come up with something that is not too complex, then it seems like a useful addition.</p>
<p>I do kind of agree with Jake, though, that maybe we should wait to implement these kinds of optimizations.  Its still early days for people figuring out how they want to use service workers.  If we implement this now we might miss out on a useful pattern people find they need or might make it more general purpose (complex) than is needed.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/jakearchibald"></a>
    

<div id="issuecomment-229390344" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="12be44446ff5801f87abcd51e5f9115f">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/jakearchibald" class="author">jakearchibald</a> 
    </strong>

    commented

      <a href="#issuecomment-229390344" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-06-29T15:20:35Z">Jun 29, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>With the routing proposal...</p>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">self</span>.<span class="pl-c1">addEventListener</span>(<span class="pl-s"><span class="pl-pds">'</span>install<span class="pl-pds">'</span></span>, <span class="pl-smi">event</span> <span class="pl-k">=&gt;</span> {
  <span class="pl-c1">event</span>.<span class="pl-en">waitUntil</span>(
    <span class="pl-c">// populate caches</span>
  );
});

<span class="pl-smi">self</span>.<span class="pl-c1">addEventListener</span>(<span class="pl-s"><span class="pl-pds">'</span>fetch<span class="pl-pds">'</span></span>, <span class="pl-smi">event</span> <span class="pl-k">=&gt;</span> {
  <span class="pl-c1">event</span>.<span class="pl-en">respondWith</span>(
    <span class="pl-smi">caches</span>.<span class="pl-c1">match</span>(<span class="pl-c1">event</span>.<span class="pl-smi">request</span>).<span class="pl-en">then</span>(<span class="pl-smi">r</span> <span class="pl-k">=&gt;</span> r <span class="pl-k">||</span> <span class="pl-en">fetch</span>(<span class="pl-c1">event</span>.<span class="pl-smi">request</span>))
  );
});</pre></div>
<p>...could be replaced with....</p>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">self</span>.<span class="pl-c1">addEventListener</span>(<span class="pl-s"><span class="pl-pds">'</span>install<span class="pl-pds">'</span></span>, <span class="pl-smi">event</span> <span class="pl-k">=&gt;</span> {
  <span class="pl-c1">event</span>.<span class="pl-en">waitUntil</span>(
    <span class="pl-c">// populate caches</span>
  );

  <span class="pl-c1">event</span>.<span class="pl-en">declareRoute</span>(<span class="pl-s"><span class="pl-pds">"</span>/<span class="pl-pds">"</span></span>, <span class="pl-k">new</span> <span class="pl-en">FallbackSources</span>(
    <span class="pl-k">new</span> <span class="pl-en">CachesSource</span>(),
    <span class="pl-k">new</span> <span class="pl-en">FetchSource</span>()
  ));
});</pre></div>
<p>...and the SW wouldn't need to boot up for any fetch events.</p>
<p>My blog currently composes a streamed response. If the cost of service worker bootup was greater than its benefit, I could do:</p>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">self</span>.<span class="pl-c1">addEventListener</span>(<span class="pl-s"><span class="pl-pds">'</span>install<span class="pl-pds">'</span></span>, <span class="pl-smi">event</span> <span class="pl-k">=&gt;</span> {
  <span class="pl-c1">event</span>.<span class="pl-en">waitUntil</span>(
    <span class="pl-c">// populate caches</span>
  );

  <span class="pl-c1">event</span>.<span class="pl-en">declareRoute</span>({mode<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>navigation<span class="pl-pds">"</span></span>}, <span class="pl-k">new</span> <span class="pl-en">AnySource</span>(
    <span class="pl-k">new</span> <span class="pl-en">FetchEventSource</span>(),
    <span class="pl-k">new</span> <span class="pl-en">FetchSource</span>()
  ));
});</pre></div>
<p>...allowing the browser to race the network and the fetch event for navigations.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  
      <div class="discussion-item discussion-item-ref">
    <div class="discussion-item-header" id="ref-issue-162963839">
      <span class="discussion-item-icon">
        <svg aria-hidden="true" class="octicon octicon-bookmark" height="16" version="1.1" viewBox="0 0 10 16" width="10"><path fill-rule="evenodd" d="M9 0H1C.27 0 0 .27 0 1v15l5-3.09L10 16V1c0-.73-.27-1-1-1zm-.78 4.25L6.36 5.61l.72 2.16c.06.22-.02.28-.2.17L5 6.6 3.12 7.94c-.19.11-.25.05-.2-.17l.72-2.16-1.86-1.36c-.17-.16-.14-.23.09-.23l2.3-.03.7-2.16h.25l.7 2.16 2.3.03c.23 0 .27.08.09.23h.01z"></path></svg>
      </span>

      
      <a href="/NekR" class="author" truncate="true">NekR</a>
      

      referenced
      this issue
      <a class="timestamp" href="#ref-issue-162963839">
        <relative-time datetime="2016-06-29T16:47:40Z">Jun 29, 2016</relative-time>
      </a>
    </div>

      <span class="state state-open float-right">
          <svg aria-hidden="true" class="octicon octicon-issue-opened" height="14" version="1.1" viewBox="0 0 14 16" width="12"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg>
        Open
      </span>



    <h4 class="discussion-item-ref-title">
      <a href="/w3c/ServiceWorker/issues/921" class="title-link">
        Enabling multiple Service Workers for a single scope
        <span class="issue-num">#921</span>
</a>    </h4>
    
  </div>


  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/slightlyoff"></a>
    

<div id="issuecomment-230120523" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="93ddc3b6fa8af05979b29dc7bca3a775">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/slightlyoff" class="author">slightlyoff</a> 
    </strong>

    commented

      <a href="#issuecomment-230120523" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-07-02T20:27:57Z">Jul 2, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>A few things seems missing from the conversation.</p>
<p>Many sites we've partnered with have deployed nearly-no-op SWs to do tracking and monitoring. This defeats the no-<code>onfetch</code> optimisation. Sites like FB and Google Inbox have goals that they go to extraordinary lengths to meet but have difficulty achieving thanks to the complexity of their stacks and the # of folks adding features:</p>
<ol>
<li>Get UI to users as fast as possible</li>
<li>Get fresh data into that UI, even though the UI is script-mediated (and, if not possible, show stale data)</li>
<li>Monitor the performance of the overall experience end-to-end</li>
</ol>
<p>Getting UI to users tends to involve "booting up" large amounts of JS, CSS, and associated context. This is true for FB, Inbox (in some modes), Docs (in some cases), and many others. In a no-SW world, the best strategy is to inline fresh content into the response document where the booted code can consume it and render it.</p>
<p>With SWs in the mix or server-rendering of snapshots (Inbox &amp; Docs, but only in certain modes), things get more complicated. A service designer of one of these systems wants to be able to:</p>
<ul>
<li>Get UI to the user reliably; that is to say, if there's a "header" or "shell" that can be served from cache with low variance, that's a good thing to do, even if the total latency may be slightly higher due to SW wakeup costs</li>
<li>Get requests for fresh data onto the network ASAP. Assuming you respond with a "shell" for <code>example.com/</code> (which we might imagine coming from a declaratively routed cache as <a href="https://github.com/jakearchibald" class="user-mention">@jakearchibald</a>  suggests, but not necessarily so), it'd be helpful to get a request to the server for new data started as soon in the lifetime as possible.</li>
<li>Ensure that everything works sensibly when there's no SW in play</li>
</ul>
<p>To handle the second of those, the proposal I've provided lets the server know a few things:</p>
<ol>
<li>A Service Worker is in play and therefore the app shell or "header" resources are already booting up</li>
<li>That, as a result, it's safe to respond with <em>just</em> data, not any cruft or dressing associated with a full-page render. In sever-language, it allows the server to send only a "partial"</li>
<li>That the response won't be dropped on the floor because the SW will be in play to handle (and redirect) it</li>
</ol>
<p>It does this with minimal new infrastructure, enabling both streaming for "static" sites that want to handle HTML partials and not data, as well as allowing sites that deal in data (vs. inline HTML) to do so naturally.</p>
<p>Would love to hear from <a href="https://github.com/bmaurer" class="user-mention">@bmaurer</a> on the alternatives proposed here as well.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/n8schloss"></a>
    

<div id="issuecomment-230128907" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="5564bca5ffa51c8c01589cd32eca7df6">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>



  <div class="timeline-comment-header-text">

    <strong>
      <a href="/n8schloss" class="author">n8schloss</a> 
    </strong>

    commented

      <a href="#issuecomment-230128907" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-07-03T00:38:55Z">Jul 3, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>That's a pretty good summary for what we want to do. In the shorter term we're going to cache parts of the page markup and then make a request for the rest, in the much longer run we're going to cache most of the markup but will still need to make a request for page data. In both cases we're going to want to make a request to our server to get data as soon as we can and at the same time start getting code to the client window as soon as we can.</p>
<p>Service worker startup isn't free: in Chrome, our in-the-field logging is telling us that service worker startup adds about 200ms to page load time on desktop. It might be slightly better or worse in other browsers, but it's still going to be a significant cost to startup a process and initialize the service worker code. Our site is pretty optimized to deliver resources quickly and in the right order, so our concern is that this extra time might mean that service workers are a regression in some cases.</p>
<p>What we don't want to do however is have a race between network and cache without actually opening from the service worker. If we're going to build a version of the site that can be fully loaded from a service worker we will most likely still need to make a request each time the page loads to get the newest content, so simply loading the site from cache won't always be a win if we have to wait to make a request afterwards anyway.</p>
<p>The optimization that we need allows us to get the initial request out before the service worker starts up but still allows the fetch event to get and process a request if one was sent out.</p>
<p>Having the option to set a header or other fetch options here is important because even in the short term we aren't going to return the same kind of markup when a service worker is there vs when it isn't. Also, making this field nullable in the fetch event seems fine to me. It can be called possiblePreflightRequest or something like that and then you can wait for it just like a normal request if you want to use it.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/jakearchibald"></a>
    

<div id="issuecomment-230139288" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="c5614eb1d2d140c78cbb33a002febf97">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/jakearchibald" class="author">jakearchibald</a> 
    </strong>

    commented

      <a href="#issuecomment-230139288" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-07-03T07:09:12Z">Jul 3, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p><a href="https://github.com/slightlyoff" class="user-mention">@slightlyoff</a> can you answer my questions about your proposal &amp; show why it's better than declarative routing?</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/bmaurer"></a>
    

<div id="issuecomment-230172116" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="a708d238ad070c4d4a67408c8fdccd5e">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>



  <div class="timeline-comment-header-text">

    <strong>
      <a href="/bmaurer" class="author">bmaurer</a> 
    </strong>

    commented

      <a href="#issuecomment-230172116" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-07-03T19:58:15Z">Jul 3, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>To add a bit more color to Nate's comments --</p>
<p>First, I think it's worth considering the position a site is in as it first adopts service worker. SW is a huge change to how people write websites. Any complex site is going to take a while to get it's feet wet. One thing that Alex mentions is that some people might use SW to do things that don't involve intercepting the root document the user navigates to (eg, caching static resources). A site might gradually use sw for only parts of the root document. Maybe first they just cache their page header. To the extent that using SW causes a perf hit (as Nate mentions there's a startup cost at least in chrome) that makes it hard for a site to dip their feet into using SW. Even if SW eventually enables great wins sites tend to develop incrementally and want each increment to be better on metrics. So in my mind an ideal solution here would be that a service worker that does nothing, has no cost</p>
<p>Now let's think about a more advanced SW deployment, taking a site like FB as an example. FB would have two goals:</p>
<ol>
<li>Display the chrome of the app as fast as possible, start warming up the JIT on core JS frameworks, and render existing data in cache</li>
<li>Get up to date data from the server as quickly as possible (eg an updated newsfeed)</li>
</ol>
<p>I think many apps share this set of dual goals -- for example, an email application would want to show existing emails quickly but fetch updated emails. In order to accomplish (2) one needs to communicate to the site's server "this user is opening the app". This message is generally fairly light weight -- at a minimum it needs to identify the user. But it may also need to communicate a small amount of information about the state of the cache. For example, you might need to communicate the last cached newsfeed story. As a slightly more complicated case one could imagine a large class of apps (uber, postmates, etc) that want to communicate the location as quickly as possible.</p>
<p>On our mobile apps we go to great lengths to make this notification happen as quickly as possible. Early in the startup process we send out a UDP packet that contains an encrypted user identifier. (<a href="https://code.facebook.com/posts/1675399786008080/optimizing-facebook-for-ios-start-time/">https://code.facebook.com/posts/1675399786008080/optimizing-facebook-for-ios-start-time/</a>)</p>
<p>Jake's route based proposal makes sense to me here. It seems like a generalization of Alex's preflight request. I think to make Jake's proposal work you'd need a few things:</p>
<ol>
<li>The cost of having a route that uses the cache and then fetch should be nearly identical to a site which doesn't use SW at all.</li>
<li>A sw should be able to have some state that is sent with a declaratively specified fetch. Eg, last cached feed story time.</li>
<li>It might be nice if the declarative post can be a POST request that is incomplete. That way once the SW starts up it can add more data to the post but the server can start processing</li>
</ol>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/slightlyoff"></a>
    

<div id="issuecomment-230172250" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="a5939f5a04b725aa8c7eee232b9ff74f">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/slightlyoff" class="author">slightlyoff</a> 
    </strong>

    commented

      <a href="#issuecomment-230172250" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-07-03T20:01:20Z">Jul 3, 2016</relative-time></a>

      â€¢
      <span class="timestamp timestamp-edited tooltipped tooltipped-n" aria-label="slightlyoff edited this comment 5 months ago">
        edited
      </span>
  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>I'll try (although I though I had by clarifying the requirements):</p>
<ul>
<li>First, the route based proposal doesn't appear to allow the server to decide how to overload the first response to serve only data (not UI + data).</li>
<li>Next, blocking on the SW is usually OK because now we're in a race. SW startup can be in the 10s to hundreds of ms in the worst cases, but isn't usually worse than that. You burn as much on DNS. As a result, it won't generally be a net loss to wait on the SW for mediating this interaction, particularly if you can shave off overhead of getting a new request out the door.</li>
<li>Lastly, the routing based proposal either has to defeat PlzNavigate entirely (if you only specify a <code>FetchSource()</code>) or, as I understand the example given, still wait on the renderer process for handling the <code>CacheSource()</code> entries (it's unclear we'd want the mapping logic for them in the browser process).</li>
</ul>
<p>I think we should probably do declarative routing. We should probably go with something not dissimilar from your proposal, <a href="https://github.com/jakearchibald" class="user-mention">@jakearchibald</a>, but I don't think it solves the issues <a href="https://github.com/n8schloss" class="user-mention">@n8schloss</a> or <a href="https://github.com/bmaurer" class="user-mention">@bmaurer</a> are raising nor does it really help our PlzNavigate integration. It's also quite a bit larger.</p>
<p>As a final thought, I think these can layer together quite nicely. Having the preflight come back as a readable stream that can be directed to the document (in cases where you might use a <code>FetchSource()</code> or a <code>CacheSource()</code>) doesn't seem to be at odds with the declarative proposal. It does mean you'd need to wake the SW to handle it, but that could also be turned into a declarative option I suppose. It's a new model and quite a lot of new API, though, so I have a preference for a minimal intervention.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/annevk"></a>
    

<div id="issuecomment-230217021" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="6b7986320f916da8dee3d9a87d1bff84">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      text-bold
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user is a member of the World Wide Web Consortium organization.
      ">
      Member
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/annevk" class="author">annevk</a> 
    </strong>

    commented

      <a href="#issuecomment-230217021" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-07-04T06:47:07Z">Jul 4, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>I think that if we want to handle navigation differently (so sites can only do service workers for subresources or some such) it needs to be an opt-in primitive of sorts. We should not take total network control away from the site due to Chrome's PlzNavigate project.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/annevk"></a>
    

<div id="issuecomment-230217187" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="1aa13e7e8812a72261f28ff2d53158bd">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      text-bold
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user is a member of the World Wide Web Consortium organization.
      ">
      Member
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/annevk" class="author">annevk</a> 
    </strong>

    commented

      <a href="#issuecomment-230217187" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-07-04T06:48:20Z">Jul 4, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>It's also now more clear than ever that those pushing to make fetch opt-in were correct. <g-emoji alias="confused" fallback-src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f615.png" ios-version="6.0">ðŸ˜•</g-emoji></p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/jakearchibald"></a>
    

<div id="issuecomment-230246297" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="cbb23268cdb21cc139006ad322849f1e">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/jakearchibald" class="author">jakearchibald</a> 
    </strong>

    commented

      <a href="#issuecomment-230246297" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-07-04T09:25:29Z">Jul 4, 2016</relative-time></a>

      â€¢
      <span class="timestamp timestamp-edited tooltipped tooltipped-n" aria-label="jakearchibald edited this comment 5 months ago">
        edited
      </span>
  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>Trying to get a concrete picture of the problem here. Someone shout up if this is wrong.</p>
<p>The loading strategy is:</p>
<ul>
<li>Load UI sans-content from the cache</li>
<li>JS loads content 'include' from network</li>
</ul>
<p>Here's some sample code for this: <a href="https://gist.github.com/jakearchibald/4927b34bb14c3681a3c1c1ce6ede5b09/b43199815f451cadde7280aa9b8dea1f84a88387">https://gist.github.com/jakearchibald/4927b34bb14c3681a3c1c1ce6ede5b09/b43199815f451cadde7280aa9b8dea1f84a88387</a></p>
<p>And the problem is:</p>
<ul>
<li>On initial navigation the service worker bootup time (200ms?) delays cached shell render and delays subsequent network request for content</li>
</ul>
<p>It's still unclear to me how that delay compares to the benefits of rendering without the network. Even if it's only the shell that's rendered without the network, getting the shell &amp; JS from the cache should come with a benefit vs the network.</p>
<p>But yes, as a site adopts SW, there may be particular navigation routes that simply defer to default browser behaviour.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/jakearchibald"></a>
    

<div id="issuecomment-230246316" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="24bc64a10b273a8d4abc99ee83344da5">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/jakearchibald" class="author">jakearchibald</a> 
    </strong>

    commented

      <a href="#issuecomment-230246316" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-07-04T09:25:38Z">Jul 4, 2016</relative-time></a>

      â€¢
      <span class="timestamp timestamp-edited tooltipped tooltipped-n" aria-label="jakearchibald edited this comment 5 months ago">
        edited
      </span>
  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p><a href="https://github.com/n8schloss" class="user-mention">@n8schloss</a></p>
<blockquote>
<p>What we don't want to do however is have a race between network and cache without actually opening from the service worker.</p>
</blockquote>
<p>But what about a race between the fetch event and a default network response?</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/jakearchibald"></a>
    

<div id="issuecomment-230246916" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="974979f2e1469f0cd8204074640a5f78">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/jakearchibald" class="author">jakearchibald</a> 
    </strong>

    commented

      <a href="#issuecomment-230246916" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-07-04T09:28:20Z">Jul 4, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p><a href="https://github.com/bmaurer" class="user-mention">@bmaurer</a></p>
<blockquote>
<p>A site might gradually use sw for only parts of the root document</p>
</blockquote>
<p>This is why we need a routing approach. Making all-or-nothing behaviour changes doesn't fit into this gradual model.</p>
<blockquote>
<p>So in my mind an ideal solution here would be that a service worker that does nothing, has no cost</p>
</blockquote>
<p>Like I said in <a href="https://github.com/w3c/ServiceWorker/issues/920#issuecomment-229015463" class="issue-link js-issue-link" data-url="https://github.com/w3c/ServiceWorker/issues/920" data-id="162585129" data-error-text="Failed to load issue title" data-permission-text="Issue title is private">#920 (comment)</a>, the spec already caters for this, and impelementation is in progress.</p>
<blockquote>
<p>The cost of having a route that uses the cache and then fetch should be nearly identical to a site which doesn't use SW at all.</p>
</blockquote>
<p>Seems fair. It certainly shouldn't be slower than appcache.</p>
<blockquote>
<p>A sw should be able to have some state that is sent with a declaratively specified fetch. Eg, last cached feed story time.</p>
</blockquote>
<p>Do you need something beyond <code>last-modified</code> or <code>ETag</code>?</p>
<blockquote>
<p>It might be nice if the declarative post can be a POST request that is incomplete. That way once the SW starts up it can add more data to the post but the server can start processing</p>
</blockquote>
<p>This seems like a separate thing (it's the first time posting has come up). What problem is this solving? As in, when would you want to POST along with an initial navigation? Related: there is a <a href="https://github.com/jakearchibald/background-cache">rough plan for background posting/downloads</a>.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/jakearchibald"></a>
    

<div id="issuecomment-230256461" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="217f22878889352af6a6a7c72aa404f4">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/jakearchibald" class="author">jakearchibald</a> 
    </strong>

    commented

      <a href="#issuecomment-230256461" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-07-04T10:15:00Z">Jul 4, 2016</relative-time></a>

      â€¢
      <span class="timestamp timestamp-edited tooltipped tooltipped-n" aria-label="jakearchibald edited this comment 5 months ago">
        edited
      </span>
  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p><a href="https://github.com/slightlyoff" class="user-mention">@slightlyoff</a></p>
<blockquote>
<p>the route based proposal doesn't appear to allow the server to decide how to overload the first response</p>
</blockquote>
<p>These could easily be options to <code>FetchSource</code>.</p>
<div class="highlight highlight-source-js"><pre><span class="pl-c1">event</span>.<span class="pl-en">declareRoute</span>({mode<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>navigation<span class="pl-pds">'</span></span>}, <span class="pl-k">new</span> <span class="pl-en">FetchSource</span>({
  applyHeaders<span class="pl-k">:</span> {
    <span class="pl-s"><span class="pl-pds">'</span>X-Site-Specific-Header<span class="pl-pds">'</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>thinger<span class="pl-pds">"</span></span>
  }
}), {fireFetchEvent<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>yes<span class="pl-pds">'</span></span>});</pre></div>
<p>I think that's equivalent to your proposal (I don't know for sure as you haven't described how your proposal works),</p>
<blockquote>
<p>blocking on the SW is usually OK because now we're in a race</p>
</blockquote>
<p>Are we sure that's the case? Based on <a href="https://gist.github.com/jakearchibald/4927b34bb14c3681a3c1c1ce6ede5b09/b43199815f451cadde7280aa9b8dea1f84a88387">the code example above</a>, if we had routing, the following could happen while the SW was booting up:</p>
<ul>
<li>Shell fetched from cache, giving a first render</li>
<li>JS fetched from cache</li>
<li>JS parsed &amp; executed</li>
<li>Fetch called for data</li>
</ul>
<p>If that takes longer than 200ms, then we've won. Not only that, but we rendered while that was happening.</p>
<p>Contrast this to your preflight proposal, where:</p>
<ul>
<li>Render is blocked by SW startup, and potentially the network request too (you haven't explained how it works)</li>
<li>The fetch call is a separate request, so it won't have the preflight there, so I don't see how the problem is solved</li>
<li>The fetch call may also be blocked on the network, even if it doesn't need to be.</li>
</ul>
<blockquote>
<p>Lastly, the routing based proposal either has to defeat PlzNavigate entirely (if you only specify a FetchSource()) or, as I understand the example given, still wait on the renderer process for handling the CacheSource() entries (it's unclear we'd want the mapping logic for them in the browser process).</p>
</blockquote>
<p>If you're racing <code>FetchSource</code> with other sources it won't be a problem. That's basically what your proposal is doing (I think), but it only does that.</p>
<blockquote>
<p>Having the preflight come back as a readable stream that can be directed to the document (in cases where you might use a FetchSource() or a CacheSource()) doesn't seem to be at odds with the declarative proposal. It does mean you'd need to wake the SW to handle it, but that could also be turned into a declarative option I suppose.</p>
</blockquote>
<p>We're already talking about hacking around your proposal. It's too high level, and too all-encompasing. Also, you <em>still</em> haven't answered my questions on how it works.</p>
<p>My questions are in <a href="https://github.com/w3c/ServiceWorker/issues/920#issuecomment-229015463" class="issue-link js-issue-link" data-url="https://github.com/w3c/ServiceWorker/issues/920" data-id="162585129" data-error-text="Failed to load issue title" data-permission-text="Issue title is private">#920 (comment)</a>. The outstanding questions are:</p>
<ul>
<li>Is the preflight opt-in? If so, by what mechanism?</li>
<li>Does the preflight happen for every request, or just navigations?</li>
<li>What type is <code>e.preflightResponse</code> is it a <code>Response</code>?</li>
<li>What happens if the fetch event can fire before <code>e.preflightResponse</code> is ready?</li>
<li>If I do not use the preflight, what happens to it? Eg what if it's a 3gb video?</li>
<li>If my SW does fetch(event.request), is that an additional request? That will be the case for most existing SWs</li>
<li>If my SW does fetch(event.request.url), is that an additional request?</li>
</ul>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/jakearchibald"></a>
    

<div id="issuecomment-230257073" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="619503abf68f01d2cba540ec26387a2c">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/jakearchibald" class="author">jakearchibald</a> 
    </strong>

    commented

      <a href="#issuecomment-230257073" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-07-04T10:18:09Z">Jul 4, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p><a href="https://github.com/annevk" class="user-mention">@annevk</a></p>
<blockquote>
<p>It's also now more clear than ever that those pushing to make fetch opt-in were correct.</p>
</blockquote>
<p>It's already opt-in. If you don't want it, don't add a fetch listener.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/annevk"></a>
    

<div id="issuecomment-230262363" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="28cb2671e81efd91442449369c3380eb">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      text-bold
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user is a member of the World Wide Web Consortium organization.
      ">
      Member
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/annevk" class="author">annevk</a> 
    </strong>

    commented

      <a href="#issuecomment-230262363" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-07-04T10:46:31Z">Jul 4, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>True, we made it opt-in ex post facto through a hack. It still looks weird compared to the other APIs exposed by service workers and makes it harder to add registration options specific to fetch, such as some kind of filtering mechanism.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/jakearchibald"></a>
    

<div id="issuecomment-230273545" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="b4393f4f1b49005c2b1d8884efe02b87">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/jakearchibald" class="author">jakearchibald</a> 
    </strong>

    commented

      <a href="#issuecomment-230273545" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-07-04T11:53:27Z">Jul 4, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>Here's the current model for an "app shell" site that uses JS to populate content <a href="https://gist.github.com/jakearchibald/4927b34bb14c3681a3c1c1ce6ede5b09/b43199815f451cadde7280aa9b8dea1f84a88387">https://gist.github.com/jakearchibald/4927b34bb14c3681a3c1c1ce6ede5b09/b43199815f451cadde7280aa9b8dea1f84a88387</a></p>
<p>Here's what it would look like with the routing proposal <a href="https://gist.github.com/jakearchibald/4927b34bb14c3681a3c1c1ce6ede5b09/c8bdf11ada8a99bb506f369d7d040051ad4dda16">https://gist.github.com/jakearchibald/4927b34bb14c3681a3c1c1ce6ede5b09/c8bdf11ada8a99bb506f369d7d040051ad4dda16</a> - this doesn't need the SW to boot up at all.</p>
<p><a href="https://github.com/slightlyoff" class="user-mention">@slightlyoff</a>, can you show how your solution would work in this case? (in addition to clarifying the behaviour of your proposal)</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/bmaurer"></a>
    

<div id="issuecomment-230317980" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="858d9266302de32a7612a8bf11853795">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>



  <div class="timeline-comment-header-text">

    <strong>
      <a href="/bmaurer" class="author">bmaurer</a> 
    </strong>

    commented

      <a href="#issuecomment-230317980" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-07-04T15:51:03Z">Jul 4, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <blockquote>
<p>The loading strategy is:</p>
<ul>
<li>Load UI sans-content from the cache</li>
<li>JS loads content 'include' from network<br>
Here's some sample code for this: <a href="https://gist.github.com/jakearchibald/4927b34bb14c3681a3c1c1ce6ede5b09/b43199815f451cadde7280aa9b8dea1f84a88387">https://gist.github.com/jakearchibald/4927b34bb14c3681a3c1c1ce6ede5b09/b43199815f451cadde7280aa9b8dea1f84a88387</a></li>
</ul>
<p>And the problem is:</p>
<ul>
<li>On initial navigation the service worker bootup time (200ms?) delays cached shell render and delays subsequent network request for content</li>
</ul>
<p>It's still unclear to me how that delay compares to the benefits of rendering without the network. Even if it's only the shell that's rendered without the network, getting the shell &amp; JS from the cache should come with a benefit vs the network.</p>
</blockquote>
<p>The problem is that even though we win on getting the shell displayed faster, we lose in terms of the amount of time that it takes for the server to start processing our request and to send more data. Keep in mind that today Facebook uses chunked encoding. Within 10 ms of a request touching our server we start sending back instructions on how to load the app shell. So for us the loading of the app shell is already happening in parallel with our server work. For many requests the critical path in displaying new content is the speed of computing that ranking. Even if SW is a win in being able to display the app shell more quickly that may not help us meet the business objective of displaying up to date newsfeed stories more quickly.</p>
<p>What we're looking for here is the best of both worlds -- being able to display the app shell without a network connection without increasing the delay between when a user clicks facebook.com and when our servers are able to start giving them new content.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/jakearchibald"></a>
    

<div id="issuecomment-230319640" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="1fbcd563891750a72bed19cebc1ce1a8">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/jakearchibald" class="author">jakearchibald</a> 
    </strong>

    commented

      <a href="#issuecomment-230319640" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-07-04T16:01:43Z">Jul 4, 2016</relative-time></a>

      â€¢
      <span class="timestamp timestamp-edited tooltipped tooltipped-n" aria-label="jakearchibald edited this comment 5 months ago">
        edited
      </span>
  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p><a href="https://github.com/bmaurer" class="user-mention">@bmaurer</a></p>
<p>Thanks! Is there any server rendering of dynamic content going on here, or is content added to the page using JS? If it's the former, a <a href="https://jakearchibald.com/2016/streams-ftw/#streaming-results">streaming solution</a> seems a better fit. If it's the latter, could <code>&lt;link rel="preload"&gt;</code> (in combination with the routing) start warming up the server as the shell is booting up?</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/bmaurer"></a>
    

<div id="issuecomment-230325952" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="363f81edf2bc72630542acf376f07c03">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>



  <div class="timeline-comment-header-text">

    <strong>
      <a href="/bmaurer" class="author">bmaurer</a> 
    </strong>

    commented

      <a href="#issuecomment-230325952" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-07-04T16:44:22Z">Jul 4, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>This would be content to be added via JS. The problem is that rel=preload is going to get loaded <em>way</em> too late. In chrome at least that requires the renderer process to be started. Also, this doesn't give the SW a great chance to save state. Your idea of using etags is interesting but I think it might not capture the kinds of data one would want to send. For example, one may wish to send information about what JS/CSS files are in the cache so the server can render markup for an appropriate version of the site.</p>
<p>Ideally what I'd want here is something like "facebook.com/ has a route that will load a cached version of the app shell. In addition, it will send a request to facebook.com/newdata with the header CurState:XYZ where XYZ can be managed by the service worker as its cached state changes". The request to /newdata should have as little delay as possible.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/jakearchibald"></a>
    

<div id="issuecomment-230441406" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="5bab5761240704c334ef1cf6186c0a3a">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/jakearchibald" class="author">jakearchibald</a> 
    </strong>

    commented

      <a href="#issuecomment-230441406" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-07-05T10:20:01Z">Jul 5, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p><a href="https://github.com/bmaurer" class="user-mention">@bmaurer</a> hmm, so there's a problem with both my &amp; <a href="https://github.com/slightlyoff" class="user-mention">@slightlyoff</a>'s proposals for this use-case. The preloaded response that ends up in the navigation's fetch event, is actually intended for a future subresource fetch.</p>
<p>Both designs put you in a situation where you'd have to pass the preloaded response into the global scope and hope it's still there when you need it. This is really hacky, and would break if a browser ever spun up multiple instances of the SW for parallelism (there's no plan to do this, but it'd be nice if we could at some point).</p>
<p>It feels like <code>&lt;link rel="preload"&gt;</code> has the right behaviour aside from happening too late. So the solution could be routing + a list of resources to preload, which would be satisfied by their own routes.</p>
<p>Something like <a href="https://gist.github.com/jakearchibald/4927b34bb14c3681a3c1c1ce6ede5b09/cb8328fee735414ced91ff38617b48f73cfb0a1f">https://gist.github.com/jakearchibald/4927b34bb14c3681a3c1c1ce6ede5b09/cb8328fee735414ced91ff38617b48f73cfb0a1f</a>?</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/wanderview"></a>
    

<div id="issuecomment-230464831" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="aac6fc27fd426d314c273195db0ddb15">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/wanderview" class="author">wanderview</a> 
    </strong>

    commented

      <a href="#issuecomment-230464831" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-07-05T12:31:06Z">Jul 5, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <blockquote>
<p>Something like <a href="https://gist.github.com/jakearchibald/4927b34bb14c3681a3c1c1ce6ede5b09/cb8328fee735414ced91ff38617b48f73cfb0a1f">https://gist.github.com/jakearchibald/4927b34bb14c3681a3c1c1ce6ede5b09/cb8328fee735414ced91ff38617b48f73cfb0a1f</a>?</p>
</blockquote>
<p>I think this is missing the current state token, though, right?  The <code>/page-data</code> request needs to have some piece of state so the server can generate the appropriate update response.</p>
<p>In the above comments it seems they wanted to use a POST, although I guess a cookie could be used with your proposal here?</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/jakearchibald"></a>
    

<div id="issuecomment-230465216" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="dc8a3dbb44b0ddb564cbd1a67e72bc02">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/jakearchibald" class="author">jakearchibald</a> 
    </strong>

    commented

      <a href="#issuecomment-230465216" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-07-05T12:33:06Z">Jul 5, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>I captured <a href="https://github.com/slightlyoff" class="user-mention">@slightlyoff</a> in the pub and got him to answer the questions on his proposal. Here they are (from memory):</p>
<blockquote>
<p>Is the preflight opt-in? If so, by what mechanism?</p>
</blockquote>
<p>Maybe/probably. No mechanism yet. Maybe it should only be for certain urls.</p>
<blockquote>
<p>Does the preflight happen for every request, or just navigations?</p>
</blockquote>
<p>Just navigations.</p>
<blockquote>
<p>What type is e.preflightResponse is it a Response?<br>
What happens if the fetch event can fire before e.preflightResponse is ready?</p>
</blockquote>
<p><code>e.preflightResponse</code> should be a promise, therefore the fetch event isn't delayed.</p>
<blockquote>
<p>If I do not use the preflight, what happens to it? Eg what if it's a 3gb video?</p>
</blockquote>
<p>Unsure.</p>
<blockquote>
<p>If my SW does fetch(event.request), is that an additional request? That will be the case for most existing SWs<br>
If my SW does fetch(event.request.url), is that an additional request?</p>
</blockquote>
<p>It will make an extra request.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/jakearchibald"></a>
    

<div id="issuecomment-230465747" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="7dd57099992eb859924ed8d7e76968bd">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/jakearchibald" class="author">jakearchibald</a> 
    </strong>

    commented

      <a href="#issuecomment-230465747" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-07-05T12:35:36Z">Jul 5, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p><a href="https://github.com/wanderview" class="user-mention">@wanderview</a></p>
<blockquote>
<p>I think this is missing the current state token, though, right?</p>
</blockquote>
<p>Oh good point. Updated code so the preload includes credentials. <a href="https://gist.github.com/jakearchibald/4927b34bb14c3681a3c1c1ce6ede5b09/dc1b9eccb825287cda46a8defed1254d660e2675">https://gist.github.com/jakearchibald/4927b34bb14c3681a3c1c1ce6ede5b09/dc1b9eccb825287cda46a8defed1254d660e2675</a></p>
<blockquote>
<p>In the above comments it seems they wanted to use a POST, although I guess a cookie could be used with your proposal here?</p>
</blockquote>
<p>Yeah, I'm not sure what the POST thing's for.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/wanderview"></a>
    

<div id="issuecomment-230467881" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="cae6897ab806e3428879a21a46bfcc12">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/wanderview" class="author">wanderview</a> 
    </strong>

    commented

      <a href="#issuecomment-230467881" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-07-05T12:45:34Z">Jul 5, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <blockquote>
<p>Yeah, I'm not sure what the POST thing's for.</p>
</blockquote>
<p>Well, I think <a href="https://github.com/bmaurer" class="user-mention">@bmaurer</a> said they wanted the state token to be managed by the service worker directly.  Right now there is no way to set a cookie in a service worker, although I seem to recall some API was under discussion there.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/jakearchibald"></a>
    

<div id="issuecomment-230468617" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="982a6b3bda76151d3195393f13fe4d99">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/jakearchibald" class="author">jakearchibald</a> 
    </strong>

    commented

      <a href="#issuecomment-230468617" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-07-05T12:49:10Z">Jul 5, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>It seemed to me that facebook wanted to start getting user content prepared <em>before</em> SW boots up. The credentialed request in my example allows that. If the state token is managed by the SW, then you're back into a position where you have to wait for SW to boot up, which is no different than today.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/wanderview"></a>
    

<div id="issuecomment-230469757" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="f16eff9c494a9abebf8cfad4bf02ce2b">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/wanderview" class="author">wanderview</a> 
    </strong>

    commented

      <a href="#issuecomment-230469757" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-07-05T12:54:21Z">Jul 5, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>Well <a href="https://github.com/bmaurer" class="user-mention">@bmaurer</a> can best clarify what he meant by:</p>
<blockquote>
<p>the header CurState:XYZ where XYZ can be managed by the service worker as its cached state changes</p>
</blockquote>
<p>But I read that as the last time the service worker changed something it would store the new XYZ header in some API that would then go out with the next preload.  So it doesn't have to block the preload, but its still managed by the service worker.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/wanderview"></a>
    

<div id="issuecomment-230470152" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="2d16ae3318b08ee82c4ad44d8aac85f7">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/wanderview" class="author">wanderview</a> 
    </strong>

    commented

      <a href="#issuecomment-230470152" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-07-05T12:56:04Z">Jul 5, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>I guess if the routes are mutable, then the SW could update the routes with the new header info.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  
      <div class="discussion-item discussion-item-ref">
    <div class="discussion-item-header" id="ref-issue-141082449">
      <span class="discussion-item-icon">
        <svg aria-hidden="true" class="octicon octicon-bookmark" height="16" version="1.1" viewBox="0 0 10 16" width="10"><path fill-rule="evenodd" d="M9 0H1C.27 0 0 .27 0 1v15l5-3.09L10 16V1c0-.73-.27-1-1-1zm-.78 4.25L6.36 5.61l.72 2.16c.06.22-.02.28-.2.17L5 6.6 3.12 7.94c-.19.11-.25.05-.2-.17l.72-2.16-1.86-1.36c-.17-.16-.14-.23.09-.23l2.3-.03.7-2.16h.25l.7 2.16 2.3.03c.23 0 .27.08.09.23h.01z"></path></svg>
      </span>

      
      <a href="/jakearchibald" class="author" truncate="true">jakearchibald</a>
      

      referenced
      this issue
      <a class="timestamp" href="#ref-issue-141082449">
        <relative-time datetime="2016-07-09T15:42:23Z">Jul 9, 2016</relative-time>
      </a>
    </div>

      <span class="state state-open float-right">
          <svg aria-hidden="true" class="octicon octicon-issue-opened" height="14" version="1.1" viewBox="0 0 14 16" width="12"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg>
        Open
      </span>



    <h4 class="discussion-item-ref-title">
      <a href="/w3c/ServiceWorker/issues/846" class="title-link">
        DOMParser within ServiceWorkers
        <span class="issue-num">#846</span>
</a>    </h4>
    
  </div>


  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/slightlyoff"></a>
    

<div id="issuecomment-233401660" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="ab0a72137ccaad1bb6a4156eaabe8ee9">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/slightlyoff" class="author">slightlyoff</a> 
    </strong>

    commented

      <a href="#issuecomment-233401660" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-07-18T17:40:00Z">Jul 18, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>Sorry for the slow response, have been on holiday. Thanks <a href="https://github.com/jakearchibald" class="user-mention">@jakearchibald</a> for capturing (accurately) our pub conversation.</p>
<p>My largest concern about the declarative proposal here is that it's a high-level, open-ended design space which is something we've decided in the past not to attack without lots of evidence of need. At some level, I think these proposals are compatible. You can imagine the high-level thing being implemented in terms of the low-level sketch I outlined without much difficulty.</p>
<p>While I accept the critique that this may be scenario solving to some degree, we've had multiple customers ask for something that's effectively this and we know that multi-process browsers will be architecturally constrained in ways that make the PlzNavigate decision common.</p>
<p>The alternative that preserves our low-level bias in design is to simply block all navigations that have SWs on them on renderer startup and defeat PlzNavigate (and equivalents). I'm not sure this is tenable, so I'd like to see something small that's low-level in this area while we design the high-level route system.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/annevk"></a>
    

<div id="issuecomment-233574613" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="43a00630ee3baf60af0a535d3f57a59e">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      text-bold
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user is a member of the World Wide Web Consortium organization.
      ">
      Member
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/annevk" class="author">annevk</a> 
    </strong>

    commented

      <a href="#issuecomment-233574613" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-07-19T09:11:06Z">Jul 19, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>I think the main problem with your sketch is that it's not opt-in and uses confusing terminology. I think by default a service worker should remain in control of all networking activity. It can relinquish some of that control back to the browser, but that should be opt-in. The terminology should make it clearer that this affects navigation only (only top-level presumably?).</p>
<p>Even then, I'd still like to hear from Apple, Microsoft, and Mozilla's e10s team what their thoughts are on this (and also Servo). Would love to have some insight as to how much this relates to Chrome architecture decisions vs overall browser architecture.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions has-reactions js-reactions-container ">
    <!-- '"` --><!-- </textarea></xmp> --><form accept-charset="UTF-8" action="/w3c/ServiceWorker/reactions/update" class="js-pick-reaction" data-form-nonce="9a0bc17f76f8d6da455f8f22f97c74fd59cdd74c" data-remote="true" data-type="json" method="post"><div style="margin:0;padding:0;display:inline"><input name="utf8" type="hidden" value="âœ“"><input name="_method" type="hidden" value="put"><input name="authenticity_token" type="hidden" value="pdkN9BfjZl65WHUr6Fb0fLItd8gHbMCIkcgbTP2b/08TXTFDFNkNpnLSNAX66R+/7iuc2COJazCz6PbdOa5AMw=="></div>
      <input type="hidden" name="reaction[subject_id]" value="233574613">
      <input type="hidden" name="reaction[subject_type]" value="IssueComment">
      <div class="comment-reactions-options">
          <button disabled="" class="btn-link reaction-summary-item tooltipped tooltipped-se tooltipped-multiline " name="reaction[content]" type="submit" value="+1 react" aria-label="delapuente reacted with thumbs up emoji">
            <g-emoji alias="+1" class="emoji mr-1" fallback-src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f44d.png" ios-version="6.0">ðŸ‘</g-emoji>
            1
          </button>
      </div>
</form></div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/jakearchibald"></a>
    

<div id="issuecomment-233603440" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="002a1188a6249093afe0bf516b0bb3ce">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/jakearchibald" class="author">jakearchibald</a> 
    </strong>

    commented

      <a href="#issuecomment-233603440" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-07-19T11:21:05Z">Jul 19, 2016</relative-time></a>

      â€¢
      <span class="timestamp timestamp-edited tooltipped tooltipped-n" aria-label="jakearchibald edited this comment 5 months ago">
        edited
      </span>
  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p><a href="https://github.com/slightlyoff" class="user-mention">@slightlyoff</a></p>
<blockquote>
<p>My largest concern about the declarative proposal here is that it's a high-level, open-ended design space which is something we've decided in the past not to attack without lots of evidence of need</p>
</blockquote>
<p>Both proposals are declarative. With your proposal you're declaring that an additional request should happen along with navigations, and it should have particular headers.</p>
<blockquote>
<p>While I accept the critique that this may be scenario solving to some degree</p>
</blockquote>
<p>It's trying to scenario-solve, but it's missing the mark. You're creating a preflight for the navigation request, but you're already hacking it to return different data.</p>
<p>I agree with <a href="https://github.com/annevk" class="user-mention">@annevk</a> that I'd like to hear more from other vendors on this, but if we're going to continue to throw around ideas we can't forget about the problems actually being presented:</p>
<p><strong>The way things are today:</strong></p>
<p>Without SW:</p>
<ol>
<li>Navigation request made - Facebook may return a generic response, but can start preparing user-specific parts</li>
<li>Wait for renderer &amp; response</li>
<li>Page starts fetching user-specific bits</li>
</ol>
<p>With SW:</p>
<ol>
<li>Wait for renderer &amp; service worker</li>
<li>Fire fetch event for navigation, return cached response, but also ping Facebook so it can start preparing user-specific parts</li>
<li>Page starts fetching user-specific bits</li>
</ol>
<p>If I'm reading <a href="https://github.com/bmaurer" class="user-mention">@bmaurer</a> correctly (correct me if the above lists are wrong), the problems are:</p>
<ul>
<li>SW startup adds significant delay to a cached response</li>
<li>SW startup (and therefore renderer startup) adds significant delay to the Facebook ping</li>
</ul>
<p>I don't think we should try and solve these with one function call. There's two parts there, avoiding SW startup for handling responses, and providing some kind of declarative preload (maybe multiple, maybe not to the same URL).</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  
      <div class="discussion-item discussion-item-ref">
    <div class="discussion-item-header" id="ref-issue-166364457">
      <span class="discussion-item-icon">
        <svg aria-hidden="true" class="octicon octicon-bookmark" height="16" version="1.1" viewBox="0 0 10 16" width="10"><path fill-rule="evenodd" d="M9 0H1C.27 0 0 .27 0 1v15l5-3.09L10 16V1c0-.73-.27-1-1-1zm-.78 4.25L6.36 5.61l.72 2.16c.06.22-.02.28-.2.17L5 6.6 3.12 7.94c-.19.11-.25.05-.2-.17l.72-2.16-1.86-1.36c-.17-.16-.14-.23.09-.23l2.3-.03.7-2.16h.25l.7 2.16 2.3.03c.23 0 .27.08.09.23h.01z"></path></svg>
      </span>

      
      <a href="/jakearchibald" class="author" truncate="true">jakearchibald</a>
      

      referenced
      this issue
      <a class="timestamp" href="#ref-issue-166364457">
        <relative-time datetime="2016-07-19T15:41:38Z">Jul 19, 2016</relative-time>
      </a>
    </div>

      <span class="state state-closed float-right">
          <svg aria-hidden="true" class="octicon octicon-issue-opened" height="14" version="1.1" viewBox="0 0 14 16" width="12"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg>
        Closed
      </span>



    <h4 class="discussion-item-ref-title">
      <a href="/w3c/ServiceWorker/issues/932" class="title-link">
        Create F2F agenda - 28-29 July 2016
        <span class="issue-num">#932</span>
</a>    </h4>
    
  </div>


  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/asutherland"></a>
    

<div id="issuecomment-233796070" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="c3d5f657c4a846523a528060a46a1dc3">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>



  <div class="timeline-comment-header-text">

    <strong>
      <a href="/asutherland" class="author">asutherland</a> 
    </strong>

    commented

      <a href="#issuecomment-233796070" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-07-19T23:23:44Z">Jul 20, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>Speaking as a Mozilla SW dev focused on <a href="https://github.com/bmaurer" class="user-mention">@bmaurer</a>'s use case (and with less wisdom than <a href="https://github.com/wanderview" class="user-mention">@wanderview</a>), what if we hang a "session priming request" off the ServiceWorker registration?</p>
<p>General operation:</p>
<ul>
<li>The ServiceWorker is able to set and update a <em>small</em> request off its registration that it can freely update with best-effort persistence but no transaction semantics or durability guarantees.</li>
<li>When a navigate request is triggered it necessarily gets run by your ServiceWorker registry to determine whether to intercept or not.  If it matches, meaning it will be controlled by the ServiceWorker:
<ul>
<li>If there is no suppression timer, the session priming request is triggered as a "no-store" request, helping establish a network connection and delivering the needed cookie-ish identifier to the server so it can start doing database loads and whatever processing is needed in parallel with the browser's SW load.  This starts a session clock suppression timer so every navigation request doesn't generate wasteful spam.  Timer interval can be specified by the SW to best match the server backend with some sanity clamps by the browser, and/or dependent on the lifetime of the HTTP/2 connection.</li>
<li>The ServiceWorker is spun up like usual.</li>
</ul>
</li>
<li>If the server has data it knows the ServiceWorker will want, it uses HTTP/2 Server Push to push the data into the network cache.  The SW can fish the data out of there and it's the cache's problem to unify races between the SW requesting something and the server pushing it.  The SW does not need to be aware of special types of requests like preflight requests.</li>
</ul>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/jakearchibald"></a>
    

<div id="issuecomment-233863954" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="6ce6b5d96eaf0e969d3574b482f644e8">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/jakearchibald" class="author">jakearchibald</a> 
    </strong>

    commented

      <a href="#issuecomment-233863954" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-07-20T07:23:51Z">Jul 20, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>Again I think this is scenario-solving to the extreme. I'd rather look at solutions that solve this issue for Facebook, but maybe some other sites too.</p>
<p>We already have <code>&lt;link rel="preload"&gt;</code> for preloading and we should lean on its semantics as much as possible. The missing part is a way to assign preloads to a navigation request before spinning up the service worker.</p>
<p><code>&lt;link rel="preload"&gt;</code> already needs to define the life of its cache &amp; how requests are matched to it, so I don't see why we should reinvent that.</p>
<p>The preloaded URL may be the same across every navigation on Facebook's origin, but I don't think that will be generally true.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/jakearchibald"></a>
    

<div id="issuecomment-233913390" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="89da0f41330f87b42e37e76bc58e9301">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/jakearchibald" class="author">jakearchibald</a> 
    </strong>

    commented

      <a href="#issuecomment-233913390" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-07-20T10:33:41Z">Jul 20, 2016</relative-time></a>

      â€¢
      <span class="timestamp timestamp-edited tooltipped tooltipped-n" aria-label="jakearchibald edited this comment 5 months ago">
        edited
      </span>
  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>Here's a little menu of features. To those building sites: of the following, <strong>which is the minimum that solves the problems you have? Which features are more than you'll ever need?</strong></p>
<ol>
<li>When the user navigates to my site I want to ping a URL with some sort of credential. I'm happy for the actual navigation request to go through the service worker and therefore be delayed by it starting up, but the ping should not depend on SW startup.
<ol>
<li>I don't care about the response of the ping</li>
<li>I want to handle the response of the ping, but I don't intend to use it in response to a fetch event within the next few seconds</li>
<li>I want to handle the response of the ping, and I'm likely to use it in response to a fetch event in the next few seconds</li>
</ol>
</li>
<li>When the user navigates to my site, I want a network request for the navigation to race SW startup &amp; response. If the SW manages to win, at least the network request served as a ping.</li>
<li>When the user navigates to my site I want to perform a series of network preloads while the SW is starting up
<ol>
<li>I want those preloads to bypass the service worker completely</li>
<li>I want the request to bypass the SW, but I want the SW to process the response</li>
<li>I want one of the above depending on the URL</li>
</ol>
</li>
<li>For particular requests (depending on URL, type, &amp; headers), I want to declare the behaviour (serve from cache, serve from network) up front so the browser can handle particular requests/responses without starting the SW</li>
</ol>
<p>Additionally, should 1 &amp; 2 happen for all navigations, or just initial launches?</p>
<p>+<a href="https://github.com/bmaurer" class="user-mention">@bmaurer</a> <a href="https://github.com/n8schloss" class="user-mention">@n8schloss</a></p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/asutherland"></a>
    

<div id="issuecomment-233990732" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="cbc35a7dc6491b2646c868d880c2be59">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>



  <div class="timeline-comment-header-text">

    <strong>
      <a href="/asutherland" class="author">asutherland</a> 
    </strong>

    commented

      <a href="#issuecomment-233990732" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-07-20T15:44:55Z">Jul 20, 2016</relative-time></a>

      â€¢
      <span class="timestamp timestamp-edited tooltipped tooltipped-n" aria-label="asutherland edited this comment 5 months ago">
        edited
      </span>
  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>Declarative routing is definitely more broadly useful.</p>
<p>From an implementation perspective, if we're talking about minimizing latency so that a site can know ASAP when a session is starting for its app shell (and to help the site avoid going crazy with push notifications and background syncs to mitigate the latency and avoid Flash Of Stale Content on startup)[1], then from Firefox's perspective AIUI, we want to hang the info about the request off the registration.</p>
<p>This is because we currently always have the registration around and can probably keep it that way at least on an a top/recent basis for small requests.  Anything more than that currently involves us opening per-origin data which means doing a non-trivial amount of I/O that is either explicitly or implicitly serialized behind other I/O.  We ask our quota manager to open the origin's directory, we open API specific SQLite databases for each origin, etc.</p>
<p>If we had declarative routing, we could probably just extract this information up out of the routes as an optimization.  And I do believe it could respond faster in many other more generic cases than we could spin up a service worker and load its routing polyfill; just not as fast as a specialized thing hung off the registration.  My main concern about the declarative routing is that it seems like a huge chunk of API surface that it's premature to standardize right now, and unrealistic to expect Firefox at least to get to in the short/medium-term based on our focus on non-polyfill-able APIs and our multiprocess priorities.</p>
<p>I think we could get to a more targeted mechanism hung off the registration sooner, but it's definitely possible as what amounts to a short-term hack it's not worth it and we should wait for declarative routing.</p>
<p>Re: <code>&lt;link rel="preload"&gt;</code>, I'm not sure how much of its semantics are applicable to the app shell session priming startup case.  It's explicitly about having an existing document context and that seems deeply baked in, but maybe I'm looking at the wrong thing? (<a href="http://w3c.github.io/preload/">http://w3c.github.io/preload/</a>).  Otherwise, I do agree it makes sense to try and leverage existing semantics specified by existing specs.</p>
<p>1: And I do think this is a very important use-case.  I previously worked on Firefox OS apps, primarily email.  Despite our offline/client-side bias, the name of the game was always minimizing the time to useful content.  Since anything the server does is inherently parallel, it's a major win to notify the server before blocking on local device I/O which can exhibit variability from contention.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/jakearchibald"></a>
    

<div id="issuecomment-234001197" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="cdb6434e424f3e357aa204a00ab3ddc4">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/jakearchibald" class="author">jakearchibald</a> 
    </strong>

    commented

      <a href="#issuecomment-234001197" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-07-20T16:20:20Z">Jul 20, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p><a href="https://github.com/asutherland" class="user-mention">@asutherland</a> it seems to me that all these things (declarative routing or a preflight) would be hung off a service worker rather than the registration. As in if V1 sets these things, but V2 doesn't, they're gone. That's closest to how the fetch event works today.</p>
<blockquote>
<p>I think we could get to a more targeted mechanism hung off the registration sooner, but it's definitely possible as what amounts to a short-term hack it's not worth it and we should wait for declarative routing</p>
</blockquote>
<p>That's what I'm aiming to discover through my previous comment. I'm not against a focused API, but I don't want to end up creating a <code>doThatThingForFacebook()</code> API that means we later need to ship a subtly different <code>doThatThingForTwitter()</code> API.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/n8schloss"></a>
    

<div id="issuecomment-234150565" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="01629d9de75219795f8136c0b172a242">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>



  <div class="timeline-comment-header-text">

    <strong>
      <a href="/n8schloss" class="author">n8schloss</a> 
    </strong>

    commented

      <a href="#issuecomment-234150565" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-07-21T03:57:33Z">Jul 21, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>So to respond to <a href="https://github.com/jakearchibald" class="user-mention">@jakearchibald</a>'s comment above.</p>
<blockquote>
<p>When the user navigates to my site I want to ping a URL with some sort of credential. I'm happy for the actual navigation request to go through the service worker and therefore be delayed by it starting up, but the ping should not depend on SW startup.</p>
</blockquote>
<p>I'm not sure what you mean by ping, do you mean hit a url and be able to access it's response from the SW or something else?</p>
<p>In our use case and I suspect many others we're going to be caching most of the page shell and responses from our servers to service workers will return structured data. For Facebook if we measure the time that it takes to show newsfeed a lot of this time is blocked by fetching the data on our backend, and if we look at how long it takes to start service workers then the delay introduced by having them on the critical path introduces an overall regression. This kind of API is the best solution for this problem imo, the service worker stays in charge and still can construct responses, but hitting the backend isn't blocked on the service worker starting. I suspect that for most sites this will be a common use case, you'll want to cache most of your site but you still want to have content as fresh as possiable as quickly as possiable.</p>
<p>I think it's also okay for preflightRequest to be optionally there or not, this way if the SW is indeed started and it wants to add extra data to headers or make a request to a different endpoint all together it can. But if the SW is not started it only get's to add headers (and maybe change some other fetch options).</p>
<blockquote>
<p>When the user navigates to my site, I want a network request for the navigation to race SW startup &amp; response. If the SW manages to win, at least the network request served as a ping.</p>
</blockquote>
<p>Nope, we ultimately want to reply with just the newsfeed content as structured data. We want the SW to be able to get this and then turn it into the webpage. We always want the service worker on the critical path in this case.</p>
<blockquote>
<p>When the user navigates to my site I want to perform a series of network preloads while the SW is starting up</p>
</blockquote>
<p>So right now we'd just want to do one preload before the sw starts and then be able to access its response in the fetch event.</p>
<blockquote>
<p>For particular requests (depending on URL, type, &amp; headers), I want to declare the behaviour (serve from cache, serve from network) up front so the browser can handle particular requests/responses without starting the SW</p>
</blockquote>
<p>Nope, at least right now we're never going to respond just from cache and will always have a hybrid kind of approach where the service worker constructs a response from both cache and network.</p>
<p>I could see that others might find this useful though and I bet that down the line this would be useful for us as well, but this kind of declarative routing could also totally work with preflight request and it also doesn't solve the same issue that preflight request solves.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/jakearchibald"></a>
    

<div id="issuecomment-234314673" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="4e11634c94d07d620c03e034c82fbc08">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/jakearchibald" class="author">jakearchibald</a> 
    </strong>

    commented

      <a href="#issuecomment-234314673" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-07-21T16:52:11Z">Jul 21, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p><a href="https://github.com/n8schloss" class="user-mention">@n8schloss</a> given you use chunked-encoding currently, how important is a streaming render to you (in terms of the streaming HTML parser)?</p>
<p>If you're downloading content client side then displaying it, you generally have to download it all before displaying any of it. Is this a problem?</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/jakearchibald"></a>
    

<div id="issuecomment-234622616" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="224981b852a96b2f182a4ae41bdaeb84">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/jakearchibald" class="author">jakearchibald</a> 
    </strong>

    commented

      <a href="#issuecomment-234622616" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-07-22T18:37:57Z">Jul 22, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>I had a chat with <a href="https://github.com/n8schloss" class="user-mention">@n8schloss</a> &amp; co and have a much better handle on the problem.</p>
<p>Their fetch event does something equivalent to this:</p>
<ol>
<li>Request page header from cache</li>
<li>Request data from server</li>
<li>Create readable stream &amp; respond with it</li>
<li>Pipe in the header</li>
<li>Pipe in the data once it arrives</li>
</ol>
<p>All my assumptions were based on the simpler shell model where the shell loads then it sets about getting data, which isn't the case here (also yay streams!).</p>
<p>My idea around reusing <code>&lt;link rel="preload"&gt;</code> semantics but allowing the request to start before the document <em>does not work</em>, since the preload cache is per document and this request is being used entirely in the service worker.</p>
<p>Making the preload available along with the navigation request works here, since it's being piped into the navigation response. However, this doesn't really work with the simpler shell model, where you're left with a response that you don't need yet. Best you can do is throw it into the global scope and hope for the best.</p>
<p>They also want to be able to set headers on the preload request outside of the SW lifecycle (such as "last post received timestamp", so setting it via the activate/install event is not the solution. Cookies aren't the prefered way of doing this, since there's no cookies API in SW, and having that data hit the server for other requests is undesirable.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions has-reactions js-reactions-container ">
    <!-- '"` --><!-- </textarea></xmp> --><form accept-charset="UTF-8" action="/w3c/ServiceWorker/reactions/update" class="js-pick-reaction" data-form-nonce="9a0bc17f76f8d6da455f8f22f97c74fd59cdd74c" data-remote="true" data-type="json" method="post"><div style="margin:0;padding:0;display:inline"><input name="utf8" type="hidden" value="âœ“"><input name="_method" type="hidden" value="put"><input name="authenticity_token" type="hidden" value="Jm+iNOLXbHjGpm8zJ1LjXKVq0sryDXxNBU7j026Bxg6Q656D4e0HgA0sLh017Qif+Ww52tbo1/Unbg5CqrR5cg=="></div>
      <input type="hidden" name="reaction[subject_id]" value="234622616">
      <input type="hidden" name="reaction[subject_type]" value="IssueComment">
      <div class="comment-reactions-options">
          <button disabled="" class="btn-link reaction-summary-item tooltipped tooltipped-se tooltipped-multiline " name="reaction[content]" type="submit" value="+1 react" aria-label="n8schloss reacted with thumbs up emoji">
            <g-emoji alias="+1" class="emoji mr-1" fallback-src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f44d.png" ios-version="6.0">ðŸ‘</g-emoji>
            1
          </button>
      </div>
</form></div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/jakearchibald"></a>
    

<div id="issuecomment-234623343" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="28736c1abcbc6b48e2d44b1904a5cafe">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/jakearchibald" class="author">jakearchibald</a> 
    </strong>

    commented

      <a href="#issuecomment-234623343" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-07-22T18:41:05Z">Jul 22, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>FWIW, there's another very important web site that uses a similar serving pattern and would benefit from this - my blog.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions has-reactions js-reactions-container ">
    <!-- '"` --><!-- </textarea></xmp> --><form accept-charset="UTF-8" action="/w3c/ServiceWorker/reactions/update" class="js-pick-reaction" data-form-nonce="9a0bc17f76f8d6da455f8f22f97c74fd59cdd74c" data-remote="true" data-type="json" method="post"><div style="margin:0;padding:0;display:inline"><input name="utf8" type="hidden" value="âœ“"><input name="_method" type="hidden" value="put"><input name="authenticity_token" type="hidden" value="VMYWzW+G6MbyQdjYDI8y7xbymeOsdbZA7HYQuBIzBHniQip6bLyDPjnLmfYeMNksSvRy84iQHfjOVv0p1ga7BQ=="></div>
      <input type="hidden" name="reaction[subject_id]" value="234623343">
      <input type="hidden" name="reaction[subject_type]" value="IssueComment">
      <div class="comment-reactions-options">
          <button disabled="" class="btn-link reaction-summary-item tooltipped tooltipped-se tooltipped-multiline " name="reaction[content]" type="submit" value="smile react" aria-label="pieterv, n8schloss, slightlyoff, and flaki reacted with laugh emoji">
            <g-emoji alias="smile" class="emoji mr-1" fallback-src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f604.png" ios-version="6.0">ðŸ˜„</g-emoji>
            4
          </button>
      </div>
</form></div>

  </div>

</div>

  </div>
  


      


  <div class="discussion-item discussion-item-milestoned">
    <div class="discussion-item-header" id="event-733469530">

      <span class="discussion-item-icon">
        <svg aria-hidden="true" class="octicon octicon-milestone" height="16" version="1.1" viewBox="0 0 14 16" width="14"><path fill-rule="evenodd" d="M8 2H6V0h2v2zm4 5H2c-.55 0-1-.45-1-1V4c0-.55.45-1 1-1h10l2 2-2 2zM8 4H6v2h2V4zM6 16h2V8H6v8z"></path></svg>
      </span>
      
      <a href="/jakearchibald" class="author">jakearchibald</a>
      
      added this to the <a href="/w3c/ServiceWorker/milestone/3" class="discussion-item-entity" title="by jakearchibald at 2016-07-25 13:46:27">Version 2</a> milestone <a href="#event-733469530" class="timestamp"><relative-time class="timestamp" datetime="2016-07-25T12:46:27Z">Jul 25, 2016</relative-time></a>
    </div>
  </div>



  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/delapuente"></a>
    

<div id="issuecomment-235357063" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="6fa33e8eaea09ead86d735a0dc12dcb5">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>



  <div class="timeline-comment-header-text">

    <strong>
      <a href="/delapuente" class="author">delapuente</a> 
    </strong>

    commented

      <a href="#issuecomment-235357063" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-07-26T18:15:48Z">Jul 26, 2016</relative-time></a>

      â€¢
      <span class="timestamp timestamp-edited tooltipped tooltipped-n" aria-label="delapuente edited this comment 4 months ago">
        edited
      </span>
  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>Aside from Facebook problem. Although <a href="https://github.com/jakearchibald" class="user-mention">@jakearchibald</a> declarative syntax is tempting, I think it is too soon for this. <a href="https://github.com/slightlyoff" class="user-mention">@slightlyoff</a> preflight solution seems to me a very valid options but I really think it should be opt-in so, during registration, a service worker could include a preflight list (<code>networkRace</code>) such as:</p>
<div class="highlight highlight-source-js"><pre><span class="pl-c1">navigator</span>.<span class="pl-smi">serviceWorker</span>.<span class="pl-en">register</span>(<span class="pl-s"><span class="pl-pds">'</span>sw.js<span class="pl-pds">'</span></span>, { scope<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>/<span class="pl-pds">'</span></span>, networkRace<span class="pl-k">:</span> [<span class="pl-s"><span class="pl-pds">'</span>/ping<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>/shell-assets<span class="pl-pds">'</span></span>] });</pre></div>
<p>List items would act as prefixes so any request to <code>/shell-assets/*</code> would be raced with the service worker. About the problem with the 3 GiB video, you could cancel the response in progress (I'm not talking about <em>cancellable</em> promises) by modifying the API:</p>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">self</span>.<span class="pl-en">onfetch</span> <span class="pl-k">=</span> (<span class="pl-smi">e</span>) <span class="pl-k">=&gt;</span> {
  <span class="pl-k">if</span> (<span class="pl-en">isHeavyAsset</span>(<span class="pl-smi">e</span>.<span class="pl-smi">request</span>) <span class="pl-k">&amp;&amp;</span> <span class="pl-smi">e</span>.<span class="pl-smi">networkResponse</span>.<span class="pl-smi">inProgress</span>) {
    <span class="pl-smi">e</span>.<span class="pl-smi">networkResponse</span>.<span class="pl-c1">abort</span>();
    <span class="pl-smi">e</span>.<span class="pl-en">respondWith</span>(<span class="pl-en">handle</span>(<span class="pl-smi">e</span>.<span class="pl-smi">request</span>));
  }
}</pre></div>
<p>If for some race condition, you end sending another request to the network as in:</p>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">self</span>.<span class="pl-en">onfetch</span> <span class="pl-k">=</span> <span class="pl-smi">event</span> <span class="pl-k">=&gt;</span> {
  <span class="pl-c1">event</span>.<span class="pl-en">respondWith</span>(
    <span class="pl-c1">event</span>.<span class="pl-smi">preflightResponse</span> <span class="pl-k">||</span> <span class="pl-en">fetch</span>(<span class="pl-c1">event</span>.<span class="pl-smi">request</span>)
  )
}</pre></div>
<p>The second one will hit the http cache hopefully instead of reaching the actual network.</p>
<p>With the cancellable API the former example would be something like:</p>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">self</span>.<span class="pl-en">onfetch</span> <span class="pl-k">=</span> <span class="pl-smi">event</span> <span class="pl-k">=&gt;</span> {
  <span class="pl-c1">event</span>.<span class="pl-en">respondWith</span>(
    (<span class="pl-k">!</span><span class="pl-c1">event</span>.<span class="pl-smi">networkResponse</span>.<span class="pl-smi">inProgress</span> <span class="pl-k">&amp;&amp;</span> <span class="pl-c1">event</span>.<span class="pl-smi">networkResponse</span>.<span class="pl-smi">response</span>) <span class="pl-k">||</span> <span class="pl-en">fetch</span>(<span class="pl-c1">event</span>.<span class="pl-smi">request</span>)
  )
}</pre></div>
<p>Does it make sense?</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/delapuente"></a>
    

<div id="issuecomment-235358860" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="d354f16e8ee523145c409df1b7778c36">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>



  <div class="timeline-comment-header-text">

    <strong>
      <a href="/delapuente" class="author">delapuente</a> 
    </strong>

    commented

      <a href="#issuecomment-235358860" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-07-26T18:21:46Z">Jul 26, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>Anyway, optimal solution would be to somehow foresee the need of the service worker and reduce the startup penalty. Perhaps a more low level solution for this is a better option.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/jakearchibald"></a>
    

<div id="issuecomment-236251448" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="00149a66b79aee2f9e75f9d585fc615b">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/jakearchibald" class="author">jakearchibald</a> 
    </strong>

    commented

      <a href="#issuecomment-236251448" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-07-29T18:04:37Z">Jul 29, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>F2F:</p>
<ul>
<li>WebKit &amp; MS think the preflight is a good idea</li>
<li>Not keen on the "preflight" naming</li>
<li>We need to name this, but not now</li>
<li>It's for GET navigation</li>
<li>The request the same as <code>event.request</code> plus a dict with an addHeaders property, allowing the setting of headers &amp; the change of mode - but this is tricky when mode is navigate, which it is</li>
<li>It happens for everything in scope</li>
<li>This API should sit on the registration object</li>
<li>It should return a promise, which resolves once the rule is in place, or rejects if the options are invalid (not-allowed headers)</li>
<li>Once the rule is in place, the preflight will always be done, it's not optional from the browser's point of view, for consistency it should be done for every GET navigate</li>
<li>We can add url prefix in later</li>
<li>concurrentFetch?</li>
</ul>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions has-reactions js-reactions-container ">
    <!-- '"` --><!-- </textarea></xmp> --><form accept-charset="UTF-8" action="/w3c/ServiceWorker/reactions/update" class="js-pick-reaction" data-form-nonce="9a0bc17f76f8d6da455f8f22f97c74fd59cdd74c" data-remote="true" data-type="json" method="post"><div style="margin:0;padding:0;display:inline"><input name="utf8" type="hidden" value="âœ“"><input name="_method" type="hidden" value="put"><input name="authenticity_token" type="hidden" value="ct2GKNR4s8feJ9aR9Ld2f96fw0JXmEWh+ojcGuqXJM/EWbqf10LYPxWtl7/mCJ28gpkoUnN97hnYqDGLLqKbsw=="></div>
      <input type="hidden" name="reaction[subject_id]" value="236251448">
      <input type="hidden" name="reaction[subject_type]" value="IssueComment">
      <div class="comment-reactions-options">
          <button disabled="" class="btn-link reaction-summary-item tooltipped tooltipped-se tooltipped-multiline " name="reaction[content]" type="submit" value="+1 react" aria-label="pieterv reacted with thumbs up emoji">
            <g-emoji alias="+1" class="emoji mr-1" fallback-src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f44d.png" ios-version="6.0">ðŸ‘</g-emoji>
            1
          </button>
      </div>
</form></div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/annevk"></a>
    

<div id="issuecomment-236413299" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="bd346fb974645c1f04100fb58d32b53b">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      text-bold
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user is a member of the World Wide Web Consortium organization.
      ">
      Member
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/annevk" class="author">annevk</a> 
    </strong>

    commented

      <a href="#issuecomment-236413299" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-07-31T06:09:44Z">Jul 31, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>Isnâ€™t each GET bavigate going to be wasteful and encourage a more complicated pushState() navigation scheme for subsequent navigations? (Which would be problematic if we ever manage to tie other things to navigation, such as animations, apart from making sites more complicated.)</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/bmaurer"></a>
    

<div id="issuecomment-236449040" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="135bb08aabe5854beda61be87aaccfbe">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>



  <div class="timeline-comment-header-text">

    <strong>
      <a href="/bmaurer" class="author">bmaurer</a> 
    </strong>

    commented

      <a href="#issuecomment-236449040" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-07-31T18:43:32Z">Jul 31, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <blockquote>
<p>Isnâ€™t each GET bavigate going to be wasteful and encourage a more complicated pushState() navigation scheme for subsequent navigations? (Which would be problematic if we ever manage to tie other things to navigation, such as animations, apart from making sites more complicated.)</p>
</blockquote>
<p>Realistically I think a complex application will still end up using pushState rather than doing fresh navigations on each page view. Keep in mind that the use case here is on URLs where getting the lastest server-side data is critical for the page to be "done", ie a news feed or other page that is expected to show real time information.</p>
<p>Even if you take out network latency there's a substantial price to be paid in terms of initializing client side JS (installing a bunch of prototype objects, etc). Apps may have features that cross page navigation (eg on Facebook chat tabs) where a fresh page view could be a disruptive experience (imagine you're half way through typing a message).</p>
<p>One thing that could mitigate this issue is to allow for a TTL for pre-flight requests -- if the page is in browser history and less than X seconds old not to issue a pre-flight.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/jakearchibald"></a>
    

<div id="issuecomment-236456885" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="73e4586215afab063c3c0096aa340a15">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/jakearchibald" class="author">jakearchibald</a> 
    </strong>

    commented

      <a href="#issuecomment-236456885" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-07-31T21:11:00Z">Jul 31, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p><a href="https://github.com/annevk" class="user-mention">@annevk</a></p>
<blockquote>
<p>Isnâ€™t each GET bavigate going to be wasteful and encourage a more complicated pushState() navigation scheme for subsequent navigations?</p>
</blockquote>
<p>This feature will be opt-in, and includes the setting of some headers. A well built server could return an empty response for the preflight. Sure it's more wasteful than nothing, but it isn't much. I think there's potential for browser optimisation here too. If the concurrent fetch's response body isn't read by the time <code>respondWith</code> &amp; <code>waitUntil</code> resolves, the browser can cancel it.</p>
<p><a href="https://github.com/bmaurer" class="user-mention">@bmaurer</a></p>
<blockquote>
<p>Realistically I think a complex application will still end up using pushState rather than doing fresh navigations on each page view</p>
</blockquote>
<p>I hope we can tackle this at some point. I hear developers going down this route because they want transitions, but it seems a shame that they have to reimplement the whole navigation state thing for that. At some point I hope we can look at navigation transitions again.</p>
<p>I know it isn't a complex app, but I wouldn't go <code>pushState</code> on my blog, but I would use this concurrent fetch feature. With <code>pushState</code> I'd lose all the performance I get through progressive rendering - although we could fix that by exposing the streaming parser to pages.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/bmaurer"></a>
    

<div id="issuecomment-236473726" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="e677bb2279f179f3ee712003268b2291">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>



  <div class="timeline-comment-header-text">

    <strong>
      <a href="/bmaurer" class="author">bmaurer</a> 
    </strong>

    commented

      <a href="#issuecomment-236473726" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-08-01T02:04:09Z">Aug 1, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <blockquote>
<p>I know it isn't a complex app, but I wouldn't go pushState on my blog, but I would use this concurrent fetch feature. With pushState I'd lose all the performance I get through progressive rendering - although we could fix that by exposing the streaming parser to pages.</p>
</blockquote>
<p>Maybe you could solve this by making the pre-flight request a cacheable resource. That way if the user has visited that specific page on your blog within a timeframe you define the request would never hit your server.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/jakearchibald"></a>
    

<div id="issuecomment-236530398" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="ff0cbf3d0ad6c2bb92a76793a436b603">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/jakearchibald" class="author">jakearchibald</a> 
    </strong>

    commented

      <a href="#issuecomment-236530398" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-08-01T09:18:25Z">Aug 1, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>I think I may already be doing that. But I'm not really worried about the cost of the preflight, since it's less than the cost of a regular navigation.</p>
<p>If I've cached a given article, I guess I could set a cookie with the last-modified time, so the server could shortcut the response. The cookie is better than the header in this case as it can be scoped to a particular article. Ideally last-modified would do the trick, but I guess it's possible for the resource to be in the cache API but not the HTTP cache.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/wanderview"></a>
    

<div id="issuecomment-236657009" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="5ee794fef6464bac5aac431f1022ce47">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/wanderview" class="author">wanderview</a> 
    </strong>

    commented

      <a href="#issuecomment-236657009" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-08-01T17:58:20Z">Aug 1, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>Gecko bug: <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1290958">https://bugzilla.mozilla.org/show_bug.cgi?id=1290958</a></p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  
  <div class="discussion-item discussion-item-ref">
    <div class="discussion-item-header">
      <span class="discussion-item-icon">
        <svg aria-hidden="true" class="octicon octicon-bookmark" height="16" version="1.1" viewBox="0 0 10 16" width="10"><path fill-rule="evenodd" d="M9 0H1C.27 0 0 .27 0 1v15l5-3.09L10 16V1c0-.73-.27-1-1-1zm-.78 4.25L6.36 5.61l.72 2.16c.06.22-.02.28-.2.17L5 6.6 3.12 7.94c-.19.11-.25.05-.2-.17l.72-2.16-1.86-1.36c-.17-.16-.14-.23.09-.23l2.3-.03.7-2.16h.25l.7 2.16 2.3.03c.23 0 .27.08.09.23h.01z"></path></svg>
      </span>
      This was referenced <relative-time datetime="2016-08-12T18:06:07Z">Aug 12, 2016</relative-time>
    </div>


      <div class="discussion-item-rollup-ref">
          <span class="state state-closed float-right">
                <svg aria-hidden="true" class="octicon octicon-issue-closed" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M7 10h2v2H7v-2zm2-6H7v5h2V4zm1.5 1.5l-1 1L12 9l4-4.5-1-1L12 7l-1.5-1.5zM8 13.7A5.71 5.71 0 0 1 2.3 8c0-3.14 2.56-5.7 5.7-5.7 1.83 0 3.45.88 4.5 2.2l.92-.92A6.947 6.947 0 0 0 8 1C4.14 1 1 4.14 1 8s3.14 7 7 7 7-3.14 7-7l-1.52 1.52c-.66 2.41-2.86 4.19-5.48 4.19v-.01z"></path></svg>
            Closed
          </span>



        <div class="discussion-item-header" id="ref-issue-170511708">
          <h4 class="discussion-item-ref-title">
            <a href="/w3c/ServiceWorker/issues/949" class="title-link">
              Declarative url filters in `fetch` event

              <span class="issue-num">
                #949
              </span>
</a>          </h4>
        </div>
      </div>

      <div class="discussion-item-rollup-ref">
          <span class="state state-open float-right">
                <svg aria-hidden="true" class="octicon octicon-issue-opened" height="16" version="1.1" viewBox="0 0 14 16" width="14"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg>
            Open
          </span>



        <div class="discussion-item-header" id="ref-issue-171707903">
          <h4 class="discussion-item-ref-title">
            <a href="/w3c/ServiceWorker/issues/959" class="title-link">
              Handling race conditions - API for accessing pending requests?

              <span class="issue-num">
                #959
              </span>
</a>          </h4>
        </div>
      </div>

  </div>

  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/ykahlon"></a>
    

<div id="issuecomment-241119245" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="f4332ef23f69c62a55641ebcca8286cc">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>



  <div class="timeline-comment-header-text">

    <strong>
      <a href="/ykahlon" class="author">ykahlon</a> 
    </strong>

    commented

      <a href="#issuecomment-241119245" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-08-19T19:56:45Z">Aug 19, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>Google Docs is experimenting with service workers and we noticed that in the 95th percentile there is a regression of ~400ms and most of it is related to starting the SW.</p>
<p>This solution will completely eliminate the problem for us.</p>
<p>We actually need a simpler solution, we would like the SW to make the preflight request and only if the SW decides to make the exact same request, it will be handed to the SW (the SW doesn't need to know whether it was a preflight request).</p>
<p>If the SW does not make the request, the request that was made to the server will be ignored.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/NekR"></a>
    

<div id="issuecomment-241124015" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="5fa6c76482f7d50cecd6cfd3b9e1055c">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>



  <div class="timeline-comment-header-text">

    <strong>
      <a href="/NekR" class="author">NekR</a> 
    </strong>

    commented

      <a href="#issuecomment-241124015" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-08-19T20:18:17Z">Aug 19, 2016</relative-time></a>

      â€¢
      <span class="timestamp timestamp-edited tooltipped tooltipped-n" aria-label="NekR edited this comment 4 months ago">
        edited
      </span>
  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p><a href="https://github.com/ykahlon" class="user-mention">@ykahlon</a> Well, I'm thinking about <code>self.requests</code> API which could potentially solve this problem too: <a href="https://github.com/w3c/ServiceWorker/issues/959#issuecomment-241121154" class="issue-link js-issue-link" data-url="https://github.com/w3c/ServiceWorker/issues/959" data-id="171707903" data-error-text="Failed to load issue title" data-permission-text="Issue title is private">#959 (comment)</a></p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/NekR"></a>
    

<div id="issuecomment-241153009" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="73c8d00978703f95621e8ec738ee1e53">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>



  <div class="timeline-comment-header-text">

    <strong>
      <a href="/NekR" class="author">NekR</a> 
    </strong>

    commented

      <a href="#issuecomment-241153009" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-08-19T22:41:31Z">Aug 19, 2016</relative-time></a>

      â€¢
      <span class="timestamp timestamp-edited tooltipped tooltipped-n" aria-label="NekR edited this comment 4 months ago">
        edited
      </span>
  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p><em>(My kind-of a proposal for this case, a bit rethinked/reworked)</em></p>
<h2>The <code>requests</code></h2>
<p>This API is supposed to solve this issue and the race issue for <code>link=preload</code> <a href="https://github.com/w3c/ServiceWorker/issues/959" class="issue-link js-issue-link" data-url="https://github.com/w3c/ServiceWorker/issues/959" data-id="171707903" data-error-text="Failed to load issue title" data-permission-text="Issue title is private">#959</a></p>
<h3>Preflight</h3>
<p>First, here are some scetches of the <em>"pre-flight opt-in"</em> which are based on what was writting here and decided on F2F meeting:</p>
<h5>Registration, preflight is opt-in</h5>
<p>Each preflight request will have <code>Service-Worker-Preflight: something</code> header.</p>
<div class="highlight highlight-source-js"><pre><span class="pl-c1">navigator</span>.<span class="pl-smi">serviceWorker</span>.<span class="pl-en">register</span>(<span class="pl-s"><span class="pl-pds">'</span>/sw.js<span class="pl-pds">'</span></span>, {
  preflight<span class="pl-k">:</span> {
    <span class="pl-c">// Preflight interval. Is it really needed?</span>
    <span class="pl-c">// There was some mentions that HTTP cached would solve this.</span>
    <span class="pl-c">// Will `Vary: Service-Worker-Preflight` on response work fine here? CDN?</span>
    ttl<span class="pl-k">:</span> <span class="pl-c1">1000</span> <span class="pl-k">*</span> <span class="pl-c1">60</span>
  }
});</pre></div>
<h5>Pre-flight data</h5>
<div class="highlight highlight-source-js"><pre><span class="pl-c">// Naming not final of course</span>
<span class="pl-smi">self</span>.<span class="pl-smi">registration</span>.<span class="pl-en">setPreflightProperties</span>([
  headers<span class="pl-k">:</span> {
    <span class="pl-s"><span class="pl-pds">'</span>X-Status<span class="pl-pds">'</span></span><span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>Y<span class="pl-pds">'</span></span>
  }
]).<span class="pl-en">then</span>(() <span class="pl-k">=&gt;</span> {
  <span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-s"><span class="pl-pds">'</span>Done<span class="pl-pds">'</span></span>);
});</pre></div>
<p>This is what is related to preflight, following API is for general use cases which may solve Facebook/Google Docs issue with ServiceWorker.</p>
<h3>API</h3>
<p>(<em>in TypeScript format, not spec format</em>)</p>
<div class="highlight highlight-source-ts"><pre><span class="pl-k">interface</span> <span class="pl-en">RequestsStorage</span> {
  match(<span class="pl-v">Request</span> | <span class="pl-v">string</span>)<span class="pl-k">:</span> <span class="pl-en">Promise</span>&lt;<span class="pl-en">Response</span>&gt;;
  putUntil(<span class="pl-v">Request</span> | <span class="pl-v">string</span>, <span class="pl-v">Promise</span>&lt;<span class="pl-v">Response</span>&gt;)<span class="pl-k">:</span> <span class="pl-c1">void</span>;
}

<span class="pl-k">interface</span> <span class="pl-en">ServiceWorkerGlobalScope</span> {
    <span class="pl-k">readonly</span> requests<span class="pl-k">:</span> <span class="pl-en">RequestsStorage</span>;
}</pre></div>
<ul>
<li><code>RequestsStorage#putUntil</code>: Puts a request to the storage until <code>Promise&lt;Response&gt;</code> settled.<br>
<em>For the case of preflight, UA need to hold the request in the store until <code>fetch</code> event ends</em></li>
<li><code>RequestsStorage#match</code>: Macthes passed request agains stored ones. Requests should be differentiated by <code>Service-Worker-Preflight</code> header too. If there is no matching request in the store, then probably the promise should be rejected. For the simplicity, in the following example promise is fullfiled with an empty response when there is no macthing requests.</li>
</ul>
<h3>Example</h3>
<p>The website. It wants to preflight requests and wants to handle them differently based on the requested page. It also sends <code>Link</code> preload headers for some pages.</p>
<p>Example: <a href="https://gist.github.com/NekR/d2d70f4e34d8829ea3c078456351ddce">https://gist.github.com/NekR/d2d70f4e34d8829ea3c078456351ddce</a></p>
<hr>
<p>This is how I think it may work. I hope it isn't very stupid :-)</p>
<p><strong>UPD:</strong> Fix assets preloading example.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/NekR"></a>
    

<div id="issuecomment-241189732" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="24e5f472dd6fa80e2f6df58582d5b522">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>



  <div class="timeline-comment-header-text">

    <strong>
      <a href="/NekR" class="author">NekR</a> 
    </strong>

    commented

      <a href="#issuecomment-241189732" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-08-20T09:32:02Z">Aug 20, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>Okay, I improved the example again and put it to a gist: <a href="https://gist.github.com/NekR/d2d70f4e34d8829ea3c078456351ddce">https://gist.github.com/NekR/d2d70f4e34d8829ea3c078456351ddce</a></p>
<p>Some notes: I do always use <code>self.requests</code> and only then  use <code>self.caches</code> to check for requests. This is because I defined that <code>self.requests.putUntil()</code> holds the requests until promise settles, which might be wrong and probably it may hold the request until SW is destroyed (or request manually removed). So in current situation, if I do <code>self.caches</code> check first, I potentially may have a race when after <code>self.caches</code> check request was removed from the <code>self.requests</code> and I missed it from both places.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/jakearchibald"></a>
    

<div id="issuecomment-241365792" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="303e471e6f081050462f4c48c1e3a9eb">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/jakearchibald" class="author">jakearchibald</a> 
    </strong>

    commented

      <a href="#issuecomment-241365792" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-08-22T09:54:05Z">Aug 22, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p><a href="https://github.com/ykahlon" class="user-mention">@ykahlon</a></p>
<blockquote>
<p>We actually need a simpler solution</p>
</blockquote>
<p>But just to clarify, the idea above works for you too?</p>
<blockquote>
<p>we would like the SW to make the preflight request and only if the SW decides to make the exact same request, it will be handed to the SW (the SW doesn't need to know whether it was a preflight request).</p>
</blockquote>
<p>So does that mean your implementation would look something like:</p>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">self</span>.<span class="pl-c1">addEventListener</span>(<span class="pl-s"><span class="pl-pds">'</span>fetch<span class="pl-pds">'</span></span>, <span class="pl-smi">event</span> <span class="pl-k">=&gt;</span> {
  <span class="pl-c1">event</span>.<span class="pl-en">respondWith</span>(
    <span class="pl-c1">event</span>.<span class="pl-smi">preloadResponse</span> <span class="pl-k">||</span> <span class="pl-en">fetch</span>(<span class="pl-c1">event</span>.<span class="pl-smi">request</span>)
  );
});</pre></div>
<p>â€¦where <code>preloadResponse</code> is a promise for a response fetched using <code>event.request</code> plus optional headers.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/ykahlon"></a>
    

<div id="issuecomment-241415077" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="26514e2862a675693e7072206df34e57">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>



  <div class="timeline-comment-header-text">

    <strong>
      <a href="/ykahlon" class="author">ykahlon</a> 
    </strong>

    commented

      <a href="#issuecomment-241415077" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-08-22T13:39:15Z">Aug 22, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p><a href="https://github.com/jakearchibald" class="user-mention">@jakearchibald</a>, The example above will work for us.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/delapuente"></a>
    

<div id="issuecomment-241860505" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="61b244c324c470912a6919f8abc16e49">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>



  <div class="timeline-comment-header-text">

    <strong>
      <a href="/delapuente" class="author">delapuente</a> 
    </strong>

    commented

      <a href="#issuecomment-241860505" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-08-23T20:09:55Z">Aug 23, 2016</relative-time></a>

      â€¢
      <span class="timestamp timestamp-edited tooltipped tooltipped-n" aria-label="delapuente edited this comment 3 months ago">
        edited
      </span>
  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>I though this option would be per route. If this is the case and trying to anticipate other kind of scenarios, what about a <code>NetworkRace</code> type and something like:</p>
<div class="highlight highlight-source-js"><pre><span class="pl-c1">navigator</span>.<span class="pl-smi">serviceWorker</span>.<span class="pl-en">register</span>(<span class="pl-s"><span class="pl-pds">'</span>sw.js<span class="pl-pds">'</span></span>, {
  routes<span class="pl-k">:</span> {
    <span class="pl-s"><span class="pl-pds">'</span>some/route<span class="pl-pds">'</span></span><span class="pl-k">:</span> <span class="pl-k">new</span> <span class="pl-en">NetworkRace</span>(),
    <span class="pl-s"><span class="pl-pds">'</span>some/other/route<span class="pl-pds">'</span></span><span class="pl-k">:</span> <span class="pl-k">new</span> <span class="pl-en">NetworkRace</span>({ headers<span class="pl-k">:</span> <span class="pl-k">...</span>, ttl<span class="pl-k">:</span> <span class="pl-k">...</span> })
  }
});</pre></div>
<p>Handling the fetch event, we can use something like:</p>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">self</span>.<span class="pl-en">onfetch</span> <span class="pl-k">=</span> <span class="pl-smi">evt</span> <span class="pl-k">=&gt;</span> {
  <span class="pl-en">doThingsWith</span>(<span class="pl-smi">evt</span>.<span class="pl-smi">networkResponse</span>);
};</pre></div>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/delapuente"></a>
    

<div id="issuecomment-241861365" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="402a8cde014c556dc9b726254701b699">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>



  <div class="timeline-comment-header-text">

    <strong>
      <a href="/delapuente" class="author">delapuente</a> 
    </strong>

    commented

      <a href="#issuecomment-241861365" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-08-23T20:12:46Z">Aug 23, 2016</relative-time></a>

      â€¢
      <span class="timestamp timestamp-edited tooltipped tooltipped-n" aria-label="delapuente edited this comment 3 months ago">
        edited
      </span>
  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>Aside, <a href="https://github.com/NekR" class="user-mention">@NekR</a> I don't get why we need the <code>RequestStorage</code>, could you clarify, please?</p>
<p>And, for clarification: suppose a <em>preflight</em> request is so fast that it answers completely before waking the service worker up? What happen then? Is that response used ignoring to trigger <code>fetch</code> to the sw? Or are we always waiting for the sw anyway? If the latter is the case, perhaps rather than <em>preload</em> or <em>preflight</em>, what we want is something like <em>ping</em>:</p>
<div class="highlight highlight-source-js"><pre><span class="pl-c1">navigator</span>.<span class="pl-smi">serviceWorker</span>.<span class="pl-en">register</span>(<span class="pl-s"><span class="pl-pds">'</span>sw.js<span class="pl-pds">'</span></span>, {
  routes<span class="pl-k">:</span> {
    <span class="pl-s"><span class="pl-pds">'</span>some/route<span class="pl-pds">'</span></span><span class="pl-k">:</span> <span class="pl-k">new</span> <span class="pl-en">PingNetwork</span>(),
    <span class="pl-s"><span class="pl-pds">'</span>some/other/route<span class="pl-pds">'</span></span><span class="pl-k">:</span> <span class="pl-k">new</span> <span class="pl-en">PingNetwork</span>({ headers<span class="pl-k">:</span> <span class="pl-k">...</span>, ttl<span class="pl-k">:</span> <span class="pl-k">...</span> })
  }
});</pre></div>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/ykahlon"></a>
    

<div id="issuecomment-241896874" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="f8661c311e7e3338787541d0caefd9d4">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>



  <div class="timeline-comment-header-text">

    <strong>
      <a href="/ykahlon" class="author">ykahlon</a> 
    </strong>

    commented

      <a href="#issuecomment-241896874" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-08-23T22:11:23Z">Aug 23, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p><a href="https://github.com/delapuente" class="user-mention">@delapuente</a>, I think that it is important that no matter what, the service worker will be the one that decides what to do with the request even if the browser already has the response ready.</p>
<p>Otherwise, the behavior will be non deterministic and in some cases the service worker may want to load from local storage or perform some other work.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/n8schloss"></a>
    

<div id="issuecomment-241924202" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="4d5f6c9b019ad947f9b28d207ccb92ef">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>



  <div class="timeline-comment-header-text">

    <strong>
      <a href="/n8schloss" class="author">n8schloss</a> 
    </strong>

    commented

      <a href="#issuecomment-241924202" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-08-24T00:31:32Z">Aug 24, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p><a href="https://github.com/delapuente" class="user-mention">@delapuente</a>, at the last f2f I think we decided that preflight was pretty tangential to routing. In this case we aren't trying to define behaviors to bypass the service worker or to race the network and cache. We simply want the request to be sent out without incurring the full service worker startup cost. Then once the service worker has started it can get the request and presumably use the resulting stream and maybe mix stuff from that stream and cache. But it's still totally up to the service worker.</p>
<p>The preflight api as talked about at the f2f is the simplest, most performant and broadest solution that we could come up with for this. Routing is another beast altogether.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/delapuente"></a>
    

<div id="issuecomment-241972467" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="d69156f83128e71bc749c608a5735ec1">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>



  <div class="timeline-comment-header-text">

    <strong>
      <a href="/delapuente" class="author">delapuente</a> 
    </strong>

    commented

      <a href="#issuecomment-241972467" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-08-24T06:46:50Z">Aug 24, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>Yes, sure, I agree with <a href="https://github.com/ykahlon" class="user-mention">@ykahlon</a> on the service worker being the ultimate responsible for handling the request and with <a href="https://github.com/n8schloss" class="user-mention">@n8schloss</a> about not routing, this API proposal was shaped to allow adding routes at some point in the future. I'm fine with a declarative API too as <a href="https://github.com/w3c/ServiceWorker/issues/920#issuecomment-241153009">proposed by @NekR</a>.</p>
<p>The thing I don't understand is the need of the <code>RequestStorage</code> (perhaps I'm missing some scenario) and I would prefer to make the preflight by <em>route</em> (actually by prefix) to not reach the network in not critic requests.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/NekR"></a>
    

<div id="issuecomment-241978130" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="af63ae3e38b61d8a64f4dbcd9062d40c">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>



  <div class="timeline-comment-header-text">

    <strong>
      <a href="/NekR" class="author">NekR</a> 
    </strong>

    commented

      <a href="#issuecomment-241978130" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-08-24T07:19:13Z">Aug 24, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p><code>RequestStorage</code> API isn't really supposed to be related to the case in this issue. I originally came with its idea in <a href="https://github.com/w3c/ServiceWorker/issues/959" class="issue-link js-issue-link" data-url="https://github.com/w3c/ServiceWorker/issues/959" data-id="171707903" data-error-text="Failed to load issue title" data-permission-text="Issue title is private">#959</a> issue. The reason why is to have a way to reuse existing requests. I'm not particularly sure how often this would happen in the wild, but the use case was:</p>
<ul>
<li>Go to page <code>A</code></li>
<li>Preload page <code>B</code> with /Link header</li>
<li>Preload page <code>B</code>'s assets by Link header in <code>B</code>'s response</li>
<li>If user clicks on the <code>B</code> link on the <code>A</code> page -- <strong>reuse existing preload requests</strong>, or load from cache, or load from network</li>
</ul>
<p>This is why I got the idea about <code>self.requests.match()</code>. Next I thought that the problem in this issue could be also solved with such API. Ideally, I think that all requests which possibly may/need to bypass SW (for performance reasons) are ended up in <code>self.requests</code> storage. In the example on my proposal I showed that only <code>preflight</code> requests goes automatically (browser puts it) into <code>self.requests</code>, but ideally all <code>Link</code> header preloads of that <code>preflight</code> request should be put into <code>self.requests</code> by the browser. The reason of course, as you mentioned, is that <code>preflight</code> might be finished before SW starts up, so browser will be able to start preloading of other critical data before SW handles preflight request.</p>
<p>One real world example might be this, which I had in one of my previous projects: We had very fast <em>newsfeed</em> generation, but very slow generation/fetching of likes for the newsfeed. So we ended up with 2 requests: one for newsfeed on one for likes, to show content to the user as fast as possible.</p>
<p>In the case with <code>preflight</code> + <code>preload</code> with Link header that could be optimized while still serving app shell from SW.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/jakearchibald"></a>
    

<div id="issuecomment-245621515" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="0182cdc08563c3baa0b5d714f2982cf2">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/jakearchibald" class="author">jakearchibald</a> 
    </strong>

    commented

      <a href="#issuecomment-245621515" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-09-08T14:45:27Z">Sep 8, 2016</relative-time></a>

      â€¢
      <span class="timestamp timestamp-edited tooltipped tooltipped-n" aria-label="jakearchibald edited this comment 3 months ago">
        edited
      </span>
  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>Right, let's sort out the API for this. How about:</p>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">self</span>.<span class="pl-c1">addEventListener</span>(<span class="pl-s"><span class="pl-pds">'</span>install<span class="pl-pds">'</span></span>, <span class="pl-smi">event</span> <span class="pl-k">=&gt;</span> {
  <span class="pl-c1">event</span>.<span class="pl-en">addNavigationPreload</span>();
});

<span class="pl-smi">self</span>.<span class="pl-c1">addEventListener</span>(<span class="pl-s"><span class="pl-pds">'</span>fetch<span class="pl-pds">'</span></span>, <span class="pl-smi">event</span> <span class="pl-k">=&gt;</span> {
  <span class="pl-c1">event</span>.<span class="pl-en">respondWith</span>(<span class="pl-c1">event</span>.<span class="pl-smi">preloadResponse</span> <span class="pl-k">||</span> <span class="pl-en">fetch</span>(<span class="pl-c1">event</span>.<span class="pl-smi">request</span>));
});</pre></div>
<ul>
<li><code>addNavigationPreload</code> must be called while the service worker's state is <code>installing</code>.</li>
<li>This setting sits with the service worker, not the registration, so if the next version of the service worker does not call <code>addNavigationPreload</code>, there will be no preloads once that service worker is active.</li>
<li>The preload happens for fetches with mode "navigation" only, and happens for <em>all</em> in-scope fetches with mode "navigation".</li>
<li>The preload request is the same as the original, except for the addition of a <code>Service-Worker: navigation-preload</code> header.</li>
<li><code>preloadResponse</code> is a promise for a response, or null if no preload was made.</li>
<li>If <code>preloadResponse</code> is unresolved by the time the fetch event has ended (including <code>waitUntil</code> etc), the browser may abort the request.</li>
<li>If <code>preloadResponse</code>'s response body has not been used by the time the fetch event has ended (including <code>waitUntil</code> etc), the browser may abort the response.</li>
</ul>
<p>How's that?</p>
<p><a href="https://github.com/n8schloss" class="user-mention">@n8schloss</a> you mentioned wanting to set a header to a particular value, but the more I think about it the more it feels like cookies with a different name. If we had a cookie API in service worker, would that be enough here?</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/n8schloss"></a>
    

<div id="issuecomment-245777469" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="248613f1e7c11a456a03d1494c24b599">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>



  <div class="timeline-comment-header-text">

    <strong>
      <a href="/n8schloss" class="author">n8schloss</a> 
    </strong>

    commented

      <a href="#issuecomment-245777469" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-09-08T23:49:12Z">Sep 9, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>Hmm, I'm not totally sure that this would work for us. Being able to modify this after the SW is installed is important and I think a header makes much more sense than cookies.</p>
<h4>Header VS Cookie</h4>
<p>We're going to be serving totally different responses when there is a SW present vs when there isn't. Having a header means that we can ensure that this extra info only gets added when there's an SW, using a cookie means that it'll always be sent. This can lead to some weird things if a user uninstalls an SW without deleting cookies, if browser vendors ever want to build something that skips SWs when they are being unresponsive, if SW cleanup runs into issues, etc.<br>
Having info that can and is only added via the SW for these requests is important, cookies would not provide this but headers do.</p>
<h4>Modifying After Instillation</h4>
<p>If we go the header route then we'll likely want to change the header without updating the SW. A use case for this is if we do a code push to update Facebook, but nothing in the Service Worker code changed. In that case we may not want to push an update to the Service Worker, but we'd still want to modify the header to match what the newest version of Facebook server code is expecting. Or we may want to update the header with information about how up to date our cache of the page chrome is, etc.<br>
If we don't go the header route, then we'll likely need to turn off preflight in cases where the active SW and Facebook server revision are out of sync and we need to add information from within the service worker before sending out requests.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/delapuente"></a>
    

<div id="issuecomment-245877935" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="dcf82fa9bae6671de889134e8c45990f">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>



  <div class="timeline-comment-header-text">

    <strong>
      <a href="/delapuente" class="author">delapuente</a> 
    </strong>

    commented

      <a href="#issuecomment-245877935" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-09-09T10:30:00Z">Sep 9, 2016</relative-time></a>

      â€¢
      <span class="timestamp timestamp-edited tooltipped tooltipped-n" aria-label="delapuente edited this comment 3 months ago">
        edited
      </span>
  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <blockquote>
<p>Having a header means that we can ensure that this extra info only gets added when there's an SW, using a cookie means that it'll always be sent.</p>
</blockquote>
<p>The header <code>Service-Worker: navigation-preload</code> is set in case of preload only. You can add extra information in a cookie and check the value only if the header is present.</p>
<p><a href="https://github.com/jakearchibald" class="user-mention">@jakearchibald</a> how about change the name <code>preload</code> with <code>prefetch</code> to align with resource hints?</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/jakearchibald"></a>
    

<div id="issuecomment-245879338" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="d4d83b61d775c0864b00ae859bffc125">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/jakearchibald" class="author">jakearchibald</a> 
    </strong>

    commented

      <a href="#issuecomment-245879338" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-09-09T10:37:49Z">Sep 9, 2016</relative-time></a>

      â€¢
      <span class="timestamp timestamp-edited tooltipped tooltipped-n" aria-label="jakearchibald edited this comment 3 months ago">
        edited
      </span>
  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p><a href="https://github.com/n8schloss" class="user-mention">@n8schloss</a> as <a href="https://github.com/delapuente" class="user-mention">@delapuente</a> points out, you'd have the fixed <code>Service-Worker: navigation-preload</code> header to identify the preload, but you'd be able to use cookies for dynamic stuff like "last post date" etc etc. Does this work?</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/jakearchibald"></a>
    

<div id="issuecomment-245879795" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="3470545bbaaf378e9194125efbdee255">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/jakearchibald" class="author">jakearchibald</a> 
    </strong>

    commented

      <a href="#issuecomment-245879795" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-09-09T10:40:23Z">Sep 9, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p><a href="https://github.com/delapuente" class="user-mention">@delapuente</a></p>
<blockquote>
<p>how about change the name <code>preload</code> with <code>prefetch</code> to align with resources hints?</p>
</blockquote>
<p><a href="https://w3c.github.io/resource-hints/#prefetch">Prefetch</a> is at the browser's discretion, <a href="http://w3c.github.io/preload/">preload</a> is a non-optional declarative fetch.</p>
<p>Since this concurrent request is not at the browser's discretion, "preload" seems like a better fit.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/delapuente"></a>
    

<div id="issuecomment-245885994" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="9769861ec022ab4176d0bd04585cdea3">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>



  <div class="timeline-comment-header-text">

    <strong>
      <a href="/delapuente" class="author">delapuente</a> 
    </strong>

    commented

      <a href="#issuecomment-245885994" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-09-09T11:15:59Z">Sep 9, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>Did not know. Thank you.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  


      


  <div class="discussion-item discussion-item-renamed">
    <div class="discussion-item-header" id="event-787420187">

      <span class="discussion-item-icon">
        <svg aria-hidden="true" class="octicon octicon-pencil" height="16" version="1.1" viewBox="0 0 14 16" width="14"><path fill-rule="evenodd" d="M0 12v3h3l8-8-3-3-8 8zm3 2H1v-2h1v1h1v1zm10.3-9.3L12 6 9 3l1.3-1.3a.996.996 0 0 1 1.41 0l1.59 1.59c.39.39.39 1.02 0 1.41z"></path></svg>
      </span>
      
      <a href="/jakearchibald" class="author">jakearchibald</a>
      
      changed the title from  <span class="renamed-was">Eliminating SW startup latency for common case</span> to <span class="renamed-is">Making a concurrent request for navigations</span> <a href="#event-787420187" class="timestamp"><relative-time class="timestamp" datetime="2016-09-13T11:45:57Z">Sep 13, 2016</relative-time></a>
    </div>
  </div>



  
      <div class="discussion-item discussion-item-ref">
    <div class="discussion-item-header" id="ref-issue-175791496">
      <span class="discussion-item-icon">
        <svg aria-hidden="true" class="octicon octicon-bookmark" height="16" version="1.1" viewBox="0 0 10 16" width="10"><path fill-rule="evenodd" d="M9 0H1C.27 0 0 .27 0 1v15l5-3.09L10 16V1c0-.73-.27-1-1-1zm-.78 4.25L6.36 5.61l.72 2.16c.06.22-.02.28-.2.17L5 6.6 3.12 7.94c-.19.11-.25.05-.2-.17l.72-2.16-1.86-1.36c-.17-.16-.14-.23.09-.23l2.3-.03.7-2.16h.25l.7 2.16 2.3.03c.23 0 .27.08.09.23h.01z"></path></svg>
      </span>

      
      <a href="/jakearchibald" class="author" truncate="true">jakearchibald</a>
      

      referenced
      this issue
      <a class="timestamp" href="#ref-issue-175791496">
        <relative-time datetime="2016-09-13T11:48:11Z">Sep 13, 2016</relative-time>
      </a>
    </div>

      <span class="state state-open float-right">
          <svg aria-hidden="true" class="octicon octicon-issue-opened" height="14" version="1.1" viewBox="0 0 14 16" width="12"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg>
        Open
      </span>



    <h4 class="discussion-item-ref-title">
      <a href="/w3c/ServiceWorker/issues/974" class="title-link">
        Create F2F agenda - 20 September 2016
        <span class="issue-num">#974</span>
</a>    </h4>
    
  </div>


  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/n8schloss"></a>
    

<div id="issuecomment-246916790" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="d5efc6f2aa6ccfd49b77f3f2b7d55ed2">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>



  <div class="timeline-comment-header-text">

    <strong>
      <a href="/n8schloss" class="author">n8schloss</a> 
    </strong>

    commented

      <a href="#issuecomment-246916790" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-09-14T06:17:16Z">Sep 14, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>Yes, with the "navigation-preload" header we can ensure that tell that something came from the Service Worker, but we still end up with a situation where we we're going to be sending down unneeded data on every request. There's data that only makes sense on preload from a service worker context so to me it makes sense that we'd just set and send them only from within the service worker.</p>
<p>Also, while this won't necessarily be a problem for us, cookies can be modified from both the window and via responses from the server. For developers who don't control their entire stack this could very well cause issues.</p>
<p>Cookies seem like a hack here, I think that being able to set data in a header makes more sense and brings preload's options more in line with what you can do with fetch today.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/jakearchibald"></a>
    

<div id="issuecomment-246998416" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="98be6181eb78299a2c6a3f41d3f439cb">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/jakearchibald" class="author">jakearchibald</a> 
    </strong>

    commented

      <a href="#issuecomment-246998416" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-09-14T12:33:44Z">Sep 14, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <blockquote>
<p>we still end up with a situation where we we're going to be sending down unneeded data on every request</p>
</blockquote>
<p>I agree that's not ideal, but how much additional data are you planning on sending? And what will that data be?</p>
<blockquote>
<p>Also, while this won't necessarily be a problem for us, cookies can be modified from both the window and via responses from the server. For developers who don't control their entire stack this could very well cause issues.</p>
</blockquote>
<p>If we want this header to be updated outside of the service worker lifecycle it puts developers in a weird position, as the code for activating this feature can get out of sync with the fetch handling code. If they activate this feature and their fetch event doesn't cater for it, they can end up with two HTTP requests per navigation rather than one.</p>
<blockquote>
<p>Cookies seem like a hack here</p>
</blockquote>
<p>Cookies already exist for storing state and sending it to the server, creating another thing which does that feels like a hack.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/asutherland"></a>
    

<div id="issuecomment-247018664" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="e6d699407c907e52049849622ebc63e4">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>



  <div class="timeline-comment-header-text">

    <strong>
      <a href="/asutherland" class="author">asutherland</a> 
    </strong>

    commented

      <a href="#issuecomment-247018664" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-09-14T13:49:37Z">Sep 14, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>Jake's cookie suggestion definitely makes a lot of sense to me.  At least in Gecko, cookies are synchronously available just like SW registrations.  They're also a known quantity, although things like limits do vary between browsers.  And creating a less wacky API to manipulate them would be a great thing for everyone.  It also avoids creating another separately managed per-TLD+1 hunk of (potentially) persistent memory.  Sites get the same (memory) budget they had before with the same latency characteristics.</p>
<p>The one downside is that without some specialization, this would end up being a "it will work most of the time" thing.  In addition to the SW-specific-cookies-not-deleted-on-unregister case <a href="https://github.com/n8schloss" class="user-mention">@n8schloss</a> pointed out, there's also the issue that cookies are subject to eviction due to browser-wide cookie limits and per-TLD+1 base domain limits.  The required specialization seems like it would be a major hack/monkeypatch not particularly justified by this use-case.  For example, we could treat a cookie with the path of the SW itself as magic so that it gets deleted on <code>unregister</code> and it is pinned so it doesn't get evicted by standard eviction logic.</p>
<p>The argument for leaving cookies as they are is that:</p>
<ul>
<li>At least for Gecko, cookie eviction occurs based on last access and global eviction happens very infrequently (~every 30 days), so an impacted SW would likely be for a rarely visited site/path where arguably the SW itself might also be appropriate to nuke.</li>
<li>If the cookie needs to be more than a boolean indicator, the cookie should end up being set regularly anyways.  Plus, the no-cookie-because-it-got-evicted case is also roughly equivalent to the first-install case.</li>
</ul>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/n8schloss"></a>
    

<div id="issuecomment-247144874" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="b2afaad1a5d9eef754a8a12f53a33c30">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>



  <div class="timeline-comment-header-text">

    <strong>
      <a href="/n8schloss" class="author">n8schloss</a> 
    </strong>

    commented

      <a href="#issuecomment-247144874" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-09-14T20:35:18Z">Sep 14, 2016</relative-time></a>

      â€¢
      <span class="timestamp timestamp-edited tooltipped tooltipped-n" aria-label="n8schloss edited this comment 3 months ago">
        edited
      </span>
  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>I still think that being able to add a custom header is preferable to cookies. To sum up my argument for a custom header:</p>
<ul>
<li>As <a href="https://github.com/asutherland" class="user-mention">@asutherland</a> said, cookies will work most of the time but they can be very unreliable. Different browsers have different limits for cookies and will do different things when they hit such limits. I think that the cookie solution will introduce a number of edge cases for when cookies are missing that will need to be dealt with. We'll be able to figure this out, but for smaller developers I think this will introduce a bit of unnecessary overhead and make doing complex things with joining cache and response streams in service workers much harder. Ultimately I think that there's somewhat of a tradeoff here between a bit of extra work for vendors and work for web developers.</li>
<li>Cookies get sent always but much of this data is only relevant for service workers. Sending the cookies on every page is a waste and also due to the various browser cookie limits it may mean that we end up hitting such limits faster.</li>
<li>Even in <a href="https://github.com/jakearchibald" class="user-mention">@jakearchibald</a>'s proposal we end up adding a header. We might as well allow developers to customize its contents.</li>
<li>No cookie API exists for service workers right now. It's nice to talk in the abstract about how it'd be nice to have one down the road, but as it stands preload would be much less useful for us until something like that was made. Such an API seems tangential from this.</li>
<li>We already allow developers to add custom headers to requests objects that they are making as a result of a fetch event. If the goal of preload is to allow for similar requests earlier then to me it seems like we should try to get as much of the fetch functionality as is reasonable. (More developer control &gt; less developer control)</li>
</ul>
<p>Would there be issues with allowing custom data to be set on a X-Service-Worker-Preload header?</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/jakearchibald"></a>
    

<div id="issuecomment-248305875" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="4999bad6af1c80e5fec039a5c6ed6c8d">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/jakearchibald" class="author">jakearchibald</a> 
    </strong>

    commented

      <a href="#issuecomment-248305875" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-09-20T13:47:06Z">Sep 20, 2016</relative-time></a>

      â€¢
      <span class="timestamp timestamp-edited tooltipped tooltipped-n" aria-label="jakearchibald edited this comment 3 months ago">
        edited
      </span>
  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <ul>
<li>We need to make sure this header doesn't get copied over on redirect</li>
<li>Some users are detecting the <code>Service-Worker</code> header and thinking it's a SW script request, so we should use a different header: <code>Navigation-Preload: true</code> by default, but can be set to any value</li>
<li>It'd be nice to have self. that refers to <em>this</em> service worker instance in a service worker global (<code>self.own</code>)</li>
<li>The header needs to be settable at any point</li>
<li>The setting should live with the lifecycle of the service worker</li>
<li>Need a way to clear it</li>
<li>What should happen if <code>value</code> is set to <code>false</code>? Is it confusing if we stringify it?</li>
</ul>
<div class="highlight highlight-source-js"><pre><span class="pl-c">// this can be called at any point</span>
<span class="pl-smi">registration</span>.<span class="pl-smi">active</span>.<span class="pl-en">setNavigationPreload</span>({
  value<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>true<span class="pl-pds">'</span></span> <span class="pl-c">// header value</span>
}).<span class="pl-en">then</span>(() <span class="pl-k">=&gt;</span> <span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-s"><span class="pl-pds">`</span>It's set!<span class="pl-pds">`</span></span>));

<span class="pl-smi">registration</span>.<span class="pl-smi">active</span>.<span class="pl-en">getNavigationPreload</span>()
  .<span class="pl-en">then</span>(<span class="pl-smi">settings</span> <span class="pl-k">=&gt;</span> <span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-smi">settings</span>.<span class="pl-c1">value</span>));

<span class="pl-smi">self</span>.<span class="pl-c1">addEventListener</span>(<span class="pl-s"><span class="pl-pds">'</span>fetch<span class="pl-pds">'</span></span>, <span class="pl-smi">event</span> <span class="pl-k">=&gt;</span> {
  <span class="pl-c1">event</span>.<span class="pl-en">respondWith</span>(<span class="pl-c1">event</span>.<span class="pl-smi">navigationPreload</span> <span class="pl-k">||</span> <span class="pl-en">fetch</span>(<span class="pl-c1">event</span>.<span class="pl-smi">request</span>));
});</pre></div>
<p><a href="https://github.com/jakearchibald" class="user-mention">@jakearchibald</a> to propose API</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions has-reactions js-reactions-container ">
    <!-- '"` --><!-- </textarea></xmp> --><form accept-charset="UTF-8" action="/w3c/ServiceWorker/reactions/update" class="js-pick-reaction" data-form-nonce="9a0bc17f76f8d6da455f8f22f97c74fd59cdd74c" data-remote="true" data-type="json" method="post"><div style="margin:0;padding:0;display:inline"><input name="utf8" type="hidden" value="âœ“"><input name="_method" type="hidden" value="put"><input name="authenticity_token" type="hidden" value="upSdmi+GCXd5+m4RIpn3f+1WFH/gTaTO/zu2MlN1I7sMEKEtLLxij7JwLz8wJhy8sVD/b8SoD3bdG1ujl0Ccxw=="></div>
      <input type="hidden" name="reaction[subject_id]" value="248305875">
      <input type="hidden" name="reaction[subject_type]" value="IssueComment">
      <div class="comment-reactions-options">
          <button disabled="" class="btn-link reaction-summary-item tooltipped tooltipped-se tooltipped-multiline " name="reaction[content]" type="submit" value="+1 react" aria-label="n8schloss reacted with thumbs up emoji">
            <g-emoji alias="+1" class="emoji mr-1" fallback-src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f44d.png" ios-version="6.0">ðŸ‘</g-emoji>
            1
          </button>
      </div>
</form></div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/delapuente"></a>
    

<div id="issuecomment-248528824" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="362342f3e20a3438282ef8ec2f46557a">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>



  <div class="timeline-comment-header-text">

    <strong>
      <a href="/delapuente" class="author">delapuente</a> 
    </strong>

    commented

      <a href="#issuecomment-248528824" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-09-21T07:05:12Z">Sep 21, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>I was thinking on <a href="https://github.com/annevk" class="user-mention">@annevk</a> proposal for <code>fetchOptions</code>. You're right on this affects <code>fetch</code> standard and it was clear to me when we make it accessible from clients. Perhaps this proposal is more complicated but what about providing a <code>window.fetchPolicies</code> namespace (exposed to Service Workers) and keep it separated from Service Workers.</p>
<div class="highlight highlight-source-js"><pre><span class="pl-c">// set or reconfigure</span>
<span class="pl-c1">window</span>.<span class="pl-smi">fetchPolicies</span>.<span class="pl-en">setNavigationPreload</span>({ headerValue<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>true<span class="pl-pds">'</span></span>, scope<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>/one-scope<span class="pl-pds">'</span></span> });
<span class="pl-c1">window</span>.<span class="pl-smi">fetchPolicies</span>.<span class="pl-en">setNavigationPreload</span>({ headerValue<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>true<span class="pl-pds">'</span></span>, scope<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>/other/scope<span class="pl-pds">'</span></span> });

<span class="pl-c">// clear</span>
<span class="pl-c1">window</span>.<span class="pl-smi">fetchPolicies</span>.<span class="pl-en">clearNavigationPreload</span>({ scope<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>/<span class="pl-pds">'</span></span> });

<span class="pl-c">// access to response.</span>
<span class="pl-smi">self</span>.<span class="pl-en">onfetch</span> <span class="pl-k">=</span> <span class="pl-smi">evt</span> <span class="pl-k">=&gt;</span> {
  <span class="pl-smi">evt</span>.<span class="pl-en">respondWith</span>(<span class="pl-smi">evt</span>.<span class="pl-smi">navigationPreload</span> <span class="pl-k">||</span> <span class="pl-en">fetch</span>(<span class="pl-c1">event</span>.<span class="pl-smi">request</span>));
};</pre></div>
<p>With ergonomics in mind, navigation preload could be set at the same time you register a Service Worker.</p>
<div class="highlight highlight-source-js"><pre><span class="pl-c1">navigator</span>.<span class="pl-smi">serviceWorker</span>.<span class="pl-en">register</span>(<span class="pl-s"><span class="pl-pds">'</span>sw.js<span class="pl-pds">'</span></span>, { scope<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>/one/scope/<span class="pl-pds">'</span></span>, navigationPreload<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>true<span class="pl-pds">'</span></span> });</pre></div>
<p>What do you think?</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/jakearchibald"></a>
    

<div id="issuecomment-248561150" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="6543631dabcd42f97a429e5ff6a051fd">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/jakearchibald" class="author">jakearchibald</a> 
    </strong>

    commented

      <a href="#issuecomment-248561150" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-09-21T09:38:12Z">Sep 21, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>This is definately a service worker API, as it's useless without it.</p>
<p>We decided to tie the setting to the SW to reduce the chance of enabling the feature when you didn't have a SW that knows how to handle it.</p>
<p>The proposal we developed as a group (in my comment above) is also accessible from clients.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/delapuente"></a>
    

<div id="issuecomment-248575039" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="c10089db5b158e7340ea374a4e24a4f2">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>



  <div class="timeline-comment-header-text">

    <strong>
      <a href="/delapuente" class="author">delapuente</a> 
    </strong>

    commented

      <a href="#issuecomment-248575039" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-09-21T10:42:20Z">Sep 21, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <blockquote>
<p>We decided to tie the setting to the SW to reduce the chance of enabling the feature when you didn't have a SW that knows how to handle it.</p>
</blockquote>
<p>Sure. +1</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/mattto"></a>
    

<div id="issuecomment-249478221" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="b4788545def86eaee714206d870e239b">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>



  <div class="timeline-comment-header-text">

    <strong>
      <a href="/mattto" class="author">mattto</a> 
    </strong>

    commented

      <a href="#issuecomment-249478221" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-09-26T04:42:45Z">Sep 26, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p><a href="https://bugs.chromium.org/p/chromium/issues/detail?id=649558">https://bugs.chromium.org/p/chromium/issues/detail?id=649558</a></p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/jakearchibald"></a>
    

<div id="issuecomment-251138064" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="59a509b229002a198f12285f9e9ac261">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/jakearchibald" class="author">jakearchibald</a> 
    </strong>

    commented

      <a href="#issuecomment-251138064" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-10-03T15:28:40Z">Oct 3, 2016</relative-time></a>

      â€¢
      <span class="timestamp timestamp-edited tooltipped tooltipped-n" aria-label="jakearchibald edited this comment 2 months ago">
        edited
      </span>
  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>Soooooo our API design doesn't really work.</p>
<p>We decided that this setting should have a lifetime associated with the service worker itself, meaning that it must be set per service worker. This reduces the likelihood that it'd be set and forgotten about, leaving (some?) users with double requests on navigations, since the preload is never used.</p>
<p>This worked well with my <a href="#issuecomment-245621515">pre-F2F proposal</a>, but we also decided that the value for the header must be settable at any point. This is at odds with the above idea, because I'm pretty sure developers will want to treat the header as a piece of state that lives beyond the service worker.</p>
<p>Eg: Imagine I'm updating my service worker. I use navigation preloads, and I want to continue using them:</p>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">self</span>.<span class="pl-c1">addEventListener</span>(<span class="pl-s"><span class="pl-pds">'</span>install<span class="pl-pds">'</span></span>, <span class="pl-smi">event</span> <span class="pl-k">=&gt;</span> {
  <span class="pl-c1">event</span>.<span class="pl-en">waitUntil</span>(
    <span class="pl-k">new</span> <span class="pl-en">Promise</span>(<span class="pl-smi">resolve</span> <span class="pl-k">=&gt;</span> {
      <span class="pl-k">if</span> (<span class="pl-k">!</span><span class="pl-smi">self</span>.<span class="pl-smi">registration</span>.<span class="pl-smi">active</span>) {
        <span class="pl-en">resolve</span>();
        <span class="pl-k">return</span>;
      }

      <span class="pl-en">resolve</span>(<span class="pl-smi">self</span>.<span class="pl-smi">registration</span>.<span class="pl-smi">active</span>.<span class="pl-en">getNavigationPreload</span>());
    }).<span class="pl-en">then</span>(<span class="pl-smi">settings</span> <span class="pl-k">=&gt;</span> {
      settings <span class="pl-k">=</span> settings <span class="pl-k">||</span> {value<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>some-default<span class="pl-pds">'</span></span>};
      <span class="pl-k">return</span> <span class="pl-smi">self</span>.<span class="pl-smi">registration</span>.<span class="pl-smi">installing</span>.<span class="pl-en">setNavigationPreload</span>(settings);
    })
  );
});</pre></div>
<p>The above is horrible, and doesn't even work. If the header value is updated at any point while the new service worker is waiting, its initial value will be out of date.</p>
<p>Developers could work around this by calling <code>setNavigationPreload</code> on all workers in a registration every time they use it (urgh), or call <code>setNavigationPreload</code> in the <code>activate</code> event, but by that time the current header setting has gone, so the developer would have to also retain it in indexedDB or whatever.</p>
<p>Feels like we've solved one footgun and created two more.</p>
<p>If allowing the header to be set at any time is a requirement (and Facebook says it is), I think we should just put this on the registration object.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/jakearchibald"></a>
    

<div id="issuecomment-251150270" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="ccf89e7eb683e8c3307759472e767ed3">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/jakearchibald" class="author">jakearchibald</a> 
    </strong>

    commented

      <a href="#issuecomment-251150270" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-10-03T16:12:46Z">Oct 3, 2016</relative-time></a>

      â€¢
      <span class="timestamp timestamp-edited tooltipped tooltipped-n" aria-label="jakearchibald edited this comment 2 months ago">
        edited
      </span>
  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>Here's a proposal for a registration-based API:</p>
<div class="highlight highlight-source-js"><pre><span class="pl-c">// enabling the feature.</span>
<span class="pl-smi">self</span>.<span class="pl-c1">addEventListener</span>(<span class="pl-s"><span class="pl-pds">'</span>activate<span class="pl-pds">'</span></span>, <span class="pl-smi">event</span> <span class="pl-k">=&gt;</span> {
  <span class="pl-c1">event</span>.<span class="pl-en">waitUntil</span>(
    <span class="pl-smi">self</span>.<span class="pl-smi">registration</span>.<span class="pl-smi">navigationPreload</span>.<span class="pl-en">enable</span>()
  );
});</pre></div>
<p><code>navigationPreload.enable</code> can be called at any point, but the recommendation will be to call it in the activate event. That way it'll be enabled when there's a service worker in place that has a fetch event listener that knows what to do with it.</p>
<p>The preload will have the header <code>Service-Worker-Navigation-Preload: true</code>. We suggested <code>Navigation-Preload</code> at the F2F, but my feeling is this could get confused with <code>link[rel=prerender]</code>.</p>
<div class="highlight highlight-source-js"><pre><span class="pl-c">// disabling the feature.</span>
<span class="pl-smi">self</span>.<span class="pl-c1">addEventListener</span>(<span class="pl-s"><span class="pl-pds">'</span>activate<span class="pl-pds">'</span></span>, <span class="pl-smi">event</span> <span class="pl-k">=&gt;</span> {
  <span class="pl-c1">event</span>.<span class="pl-en">waitUntil</span>(
    <span class="pl-smi">self</span>.<span class="pl-smi">registration</span>.<span class="pl-smi">navigationPreload</span>.<span class="pl-en">disable</span>()
  );
});</pre></div>
<p>Both <code>enable</code> and <code>disable</code> return a promise that resolves once the setting is updated on the registration.</p>
<p>If you ever launch a service worker that enables this feature, then later decide you don't need it, you're kinda doomed to forever disable it in your activate event. I don't see a way around that.</p>
<div class="highlight highlight-source-js"><pre><span class="pl-c">// access to response (same as previous proposals)</span>
<span class="pl-smi">self</span>.<span class="pl-c1">addEventListener</span>(<span class="pl-s"><span class="pl-pds">'</span>fetch<span class="pl-pds">'</span></span>, <span class="pl-smi">event</span> <span class="pl-k">=&gt;</span> {
  <span class="pl-c1">event</span>.<span class="pl-en">respondWith</span>(<span class="pl-c1">event</span>.<span class="pl-smi">navigationPreload</span> <span class="pl-k">||</span> <span class="pl-en">fetch</span>(<span class="pl-c1">event</span>.<span class="pl-smi">request</span>));
});

<span class="pl-c">// setting the header</span>
<span class="pl-smi">self</span>.<span class="pl-smi">registration</span>.<span class="pl-smi">navigationPreload</span>.<span class="pl-en">setHeaderValue</span>(<span class="pl-s"><span class="pl-pds">"</span>hello<span class="pl-pds">"</span></span>);</pre></div>
<p>The header can be set at any point. Setting returns a promise that resolves once the registration is updated. Setting the header does not auto-enable the feature. This means page code can be updating the header without enabling the feature for a service worker that isn't ready for it.</p>
<p>Also:</p>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">self</span>.<span class="pl-smi">registration</span>.<span class="pl-smi">navigationPreload</span>.<span class="pl-en">getState</span>(<span class="pl-smi">state</span> <span class="pl-k">=&gt;</span> {
  <span class="pl-en">console</span>.<span class="pl-c1">log</span>(state); <span class="pl-c">// {enabled: false, headerValue: "true"}</span>
});</pre></div>
<p>Any takers?</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions has-reactions js-reactions-container ">
    <!-- '"` --><!-- </textarea></xmp> --><form accept-charset="UTF-8" action="/w3c/ServiceWorker/reactions/update" class="js-pick-reaction" data-form-nonce="9a0bc17f76f8d6da455f8f22f97c74fd59cdd74c" data-remote="true" data-type="json" method="post"><div style="margin:0;padding:0;display:inline"><input name="utf8" type="hidden" value="âœ“"><input name="_method" type="hidden" value="put"><input name="authenticity_token" type="hidden" value="KEDnswTgDTg/VWzfJzVm8GlVD8Zu6mPFfSJzwgFIwzeexNsEB9pmwPTfLfE1io0zNVPk1koPyH1fAp5TxX18Sw=="></div>
      <input type="hidden" name="reaction[subject_id]" value="251150270">
      <input type="hidden" name="reaction[subject_type]" value="IssueComment">
      <div class="comment-reactions-options">
          <button disabled="" class="btn-link reaction-summary-item tooltipped tooltipped-se tooltipped-multiline " name="reaction[content]" type="submit" value="+1 react" aria-label="n8schloss reacted with thumbs up emoji">
            <g-emoji alias="+1" class="emoji mr-1" fallback-src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f44d.png" ios-version="6.0">ðŸ‘</g-emoji>
            1
          </button>
      </div>
</form></div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/n8schloss"></a>
    

<div id="issuecomment-251247737" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="b983ed137f94f06311de5b43261d34dd">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>



  <div class="timeline-comment-header-text">

    <strong>
      <a href="/n8schloss" class="author">n8schloss</a> 
    </strong>

    commented

      <a href="#issuecomment-251247737" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-10-03T22:38:46Z">Oct 3, 2016</relative-time></a>

      â€¢
      <span class="timestamp timestamp-edited tooltipped tooltipped-n" aria-label="n8schloss edited this comment 2 months ago">
        edited
      </span>
  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>Everything in the comment above makes sense to me. I suspect that most people will want to keep the header somewhat in line with their caches, and this isn't all that different from managing the sw cache (in terms of which lifecycle stage you'd want to do things in).</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  


      


  <div class="discussion-item discussion-item-assigned">
    <div class="discussion-item-header" id="event-811517698">

      <span class="discussion-item-icon">
        <svg aria-hidden="true" class="octicon octicon-person" height="16" version="1.1" viewBox="0 0 12 16" width="12"><path fill-rule="evenodd" d="M12 14.002a.998.998 0 0 1-.998.998H1.001A1 1 0 0 1 0 13.999V13c0-2.633 4-4 4-4s.229-.409 0-1c-.841-.62-.944-1.59-1-4 .173-2.413 1.867-3 3-3s2.827.586 3 3c-.056 2.41-.159 3.38-1 4-.229.59 0 1 0 1s4 1.367 4 4v1.002z"></path></svg>
      </span>
      
      <a href="/jakearchibald" class="author">jakearchibald</a>
      
      self-assigned this   <a href="#event-811517698" class="timestamp"><relative-time class="timestamp" datetime="2016-10-04T10:09:11Z">Oct 4, 2016</relative-time></a>
    </div>
  </div>





        <div class="discussion-item discussion-item-ref">
    <div class="discussion-item-header" id="ref-commit-50c3cdf">
      <span class="discussion-item-icon">
        <svg aria-hidden="true" class="octicon octicon-bookmark" height="16" version="1.1" viewBox="0 0 10 16" width="10"><path fill-rule="evenodd" d="M9 0H1C.27 0 0 .27 0 1v15l5-3.09L10 16V1c0-.73-.27-1-1-1zm-.78 4.25L6.36 5.61l.72 2.16c.06.22-.02.28-.2.17L5 6.6 3.12 7.94c-.19.11-.25.05-.2-.17l.72-2.16-1.86-1.36c-.17-.16-.14-.23.09-.23l2.3-.03.7-2.16h.25l.7 2.16 2.3.03c.23 0 .27.08.09.23h.01z"></path></svg>
      </span>

      
      <a href="/jakearchibald" class="author" truncate="true">jakearchibald</a>

        added a commit
        that referenced
        this issue

      <a href="#ref-commit-50c3cdf" class="timestamp">
        <relative-time datetime="2016-10-04T13:41:29Z">Oct 4, 2016</relative-time>
      </a>
    </div>

    <table class="timeline-commits">
      
<tbody><tr class="commit js-details-container js-socket-channel js-updatable-content" data-channel="tenant:1:repo:8071542:commit:50c3cdf306996d38eec91bb14f599db3b3f033c8" data-url="/w3c/ServiceWorker/commit/50c3cdf306996d38eec91bb14f599db3b3f033c8/show_partial?partial=commit%2Fcondensed">
  <td class="commit-icon">
    <svg aria-hidden="true" class="octicon octicon-git-commit" height="16" version="1.1" viewBox="0 0 14 16" width="14"><path fill-rule="evenodd" d="M10.86 7c-.45-1.72-2-3-3.86-3-1.86 0-3.41 1.28-3.86 3H0v2h3.14c.45 1.72 2 3 3.86 3 1.86 0 3.41-1.28 3.86-3H14V7h-3.14zM7 10.2c-1.22 0-2.2-.98-2.2-2.2 0-1.22.98-2.2 2.2-2.2 1.22 0 2.2.98 2.2 2.2 0 1.22-.98 2.2-2.2 2.2z"></path></svg>
  </td>

  <td class="commit-gravatar">
      <a href="/jakearchibald">
    
  </a>

  </td>

  <td class="commit-author">
    <strong><a href="/jakearchibald" class="author" rel="contributor">jakearchibald</a></strong>
  </td>

  <td class="commit-message">
    <code><a href="/w3c/ServiceWorker/commit/50c3cdf306996d38eec91bb14f599db3b3f033c8" class="message" data-pjax="true" title="API surface for #920

Still need to make the actual preload request happen, which will involves changes to the fetch API.">API surface for</a> <a href="https://github.com/w3c/ServiceWorker/issues/920" class="issue-link js-issue-link" data-url="https://github.com/w3c/ServiceWorker/issues/920" data-id="162585129" data-error-text="Failed to load issue title" data-permission-text="Issue title is private">#920</a></code>

      <span class="hidden-text-expander inline">
        <button type="button" class="ellipsis-expander js-details-target">â€¦</button>
      </span>
      <div class="commit-desc"><pre>Still need to make the actual preload request happen, which will involves changes to the fetch API.</pre></div>

      <a href="/w3c/ServiceWorker/commit/50c3cdf306996d38eec91bb14f599db3b3f033c8#comments" aria-label="View comments on this commit">
        <svg aria-hidden="true" class="octicon octicon-comment-discussion" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M15 1H6c-.55 0-1 .45-1 1v2H1c-.55 0-1 .45-1 1v6c0 .55.45 1 1 1h1v3l3-3h4c.55 0 1-.45 1-1V9h1l3 3V9h1c.55 0 1-.45 1-1V2c0-.55-.45-1-1-1zM9 11H4.5L3 12.5V11H1V5h4v3c0 .55.45 1 1 1h3v2zm6-3h-2v1.5L11.5 8H6V2h9v6z"></path></svg>
      </a>
  </td>

  <td class="commit-sig-status">
    

  </td>

  <td class="commit-ci-status">
  </td>

  <td class="commit-meta">
    <code><a href="/w3c/ServiceWorker/commit/50c3cdf306996d38eec91bb14f599db3b3f033c8" class="commit-id">50c3cdf</a></code>
  </td>
</tr>

    </tbody></table>
  </div>


  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/jakearchibald"></a>
    

<div id="issuecomment-251701959" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="0e874da240b5c5425a0fadb1af2ce4b4">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/jakearchibald" class="author">jakearchibald</a> 
    </strong>

    commented

      <a href="#issuecomment-251701959" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-10-05T15:04:50Z">Oct 5, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>I'd like us to reconsider <code>event.preloadResponse</code> instead of <code>event.navigationPreload</code>.</p>
<p>If, in future, we have some kind of routing system (<em>klaxon</em>), it'd be nice to provide a per-route way to define a preload and what it'd look like. This means preloads could happen for subresources, and maybe non-GET requests. It'd be great if we could reuse <code>event.preloadResponse</code> in that case, since it's the same feature.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions has-reactions js-reactions-container ">
    <!-- '"` --><!-- </textarea></xmp> --><form accept-charset="UTF-8" action="/w3c/ServiceWorker/reactions/update" class="js-pick-reaction" data-form-nonce="9a0bc17f76f8d6da455f8f22f97c74fd59cdd74c" data-remote="true" data-type="json" method="post"><div style="margin:0;padding:0;display:inline"><input name="utf8" type="hidden" value="âœ“"><input name="_method" type="hidden" value="put"><input name="authenticity_token" type="hidden" value="wkwJZ7KLoHHTkn4pohyn67kCOJMWWtLOQnLGtTU3vcV0yDXQsbHLiRgYPwewo0wo5QTTgzK/eXZgUisk8QICuQ=="></div>
      <input type="hidden" name="reaction[subject_id]" value="251701959">
      <input type="hidden" name="reaction[subject_type]" value="IssueComment">
      <div class="comment-reactions-options">
          <button disabled="" class="btn-link reaction-summary-item tooltipped tooltipped-se tooltipped-multiline " name="reaction[content]" type="submit" value="+1 react" aria-label="delapuente reacted with thumbs up emoji">
            <g-emoji alias="+1" class="emoji mr-1" fallback-src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f44d.png" ios-version="6.0">ðŸ‘</g-emoji>
            1
          </button>
      </div>
</form></div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/delapuente"></a>
    

<div id="issuecomment-251907551" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="3c6359fe57d8674d3d9d5105718c080b">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>



  <div class="timeline-comment-header-text">

    <strong>
      <a href="/delapuente" class="author">delapuente</a> 
    </strong>

    commented

      <a href="#issuecomment-251907551" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-10-06T09:08:57Z">Oct 6, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p><a href="https://github.com/jakearchibald" class="user-mention">@jakearchibald</a> what are the advantages to allow <code>.enable()</code> to be called at any point? And why are you forced to disable preload in the activate event? Can I disable the feature during a <code>fetch</code> event?</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/jakearchibald"></a>
    

<div id="issuecomment-251908637" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="de26625f5ecb25471c43e326a91be2ac">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/jakearchibald" class="author">jakearchibald</a> 
    </strong>

    commented

      <a href="#issuecomment-251908637" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-10-06T09:13:37Z">Oct 6, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p><a href="https://github.com/delapuente" class="user-mention">@delapuente</a></p>
<blockquote>
<p>what are the advantages to allow <code>.enable()</code> to be called at any point?</p>
</blockquote>
<p>None really. By having the setting on the registration we can't really restrict when it can be called without creating a confusing API. We'd have to strongly recommend calling it during <code>activate</code>.</p>
<blockquote>
<p>And why are you forced to disable preload in the activate event?</p>
</blockquote>
<p>It can also be disabled at any point, it's just that <code>activate</code> is the best time to do it.</p>
<blockquote>
<p>Can I disable the feature during a <code>fetch</code> event?</p>
</blockquote>
<p>Yep, whenever you want.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/annevk"></a>
    

<div id="issuecomment-251942226" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="87546d81949ba69463b8d53b96e3954f">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      text-bold
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user is a member of the World Wide Web Consortium organization.
      ">
      Member
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/annevk" class="author">annevk</a> 
    </strong>

    commented

      <a href="#issuecomment-251942226" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-10-06T12:03:26Z">Oct 6, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>Will patterns deployed for <code>preloadResponse</code> today be forward-compatible? How can we be sure?</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  
      <div class="discussion-item discussion-item-ref">
    <div class="discussion-item-header" id="ref-issue-181426428">
      <span class="discussion-item-icon">
        <svg aria-hidden="true" class="octicon octicon-bookmark" height="16" version="1.1" viewBox="0 0 10 16" width="10"><path fill-rule="evenodd" d="M9 0H1C.27 0 0 .27 0 1v15l5-3.09L10 16V1c0-.73-.27-1-1-1zm-.78 4.25L6.36 5.61l.72 2.16c.06.22-.02.28-.2.17L5 6.6 3.12 7.94c-.19.11-.25.05-.2-.17l.72-2.16-1.86-1.36c-.17-.16-.14-.23.09-.23l2.3-.03.7-2.16h.25l.7 2.16 2.3.03c.23 0 .27.08.09.23h.01z"></path></svg>
      </span>

      
      <a href="/jungkees" class="author" truncate="true">jungkees</a>
      

      referenced
      this issue
      <a class="timestamp" href="#ref-issue-181426428">
        <relative-time datetime="2016-10-07T01:45:26Z">Oct 7, 2016</relative-time>
      </a>
    </div>

      <span class="state state-open float-right">
          <svg aria-hidden="true" class="octicon octicon-issue-opened" height="14" version="1.1" viewBox="0 0 14 16" width="12"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg>
        Open
      </span>



    <h4 class="discussion-item-ref-title">
      <a href="/w3c/ServiceWorker/issues/984" class="title-link">
        Uservoice for v2 features?
        <span class="issue-num">#984</span>
</a>    </h4>
    
  </div>


  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/NekR"></a>
    

<div id="issuecomment-252245779" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="32f45e1a3305243d6fa08a0c320d3427">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>



  <div class="timeline-comment-header-text">

    <strong>
      <a href="/NekR" class="author">NekR</a> 
    </strong>

    commented

      <a href="#issuecomment-252245779" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-10-07T13:00:35Z">Oct 7, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>Just for my understanding, can anyone explain what is wrong with my <code>self.requests</code> proposal? I mean, you just moved without even saying "it doesn't work for us", which is perfectly fine because you are more experienced in it. I just want to understand what is wrong.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/jakearchibald"></a>
    

<div id="issuecomment-252248329" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="3d0504a0ed91c7fedd7c6f37f08f65d8">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/jakearchibald" class="author">jakearchibald</a> 
    </strong>

    commented

      <a href="#issuecomment-252248329" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-10-07T13:12:34Z">Oct 7, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p><a href="https://github.com/NekR" class="user-mention">@NekR</a> I see you mentioning it a few times, but I couldn't really find a concrete &amp; up-to-date proposal. I see <a href="https://gist.github.com/NekR/d2d70f4e34d8829ea3c078456351ddce">https://gist.github.com/NekR/d2d70f4e34d8829ea3c078456351ddce</a>, but it doesn't really explain how it works.</p>
<p>I'm not against (in future) some kind of API to find out about in-flight requests in the fetch group, but using such a thing becomes really tricky. Timing is especially difficult as you're exposing a single request to multiple processes.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions has-reactions js-reactions-container ">
    <!-- '"` --><!-- </textarea></xmp> --><form accept-charset="UTF-8" action="/w3c/ServiceWorker/reactions/update" class="js-pick-reaction" data-form-nonce="9a0bc17f76f8d6da455f8f22f97c74fd59cdd74c" data-remote="true" data-type="json" method="post"><div style="margin:0;padding:0;display:inline"><input name="utf8" type="hidden" value="âœ“"><input name="_method" type="hidden" value="put"><input name="authenticity_token" type="hidden" value="tmmgirNTZmsvMNCms/uCO2bnFBhP2B902fw0ClTTbx0A7Zw9sGkNk+S6kYihRGn4OuH/CGs9tMz73NmbkObQYQ=="></div>
      <input type="hidden" name="reaction[subject_id]" value="252248329">
      <input type="hidden" name="reaction[subject_type]" value="IssueComment">
      <div class="comment-reactions-options">
          <button disabled="" class="btn-link reaction-summary-item tooltipped tooltipped-se tooltipped-multiline " name="reaction[content]" type="submit" value="+1 react" aria-label="NekR reacted with thumbs up emoji">
            <g-emoji alias="+1" class="emoji mr-1" fallback-src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f44d.png" ios-version="6.0">ðŸ‘</g-emoji>
            1
          </button>
      </div>
</form></div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/NekR"></a>
    

<div id="issuecomment-252418199" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="1b429b2d11a14679bba4aaa9d8fe5a4b">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>



  <div class="timeline-comment-header-text">

    <strong>
      <a href="/NekR" class="author">NekR</a> 
    </strong>

    commented

      <a href="#issuecomment-252418199" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-10-08T10:54:10Z">Oct 8, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p><a href="https://github.com/jakearchibald" class="user-mention">@jakearchibald</a> "the proposal" was this comment: <a href="https://github.com/w3c/ServiceWorker/issues/920#issuecomment-241153009" class="issue-link js-issue-link" data-url="https://github.com/w3c/ServiceWorker/issues/920" data-id="162585129" data-error-text="Failed to load issue title" data-permission-text="Issue title is private">#920 (comment)</a> but yes, I probably had to make it in a separate repo.</p>
<blockquote>
<p>but using such a thing becomes really tricky. Timing is especially difficult as you're exposing a single request to multiple processes.</p>
</blockquote>
<p>I see. So it's just too complicated for a simple use case from this repo.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/jakearchibald"></a>
    

<div id="issuecomment-252657496" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="d14632f0ed915fdfdcf36a7ac97cf15b">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/jakearchibald" class="author">jakearchibald</a> 
    </strong>

    commented

      <a href="#issuecomment-252657496" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-10-10T15:32:20Z">Oct 10, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p><a href="https://github.com/NekR" class="user-mention">@NekR</a> No need for a separate repo, I just saw other comments saying you'd updated bits and I didn't know if you'd updated <em>that</em> comment or if it was spread across multiple places. A single gist may have been better. Anyway, here's a review:</p>
<p>Triggering this feature at registration time is confusing as it isn't clear what it's tied to. If my url &amp; scope are the same, but <code>preflight</code> has changed, will my service worker be refetched? Will preflights start happening immediately for the active worker, or is the setting tied to subsequent service workers? If I wanted to disable this feature how would I do that? Problem is the code calling <code>register</code> is likely cached, so I'd need to update my SW to update that script, then reload the page to change the setting?</p>
<p>It doesn't really mention what <code>ttl</code> does.</p>
<p>It doesn't really cover which requests are in <code>requests</code>, is it just <code>&lt;link rel="preload"&gt;</code> and this new preflight thing, or is it <em>all</em> fetches in the fetch group?</p>
<p>It doesn't cover what happens if multiple processes read a single response. Do additional reads fail? This is where most of the complexity happens, you'd need some sort of mutex for accessing a response body.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/wanderview"></a>
    

<div id="issuecomment-252949482" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="3e68ae9727b06e2e7d9d79c563454020">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/wanderview" class="author">wanderview</a> 
    </strong>

    commented

      <a href="#issuecomment-252949482" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-10-11T15:21:04Z">Oct 11, 2016</relative-time></a>

      â€¢
      <span class="timestamp timestamp-edited tooltipped tooltipped-n" aria-label="wanderview edited this comment about 1 month ago">
        edited
      </span>
  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>Some thoughts from #whatwg IRC today:</p>
<p>In regards to the "preload header", it feels like we are close to a somewhat generic thing that could be separated from the service worker API.  Perhaps we could consider:</p>
<ol>
<li>An API that matches Request objects using the Cache API matching algorithm.</li>
<li>Stores Headers values.  Each origin has a unique store.</li>
<li>When an origin performs a fetch it matches the Request against its stored values and appends any resulting Headers.</li>
<li>A service worker preload fetch would always have a <code>ServiceWorkerPreload</code> header.  This would let Requests use a <code>Vary:ServiceWorkerPreload</code> header to restrict things to preloads.</li>
</ol>
<p>Then you could do things like:</p>
<pre><code>let headers = new Headers();
headers.append('X-Food', 'Candy Corn');
headers.append('X-Drink', 'Cider');

let request = new Request('/order.html');

autoHeaders.put(request, headers);
</code></pre>
<p>Or for a preload only header:</p>
<pre><code>
let headers = new Headers();
headers.append('X-Preload-Value', 'Boo');

let request = new Request('/order.html', {
  // spec service worker preload requests to include 'ServiceWorkerPreload' header
  headers: { Vary: 'ServiceWorkerPreload' }
});

autoHeaders.put(request, headers);
</code></pre>
<p>Note, this does not provide any substring matching.  So it doesn't allow you to set headers for an entire scope or collection of URLs.  If that is needed we could consider adding it.  For Cache API, though, we considered it a de-opt and removed it previously.  Maybe its more necessary for something like this, though.</p>
<p>Anyway, this is just an idea.  I'm not objecting to the current spec proposal.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/domenic"></a>
    

<div id="issuecomment-255874864" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="64d8c14b5140a6afc2da3e70d1774e5c">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/domenic" class="author">domenic</a> 
    </strong>

    commented

      <a href="#issuecomment-255874864" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-10-24T21:42:25Z">Oct 24, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>In <a href="https://codereview.chromium.org/2416843002/">https://codereview.chromium.org/2416843002/</a> I was made aware that this proposal introduces a nullable promise type into the IDL. I guess <code>navigationPreload</code> is supposed to be specced as a <code>Promise&lt;Response&gt;?</code>.</p>
<p>We are actually hoping to outlaw that from Web IDL entirely: <a href="https://www.w3.org/Bugs/Public/show_bug.cgi?id=25049">https://www.w3.org/Bugs/Public/show_bug.cgi?id=25049</a></p>
<p>Can someone summarize why a nullable promise type is needed? I don't see any IDL in this issue, and I can't even see anyone proposing <code>navigationPreload</code> as a promise for Response, much less a nullable one, so maybe there is just some confusion going around.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/NekR"></a>
    

<div id="issuecomment-255883807" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="621450151a9482a512ce11a6d3abef8a">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>



  <div class="timeline-comment-header-text">

    <strong>
      <a href="/NekR" class="author">NekR</a> 
    </strong>

    commented

      <a href="#issuecomment-255883807" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-10-24T22:25:04Z">Oct 24, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p><a href="https://github.com/domenic" class="user-mention">@domenic</a> in short, during <em>navigate</em> <code>fetch</code> event there already could be an inflight request, or could not. So it either exists or not, and at a time of the <code>fetch</code> event response may not be available yet, hence a promise.</p>
<p>But honestly I thought that it's going to be:</p>
<div class="highlight highlight-source-js"><pre><span class="pl-k">if</span> (<span class="pl-c1">event</span>.<span class="pl-smi">navigationPreload</span>) {
  <span class="pl-c1">event</span>.<span class="pl-smi">navigationPreload</span>.<span class="pl-en">then</span>(() <span class="pl-k">=&gt;</span> <span class="pl-k">...</span>);
}</pre></div>
<p>Not nullable promise. With nullable promise it would require checking that promise all the time.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/domenic"></a>
    

<div id="issuecomment-255884077" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="ecb928d76d1142f1934def1bafcceba8">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/domenic" class="author">domenic</a> 
    </strong>

    commented

      <a href="#issuecomment-255884077" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-10-24T22:26:34Z">Oct 24, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>Maybe I was unclear. By nullable promise I mean a value that is sometimes null, instead of a promise. That appears to be what your example illustrates.</p>
<p>We should not introduce this new concept that is unused anywhere else on the platform. Everywhere else, if an attribute represents an asynchronous value, it's always accessed asynchronously---it's not sync-if-null, async-otherwise.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/n8schloss"></a>
    

<div id="issuecomment-255889885" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="ed842ec356cd1d769738831638647872">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>



  <div class="timeline-comment-header-text">

    <strong>
      <a href="/n8schloss" class="author">n8schloss</a> 
    </strong>

    commented

      <a href="#issuecomment-255889885" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-10-24T22:59:44Z">Oct 24, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p><a href="https://github.com/domenic" class="user-mention">@domenic</a>, that makes sense to me. It's important that we provide a sync way to check this though. There are times where someone might not want to call respondWith if the preload was not sent. I guess maybe we'll need something like event.hasNavigationPreload which is a bool and then event.navigationPreload which is always a Promise&lt;?Request&gt; (ie a promise that will sometimes resolve to a request and other times resolve to null)?</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/domenic"></a>
    

<div id="issuecomment-255890534" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="9689f3525705a7d34f907e4bde30eaf6">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/domenic" class="author">domenic</a> 
    </strong>

    commented

      <a href="#issuecomment-255890534" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-10-24T23:03:20Z">Oct 25, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>That would work. But I'm not sure why you wouldn't just do</p>
<div class="highlight highlight-source-js"><pre><span class="pl-c1">event</span>.<span class="pl-smi">navigationPreload</span>.<span class="pl-en">then</span>(<span class="pl-smi">res</span> <span class="pl-k">=&gt;</span> {
  <span class="pl-k">if</span> (res) {
    <span class="pl-c1">event</span>.<span class="pl-en">respondWith</span>(res);
  } <span class="pl-k">else</span> {
    <span class="pl-c">// ...</span>
  }
});</pre></div>
<p>Comparing it with</p>
<div class="highlight highlight-source-js"><pre><span class="pl-k">if</span> (<span class="pl-c1">event</span>.<span class="pl-smi">hasNavigationPreload</span>) {
  <span class="pl-c1">event</span>.<span class="pl-en">respondWith</span>(<span class="pl-c1">event</span>.<span class="pl-smi">navigationPreload</span>);
} <span class="pl-k">else</span> {
  <span class="pl-c">// ...</span>
}</pre></div>
<p>it seems like at most you'd lose a single microtask in the no-navigation-preload case, and they'd be equivalent in the yes-navigation-preload case.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/NekR"></a>
    

<div id="issuecomment-255892009" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="4a1ba5b8d33301083e60793c8ecc5002">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>



  <div class="timeline-comment-header-text">

    <strong>
      <a href="/NekR" class="author">NekR</a> 
    </strong>

    commented

      <a href="#issuecomment-255892009" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-10-24T23:12:07Z">Oct 25, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>I agree that makes sense indeed especially for <code>await</code>.</p>
<blockquote>
<p>That would work. But I'm not sure why you wouldn't just do</p>
</blockquote>
<p><code>respondWith</code> should be called in sync, AFAIK. Probably this could work instead:</p>
<div class="highlight highlight-source-js"><pre><span class="pl-k">const</span> <span class="pl-c1">wait</span> <span class="pl-k">=</span> <span class="pl-c1">event</span>.<span class="pl-smi">navigationPreload</span>.<span class="pl-en">then</span>(<span class="pl-smi">res</span> <span class="pl-k">=&gt;</span> {
  <span class="pl-k">if</span> (res) {
    <span class="pl-c1">event</span>.<span class="pl-en">respondWith</span>(res);
  } <span class="pl-k">else</span> {
    <span class="pl-c">// ...</span>
  }
});

<span class="pl-c1">event</span>.<span class="pl-en">waitUntil</span>(wait);</pre></div>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/n8schloss"></a>
    

<div id="issuecomment-255892084" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="adf3f722f3c14aa94a40da4f1c26d3d6">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>



  <div class="timeline-comment-header-text">

    <strong>
      <a href="/n8schloss" class="author">n8schloss</a> 
    </strong>

    commented

      <a href="#issuecomment-255892084" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-10-24T23:12:32Z">Oct 25, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p><a href="https://github.com/domenic" class="user-mention">@domenic</a>, wouldn't the example you posted throw an error? As soon as you've done any async work you can no longer safely call event.respondWith because any subsequent call is in a different function. (See step 1 in section 4.5.4 on <a href="https://www.w3.org/TR/service-workers/#fetch-event-respondwith-method">https://www.w3.org/TR/service-workers/#fetch-event-respondwith-method</a>)</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/domenic"></a>
    

<div id="issuecomment-255892472" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="55cd4aa416371dd3036acf3cee699892">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/domenic" class="author">domenic</a> 
    </strong>

    commented

      <a href="#issuecomment-255892472" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-10-24T23:14:52Z">Oct 25, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>Ah yeah, I wasn't aware of that, but <a href="https://github.com/NekR" class="user-mention">@NekR</a>'s got my back there :)</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  
      <div class="discussion-item discussion-item-ref">
    <div class="discussion-item-header" id="ref-issue-184979801">
      <span class="discussion-item-icon">
        <svg aria-hidden="true" class="octicon octicon-bookmark" height="16" version="1.1" viewBox="0 0 10 16" width="10"><path fill-rule="evenodd" d="M9 0H1C.27 0 0 .27 0 1v15l5-3.09L10 16V1c0-.73-.27-1-1-1zm-.78 4.25L6.36 5.61l.72 2.16c.06.22-.02.28-.2.17L5 6.6 3.12 7.94c-.19.11-.25.05-.2-.17l.72-2.16-1.86-1.36c-.17-.16-.14-.23.09-.23l2.3-.03.7-2.16h.25l.7 2.16 2.3.03c.23 0 .27.08.09.23h.01z"></path></svg>
      </span>

      
      <a href="/NekR" class="author" truncate="true">NekR</a>
      

      referenced
      this issue
      <a class="timestamp" href="#ref-issue-184979801">
        <relative-time datetime="2016-10-24T23:19:32Z">Oct 25, 2016</relative-time>
      </a>
    </div>

      <span class="state state-closed float-right">
          <svg aria-hidden="true" class="octicon octicon-issue-opened" height="14" version="1.1" viewBox="0 0 14 16" width="12"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg>
        Closed
      </span>



    <h4 class="discussion-item-ref-title">
      <a href="/w3c/ServiceWorker/issues/997" class="title-link">
        Async functions and waitUntil
        <span class="issue-num">#997</span>
</a>    </h4>
    
  </div>


  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/n8schloss"></a>
    

<div id="issuecomment-255893518" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="4a583624c1d66cc536661ad0f69db3df">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>



  <div class="timeline-comment-header-text">

    <strong>
      <a href="/n8schloss" class="author">n8schloss</a> 
    </strong>

    commented

      <a href="#issuecomment-255893518" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-10-24T23:21:30Z">Oct 25, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p><a href="https://github.com/domenic" class="user-mention">@domenic</a>, that example has the same issue :)</p>
<p>From section 4.5.4, "If the active function is not the callback of the event handler whose type is fetch, then: 1) Throw an "InvalidStateError" exception."</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/domenic"></a>
    

<div id="issuecomment-255893645" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="37e7391b1a7e9dd8c5af207396f18f3f">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/domenic" class="author">domenic</a> 
    </strong>

    commented

      <a href="#issuecomment-255893645" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-10-24T23:22:18Z">Oct 25, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>Right, we'd presumably change the spec to allow it in the appropriate event.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/NekR"></a>
    

<div id="issuecomment-255893853" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="9f733486d920b4ccb55abf412a2d03a6">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>



  <div class="timeline-comment-header-text">

    <strong>
      <a href="/NekR" class="author">NekR</a> 
    </strong>

    commented

      <a href="#issuecomment-255893853" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-10-24T23:23:36Z">Oct 25, 2016</relative-time></a>

      â€¢
      <span class="timestamp timestamp-edited tooltipped tooltipped-n" aria-label="NekR edited this comment about 1 month ago">
        edited
      </span>
  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p><a href="https://github.com/n8schloss" class="user-mention">@n8schloss</a> I expected that it may not work, that's why I tagged it "probably". But <em>not</em> knowing that sections of the spec, it feels like that should work.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/n8schloss"></a>
    

<div id="issuecomment-255894143" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="1ee98afc7557200fd4546bd0383c32d6">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>



  <div class="timeline-comment-header-text">

    <strong>
      <a href="/n8schloss" class="author">n8schloss</a> 
    </strong>

    commented

      <a href="#issuecomment-255894143" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-10-24T23:25:29Z">Oct 25, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p><a href="https://github.com/domenic" class="user-mention">@domenic</a>, I don't think that's a good idea because we still want the browser to be able to respond to the fetch event normally if respondWith wasn't called. Imo the developer really needs to decide if they are going to respond to a fetch event before any async work happens.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/NekR"></a>
    

<div id="issuecomment-255894707" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="797cbb5c83729a8848df63445f321326">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>



  <div class="timeline-comment-header-text">

    <strong>
      <a href="/NekR" class="author">NekR</a> 
    </strong>

    commented

      <a href="#issuecomment-255894707" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-10-24T23:29:17Z">Oct 25, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p><a href="https://github.com/n8schloss" class="user-mention">@n8schloss</a> That sounds reasonable too, but there are some moments when developer doesn't know that ahead of time. This is why <code>event.respondWith(fetch(event.request))</code> is trying to as close as possible to not calling <code>responseWith</code>. What is the concern of doing it after checking <code>navigationPreload</code>?</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/domenic"></a>
    

<div id="issuecomment-255894789" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="30dcdbe447f9c7a8c4cff4874bbc1196">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/domenic" class="author">domenic</a> 
    </strong>

    commented

      <a href="#issuecomment-255894789" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-10-24T23:29:45Z">Oct 25, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>I'm very confused. Above you said we weren't talking about the fetch event. Now we are again?</p>
<p>Regardless, I'll leave this to those who are more involved. My only real concerns are not having a nullable promise type, and not overburdening the API because of some desire to make it sync, when in reality the worst case would be a single microtask of delay.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/n8schloss"></a>
    

<div id="issuecomment-255895185" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="12cefeb683497901af5c6d519276094f">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>



  <div class="timeline-comment-header-text">

    <strong>
      <a href="/n8schloss" class="author">n8schloss</a> 
    </strong>

    commented

      <a href="#issuecomment-255895185" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-10-24T23:32:08Z">Oct 25, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p><a href="https://github.com/domenic" class="user-mention">@domenic</a>, we're talking about a field on the fetch event, but sure, that sounds reasonable. I'll let others chime in with what they think should be the resolution here :)</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/wanderview"></a>
    

<div id="issuecomment-255900151" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="0fd2eedc9eeab7324f044c4061d67a6e">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/wanderview" class="author">wanderview</a> 
    </strong>

    commented

      <a href="#issuecomment-255900151" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-10-25T00:05:14Z">Oct 25, 2016</relative-time></a>

      â€¢
      <span class="timestamp timestamp-edited tooltipped tooltipped-n" aria-label="wanderview edited this comment about 1 month ago">
        edited
      </span>
  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p><a href="https://github.com/n8schloss" class="user-mention">@n8schloss</a> Would you be comfortable with always calling <code>respondWith()</code> and using a pass-through fetch if necessary?</p>
<pre><code>addEventListener('fetch', evt =&gt; {
  evt.respondWith(evt.navigationPreload().then(res =&gt; {
    return res || fetch(evt.request);
  });
});
</code></pre>
<p>I think people have the impression that not calling <code>respondWith()</code> is more efficient than a pass-through fetch.  The API design, however, is built on the premise that these are effectively equivalent.  I think we should just lean on that here and continue to make the pass-through better.</p>
<p>Also, I don't recall no-respondWith being any faster than pass-through fetch in my recent benchmarking.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/n8schloss"></a>
    

<div id="issuecomment-256097596" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="ab096c9bde47752ab303b108b71031ad">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>



  <div class="timeline-comment-header-text">

    <strong>
      <a href="/n8schloss" class="author">n8schloss</a> 
    </strong>

    commented

      <a href="#issuecomment-256097596" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-10-25T17:07:18Z">Oct 25, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p><a href="https://github.com/wanderview" class="user-mention">@wanderview</a>, our in the field data is still showing fetch from service workers as much slower than fetch from the window (at least for Chrome). In Chrome this will likely be the case until crbug.com/450471 is solved. In addition to the perf benefits, there are also UX benifits to not responding to fetch from the SW. Many browsers will not show the default error page when there's a network error given to respondWith. The browser network page is going to be much much more useful that anything a developer makes to indicate that something is wrong with the user's network setup (and I think it's somewhat unreasonable for most developers to have to make an error page for each error condition that could happen anyway).</p>
<p>That being said, for us, we're likely going to always enable preload, so this is not an issue for us right now. But by not having a way to get this info synchronously we're limiting the flexibility of the api and maybe making it hard for other developers and could be hurting things that we want to do in the future. When the browser is dispatching the fetch event it should already know if it sent a preload request or not, so it doesn't seem like a huge deal to make that info available to developers.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/wanderview"></a>
    

<div id="issuecomment-256127913" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="d5cc3d653675c12b0970a1f32059341b">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/wanderview" class="author">wanderview</a> 
    </strong>

    commented

      <a href="#issuecomment-256127913" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-10-25T18:29:08Z">Oct 25, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>The error page issue is fixable by the browsers.  We just need to stash the reason for the NetworkError on an internal attribute that content can't see.  Then we can use the correct network error page if its passed back to a navigation respondWith().</p>
<p>I also feel that the perf issues should be fixable long term.</p>
<p>I guess I'm just worried about contorting the API for short term issues.  If the problems can't be fixed, we could also add a sync boolean getter later.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/n8schloss"></a>
    

<div id="issuecomment-256136202" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="d480ff694525e61a6875af663a8046a7">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>



  <div class="timeline-comment-header-text">

    <strong>
      <a href="/n8schloss" class="author">n8schloss</a> 
    </strong>

    commented

      <a href="#issuecomment-256136202" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-10-25T18:46:57Z">Oct 25, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>That's fair, on the flip side I'd argue that the browser already needs to have this data so there's minimal overhead to exposing it to the developer. Since at least for a while developers will be able to extract value from having this info, why not just expose it?</p>
<p>I realize that at this point we're kind of nitpicking, so if implementing a sync way to get this data isn't trivial then I'm fine if we don't do it :)</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/jakearchibald"></a>
    

<div id="issuecomment-256890046" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="ed75488d7017c9d4461a60acde5cef36">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/jakearchibald" class="author">jakearchibald</a> 
    </strong>

    commented

      <a href="#issuecomment-256890046" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-10-28T10:39:08Z">Oct 28, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p><a href="https://github.com/domenic" class="user-mention">@domenic</a> <a href="https://github.com/w3c/ServiceWorker/pull/983" class="issue-link js-issue-link" data-url="https://github.com/w3c/ServiceWorker/issues/983" data-id="181199067" data-error-text="Failed to load issue title" data-permission-text="Issue title is private">#983</a> for the spec work. I'm happy for <code>navigationPreload</code> to be always-there, although it feels somewhat less convenient.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/domenic"></a>
    

<div id="issuecomment-256917746" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="b103f097270b8cecafd8df9990dba64f">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/domenic" class="author">domenic</a> 
    </strong>

    commented

      <a href="#issuecomment-256917746" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-10-28T13:18:18Z">Oct 28, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p><a href="https://github.com/jakearchibald" class="user-mention">@jakearchibald</a> now that apparently <code>navigationPreload</code> is no longer returning a promise, it can be nullable with no problem if that's more convenient.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/wanderview"></a>
    

<div id="issuecomment-256962443" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="cdf89c83f0bf5969fd6f8226ce2e2356">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/wanderview" class="author">wanderview</a> 
    </strong>

    commented

      <a href="#issuecomment-256962443" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-10-28T16:12:55Z">Oct 28, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p><a href="https://github.com/jakearchibald" class="user-mention">@jakearchibald</a> Are we sure we will never want this for non-navigations?  Should it just be called <code>preload</code> instead of <code>navigationPreload</code>?</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/jakearchibald"></a>
    

<div id="issuecomment-256997405" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="f95687c65f83fa1dab7e05f5c93986dc">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/jakearchibald" class="author">jakearchibald</a> 
    </strong>

    commented

      <a href="#issuecomment-256997405" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-10-28T18:42:52Z">Oct 28, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p><a href="https://github.com/wanderview" class="user-mention">@wanderview</a> <a href="https://github.com/w3c/ServiceWorker/issues/920#issuecomment-251701959" class="issue-link js-issue-link" data-url="https://github.com/w3c/ServiceWorker/issues/920" data-id="162585129" data-error-text="Failed to load issue title" data-permission-text="Issue title is private">#920 (comment)</a></p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/jakearchibald"></a>
    

<div id="issuecomment-256997557" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="4f0bdb2831f47601638181cb55db0558">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/jakearchibald" class="author">jakearchibald</a> 
    </strong>

    commented

      <a href="#issuecomment-256997557" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-10-28T18:43:29Z">Oct 28, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p><a href="https://github.com/domenic" class="user-mention">@domenic</a> I thought it was going to be a promise. What have I missed?</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/domenic"></a>
    

<div id="issuecomment-256997897" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="400aeafc2fbf86b71b75dd1a9d2bb234">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/domenic" class="author">domenic</a> 
    </strong>

    commented

      <a href="#issuecomment-256997897" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-10-28T18:44:50Z">Oct 28, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p><a href="https://github.com/jakearchibald" class="user-mention">@jakearchibald</a> in <a href="https://github.com/w3c/ServiceWorker/pull/983" class="issue-link js-issue-link" data-url="https://github.com/w3c/ServiceWorker/issues/983" data-id="181199067" data-error-text="Failed to load issue title" data-permission-text="Issue title is private">#983</a> it's apparently going to be a <code>NavigationPreloadManager</code> instead.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/jakearchibald"></a>
    

<div id="issuecomment-256999849" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="26801a586dc0da11deed537549e9699e">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/jakearchibald" class="author">jakearchibald</a> 
    </strong>

    commented

      <a href="#issuecomment-256999849" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-10-28T18:52:59Z">Oct 28, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>That's probably an error on my part, will take a look tomorrow.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/mattto"></a>
    

<div id="issuecomment-257192152" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="f6d8ccd07428ec76c8a332037a411173">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>



  <div class="timeline-comment-header-text">

    <strong>
      <a href="/mattto" class="author">mattto</a> 
    </strong>

    commented

      <a href="#issuecomment-257192152" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-10-31T00:35:49Z">Oct 31, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>In <a href="https://github.com/w3c/ServiceWorker/pull/983" class="issue-link js-issue-link" data-url="https://github.com/w3c/ServiceWorker/issues/983" data-id="181199067" data-error-text="Failed to load issue title" data-permission-text="Issue title is private">#983</a> there are two objects named <code>navigationPreload</code>:</p>
<ul>
<li><code>ServiceWorkerRegistration.navigationPreload</code> is a <code>NavigationPreloadManager</code></li>
<li><code>FetchEvent.navigationPreload</code> is a <code>Promise&lt;Response&gt;</code>.</li>
</ul>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/jakearchibald"></a>
    

<div id="issuecomment-257251489" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="7339e56273453e66a7b4303c3f0cfc99">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/jakearchibald" class="author">jakearchibald</a> 
    </strong>

    commented

      <a href="#issuecomment-257251489" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-10-31T09:44:08Z">Oct 31, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>Yeah, I'd forgotten to add <code>FetchEvent#preloadResponse</code>.</p>
<p>Also, I've called it <code>preloadResponse</code>, I agree with <a href="https://github.com/wanderview" class="user-mention">@wanderview</a>, we don't need to make the naming navigation-only.</p>
<p>I've gone with <a href="https://github.com/domenic" class="user-mention">@domenic</a>'s suggesting of making it resolve with undefined if it isn't a navigation or the feature hasn't been enabled.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  
      <div class="discussion-item discussion-item-ref">
    <div class="discussion-item-header" id="ref-issue-186437959">
      <span class="discussion-item-icon">
        <svg aria-hidden="true" class="octicon octicon-bookmark" height="16" version="1.1" viewBox="0 0 10 16" width="10"><path fill-rule="evenodd" d="M9 0H1C.27 0 0 .27 0 1v15l5-3.09L10 16V1c0-.73-.27-1-1-1zm-.78 4.25L6.36 5.61l.72 2.16c.06.22-.02.28-.2.17L5 6.6 3.12 7.94c-.19.11-.25.05-.2-.17l.72-2.16-1.86-1.36c-.17-.16-.14-.23.09-.23l2.3-.03.7-2.16h.25l.7 2.16 2.3.03c.23 0 .27.08.09.23h.01z"></path></svg>
      </span>

      
      <a href="/mattto" class="author" truncate="true">mattto</a>
      

      referenced
      this issue
      <a class="timestamp" href="#ref-issue-186437959">
        <relative-time datetime="2016-11-01T00:45:35Z">Nov 1, 2016</relative-time>
      </a>
    </div>

      <span class="state state-open float-right">
          <svg aria-hidden="true" class="octicon octicon-issue-opened" height="14" version="1.1" viewBox="0 0 14 16" width="12"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg>
        Open
      </span>



    <h4 class="discussion-item-ref-title">
      <a href="/w3c/ServiceWorker/issues/1000" class="title-link">
        NavigationPreloadManager.setHeaderValue should reject invalid HTTP header field values
        <span class="issue-num">#1000</span>
</a>    </h4>
    
  </div>


  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/jmuransky"></a>
    

<div id="issuecomment-258832815" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="3e0c0201d4cf183aafb9bc2641c9aad9">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>



  <div class="timeline-comment-header-text">

    <strong>
      <a href="/jmuransky" class="author">jmuransky</a> 
    </strong>

    commented

      <a href="#issuecomment-258832815" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-11-07T13:17:45Z">Nov 7, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>At the risk of sounding very stupid (I do not know inner workings of browser and potentional security problems).</p>
<p>Wouldn't it be simpler to just define a way to unsubscribe some requests from service workers (e.g. what <a href="https://github.com/jakearchibald" class="user-mention">@jakearchibald</a> proposed with .declareRoute and FetchSource) AND creating an API that could manipulate browser HTTP cache (not cache api).<br>
The end result would be that developers would be able to set (from js) aggressive max-age + expires headers (which developers should already know) on critical-path requests (hence not waiting for them even if they are subject to occasional change) without waiting for service worker to startup or waiting for any other API.<br>
The added benefit would be, that developers would get means to update long-living (static) requests/resources upon webpage facelift/redesign without need to use some kind of hack (?v=X).</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/n8schloss"></a>
    

<div id="issuecomment-258906800" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="0220fa657c717b7888487dabb563e326">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>



  <div class="timeline-comment-header-text">

    <strong>
      <a href="/n8schloss" class="author">n8schloss</a> 
    </strong>

    commented

      <a href="#issuecomment-258906800" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-11-07T17:43:44Z">Nov 7, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p><a href="https://github.com/jmuransky" class="user-mention">@jmuransky</a>, that's not solving the problem that we're trying to solve here. The idea here is that we still want the service worker code to run and be able to process the result of the network fetche. We just want said fetch to go out to the network earlier, before we've incurred the cost of starting the service worker. This is somewhat similar to the optimization talked about at <a href="https://code.facebook.com/posts/1675399786008080/optimizing-facebook-for-ios-start-time/">https://code.facebook.com/posts/1675399786008080/optimizing-facebook-for-ios-start-time/</a>.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/jmuransky"></a>
    

<div id="issuecomment-259073175" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="00c867957a24a0b2c0c2568eafe789ab">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>



  <div class="timeline-comment-header-text">

    <strong>
      <a href="/jmuransky" class="author">jmuransky</a> 
    </strong>

    commented

      <a href="#issuecomment-259073175" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-11-08T08:17:31Z">Nov 8, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>Ok. My mistake then...</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  


        <div class="discussion-item discussion-item-ref">
    <div class="discussion-item-header" id="ref-commit-754e439">
      <span class="discussion-item-icon">
        <svg aria-hidden="true" class="octicon octicon-bookmark" height="16" version="1.1" viewBox="0 0 10 16" width="10"><path fill-rule="evenodd" d="M9 0H1C.27 0 0 .27 0 1v15l5-3.09L10 16V1c0-.73-.27-1-1-1zm-.78 4.25L6.36 5.61l.72 2.16c.06.22-.02.28-.2.17L5 6.6 3.12 7.94c-.19.11-.25.05-.2-.17l.72-2.16-1.86-1.36c-.17-.16-.14-.23.09-.23l2.3-.03.7-2.16h.25l.7 2.16 2.3.03c.23 0 .27.08.09.23h.01z"></path></svg>
      </span>

      
      <a href="/dstockwell" class="author" truncate="true">dstockwell</a>

        pushed a commit
          to dstockwell/chromium
        that referenced
        this issue

      <a href="#ref-commit-754e439" class="timestamp">
        <relative-time datetime="2016-11-08T10:26:29Z">Nov 8, 2016</relative-time>
      </a>
    </div>

    <table class="timeline-commits">
      
<tbody><tr class="commit js-details-container js-socket-channel js-updatable-content" data-channel="tenant:1:repo:26906128:commit:754e439177beb1271aeb6b0153e598fc2eb6d084" data-url="/dstockwell/chromium/commit/754e439177beb1271aeb6b0153e598fc2eb6d084/show_partial?partial=commit%2Fcondensed">
  <td class="commit-icon">
    <svg aria-hidden="true" class="octicon octicon-git-commit" height="16" version="1.1" viewBox="0 0 14 16" width="14"><path fill-rule="evenodd" d="M10.86 7c-.45-1.72-2-3-3.86-3-1.86 0-3.41 1.28-3.86 3H0v2h3.14c.45 1.72 2 3 3.86 3 1.86 0 3.41-1.28 3.86-3H14V7h-3.14zM7 10.2c-1.22 0-2.2-.98-2.2-2.2 0-1.22.98-2.2 2.2-2.2 1.22 0 2.2.98 2.2 2.2 0 1.22-.98 2.2-2.2 2.2z"></path></svg>
  </td>

  <td class="commit-gravatar">
      <a href="/horo-t">
    
  </a>

  </td>

  <td class="commit-author">
    <strong><a href="/horo-t" class="author" rel="contributor">horo-t</a></strong>
  </td>

  <td class="commit-message">
    <code><a href="/dstockwell/chromium/commit/754e439177beb1271aeb6b0153e598fc2eb6d084" class="message" data-pjax="true" title="Set &quot;Service-Worker-Navigation-Preload&quot; header for the navigation requests.

https://github.com/w3c/ServiceWorker/issues/920#issuecomment-251150270

BUG=649558

Review-Url: https://codereview.chromium.org/2473263003
Cr-Commit-Position: refs/heads/master@{#430559}">Set "Service-Worker-Navigation-Preload" header for the navigation reqâ€¦</a></code>

      <span class="hidden-text-expander inline">
        <button type="button" class="ellipsis-expander js-details-target">â€¦</button>
      </span>
      <div class="commit-desc"><pre>â€¦uests.


<a href="https://github.com/w3c/ServiceWorker/issues/920#issuecomment-251150270" class="issue-link js-issue-link" data-url="https://github.com/w3c/ServiceWorker/issues/920" data-id="162585129" data-error-text="Failed to load issue title" data-permission-text="Issue title is private">w3c/ServiceWorker#920 (comment)</a>

BUG=649558

Review-Url: <a href="https://codereview.chromium.org/2473263003">https://codereview.chromium.org/2473263003</a>
Cr-Commit-Position: refs/heads/master@{#430559}</pre></div>

  </td>

  <td class="commit-sig-status">
    

  </td>

  <td class="commit-ci-status">
  </td>

  <td class="commit-meta">
    <code><a href="/dstockwell/chromium/commit/754e439177beb1271aeb6b0153e598fc2eb6d084" class="commit-id">754e439</a></code>
  </td>
</tr>

    </tbody></table>
  </div>


  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/mattto"></a>
    

<div id="issuecomment-259661616" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="a2315f94bd7053971dd70f6275057aa2">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>



  <div class="timeline-comment-header-text">

    <strong>
      <a href="/mattto" class="author">mattto</a> 
    </strong>

    commented

      <a href="#issuecomment-259661616" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-11-10T10:59:13Z">Nov 10, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>Implementor feedback from Chrome: the ability to change navigation preload state (NPS) anywhere (enable/disable/setHeaderValue) is causing some complexities with how this thing is persisted in relation to the existing Registration record.</p>
<ol>
<li>I believe the ideal behavior for the NPS setters is to first persist to disk, then resolve the promise, or reject, e.g., an IO error. A much simpler design would be to resolve immediately and persist to disk as a best effort. How do others feel about this?</li>
<li>(Assuming we do care about resolving after successful persistence above) I think most complexity is caused by the ability to set NPS before there is an installed worker: register().then(r =&gt; r.navigationPreload.enable()). In this case, for Chrome, nothing is yet on disk: a stored Registration is really just an installed worker: before a worker is installed, there is nothing stored. I believe Firefox is similar. It'd simplify things if the NPS setters reject if there is no active worker. What do others feel about this restriction?</li>
</ol>
<p>Arguably the registration returned is a nascent one and won't have meaning until a worker successfully installs, so setters shouldn't be called yet.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  
      <div class="discussion-item discussion-item-ref">
    <div class="discussion-item-header" id="ref-issue-188315804">
      <span class="discussion-item-icon">
        <svg aria-hidden="true" class="octicon octicon-bookmark" height="16" version="1.1" viewBox="0 0 10 16" width="10"><path fill-rule="evenodd" d="M9 0H1C.27 0 0 .27 0 1v15l5-3.09L10 16V1c0-.73-.27-1-1-1zm-.78 4.25L6.36 5.61l.72 2.16c.06.22-.02.28-.2.17L5 6.6 3.12 7.94c-.19.11-.25.05-.2-.17l.72-2.16-1.86-1.36c-.17-.16-.14-.23.09-.23l2.3-.03.7-2.16h.25l.7 2.16 2.3.03c.23 0 .27.08.09.23h.01z"></path></svg>
      </span>

      
      <a href="/jungkees" class="author" truncate="true">jungkees</a>
      

      referenced
      this issue
        in <strong>whatwg/dom</strong>
      <a class="timestamp" href="#ref-issue-188315804">
        <relative-time datetime="2016-11-11T15:02:29Z">Nov 11, 2016</relative-time>
      </a>
    </div>

      <span class="state state-open float-right">
          <svg aria-hidden="true" class="octicon octicon-issue-opened" height="14" version="1.1" viewBox="0 0 14 16" width="12"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg>
        Open
      </span>



    <h4 class="discussion-item-ref-title">
      <a href="/whatwg/dom/issues/371" class="title-link">
        Nerfing all events on all event targets in a serviceworker after initial script evaluation seems odd
        <span class="issue-num">#371</span>
</a>    </h4>
    
  </div>


  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/mattto"></a>
    

<div id="issuecomment-261371733" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="095f4801c29ca562b6b4f5ab96811688">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>



  <div class="timeline-comment-header-text">

    <strong>
      <a href="/mattto" class="author">mattto</a> 
    </strong>

    commented

      <a href="#issuecomment-261371733" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-11-17T21:15:55Z">Nov 17, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>More specific feedback: Chrome's initial implementation will reject enable()/disable() if there is no active worker. We could change behavior later to allow it but it'd make the implementation a bit more complex. Related is <a href="https://github.com/w3c/push-api/issues/221" class="issue-link js-issue-link" data-url="https://github.com/w3c/push-api/issues/221" data-id="188460787" data-error-text="Failed to load issue title" data-permission-text="Issue title is private">w3c/push-api#221</a>, the push spec's subscribe() waits for an active worker but this can cause a deadlock (neither implementation currently follows this: Chrome rejects if no active worker and Firefox resolves without waiting).</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/n8schloss"></a>
    

<div id="issuecomment-261376486" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="8707e613e2d53656df08f5d42d34a954">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>



  <div class="timeline-comment-header-text">

    <strong>
      <a href="/n8schloss" class="author">n8schloss</a> 
    </strong>

    commented

      <a href="#issuecomment-261376486" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-11-17T21:33:23Z">Nov 17, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>From a developer perspective it's much much much simpler if you are able to call enable()/disable() during the active event. It'd be a bit confusing to have to call enable() first thing after your SW runs once it's already been activated, or to have to make logic to deal with both the activated/unactivated cases.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/mattto"></a>
    

<div id="issuecomment-261377191" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="9f421092a5edea826bb15c163fe82412">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>



  <div class="timeline-comment-header-text">

    <strong>
      <a href="/mattto" class="author">mattto</a> 
    </strong>

    commented

      <a href="#issuecomment-261377191" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-11-17T21:36:13Z">Nov 17, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>That's covered because in onactivate the worker is already active.  This will restrict you from calling it in oninstall (in the case of a new registration. during updates it's callable because there's an active worker).</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions has-reactions js-reactions-container ">
    <!-- '"` --><!-- </textarea></xmp> --><form accept-charset="UTF-8" action="/w3c/ServiceWorker/reactions/update" class="js-pick-reaction" data-form-nonce="9a0bc17f76f8d6da455f8f22f97c74fd59cdd74c" data-remote="true" data-type="json" method="post"><div style="margin:0;padding:0;display:inline"><input name="utf8" type="hidden" value="âœ“"><input name="_method" type="hidden" value="put"><input name="authenticity_token" type="hidden" value="zJtTs5cHI2AO0JJ4hOLXH2JWDvg41JhHJLtuqI8Fzet6H28ElD1ImMVa01aWXTzcPlDl6BwxM/8Gm4M5SzBylw=="></div>
      <input type="hidden" name="reaction[subject_id]" value="261377191">
      <input type="hidden" name="reaction[subject_type]" value="IssueComment">
      <div class="comment-reactions-options">
          <button disabled="" class="btn-link reaction-summary-item tooltipped tooltipped-se tooltipped-multiline " name="reaction[content]" type="submit" value="+1 react" aria-label="n8schloss reacted with thumbs up emoji">
            <g-emoji alias="+1" class="emoji mr-1" fallback-src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f44d.png" ios-version="6.0">ðŸ‘</g-emoji>
            1
          </button>
      </div>
</form></div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/mkruisselbrink"></a>
    

<div id="issuecomment-261377197" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="e4fdcd093c236974b83d88aa6e5ce539">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/mkruisselbrink" class="author">mkruisselbrink</a> 
    </strong>

    commented

      <a href="#issuecomment-261377197" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-11-17T21:36:13Z">Nov 17, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <blockquote>
<p>From a developer perspective it's much much much simpler if you are able to call enable()/disable() during the active event.</p>
</blockquote>
<p>During the activate event the worker is already the active worker (at least with the terminology as used in the spec), so I'd expect that to still work</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions has-reactions js-reactions-container ">
    <!-- '"` --><!-- </textarea></xmp> --><form accept-charset="UTF-8" action="/w3c/ServiceWorker/reactions/update" class="js-pick-reaction" data-form-nonce="9a0bc17f76f8d6da455f8f22f97c74fd59cdd74c" data-remote="true" data-type="json" method="post"><div style="margin:0;padding:0;display:inline"><input name="utf8" type="hidden" value="âœ“"><input name="_method" type="hidden" value="put"><input name="authenticity_token" type="hidden" value="JQoowB7mcrizUimaIVL8Nu8Lpy++++9kqurnhD62j+6TjhR3HdwZQHjYaLQz7Rf1sw1MP5oeRNyIygoV+oMwkg=="></div>
      <input type="hidden" name="reaction[subject_id]" value="261377197">
      <input type="hidden" name="reaction[subject_type]" value="IssueComment">
      <div class="comment-reactions-options">
          <button disabled="" class="btn-link reaction-summary-item tooltipped tooltipped-se tooltipped-multiline " name="reaction[content]" type="submit" value="+1 react" aria-label="n8schloss reacted with thumbs up emoji">
            <g-emoji alias="+1" class="emoji mr-1" fallback-src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f44d.png" ios-version="6.0">ðŸ‘</g-emoji>
            1
          </button>
      </div>
</form></div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/jakearchibald"></a>
    

<div id="issuecomment-261532932" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="e3c58486bc39e52f4f602bfbce8f3155">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/jakearchibald" class="author">jakearchibald</a> 
    </strong>

    commented

      <a href="#issuecomment-261532932" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-11-18T13:36:02Z">Nov 18, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>I think it's important for NPS promises to resolve once the data is successfully stored.</p>
<p>As for the timing, I was following the push API's lead here. I'm not against changing as long as we both change.</p>
<p>I don't fully understand the complexity in waiting. Assumingâ€¦</p>
<div class="highlight highlight-source-js"><pre><span class="pl-smi">registration</span>.<span class="pl-smi">navigationPreload</span>.<span class="pl-en">enable</span>();</pre></div>
<p>â€¦waits for an active worker, how is this more complex than:</p>
<div class="highlight highlight-source-js"><pre><span class="pl-k">await</span> <span class="pl-smi">registration</span>.<span class="pl-smi">ready</span>;
<span class="pl-smi">registration</span>.<span class="pl-smi">navigationPreload</span>.<span class="pl-en">enable</span>();</pre></div>
<p>(assuming <a href="https://github.com/w3c/ServiceWorker/issues/770" class="issue-link js-issue-link" data-url="https://github.com/w3c/ServiceWorker/issues/770" data-id="113762437" data-error-text="Failed to load issue title" data-permission-text="Issue title is private">#770</a>)</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/mattto"></a>
    

<div id="issuecomment-261783518" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="240c93c33cc794400204691e17cc672a">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>



  <div class="timeline-comment-header-text">

    <strong>
      <a href="/mattto" class="author">mattto</a> 
    </strong>

    commented

      <a href="#issuecomment-261783518" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-11-20T15:07:23Z">Nov 20, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>I actually didn't really have waiting in mind when talking about complexity above. The complexity was about implementing resolve-after-store without waiting for active. This would likely require (for Chrome) initially storing the NPS outside the registration record if needed, then moving it into the record once that's stored (to avoid regressing the time taken to load a registration).</p>
<p>Implementation-wise, I think waiting is doable. The big disadvantage is the <code>event.waitUntil(registration.navigationPreload.enable())</code> deadlock footgun in the install event. I guess developer tools can issue a warning in this case, but we'd need to do it for any API that waits for active.</p>
<p>It's still simplest to just reject when there is no active worker though. Since Chrome's push API has done this since inception, it's probably OK to keep doing it.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/jakearchibald"></a>
    

<div id="issuecomment-261989472" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="d4513057468e342a5466df371010b466">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/jakearchibald" class="author">jakearchibald</a> 
    </strong>

    commented

      <a href="#issuecomment-261989472" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-11-21T16:30:32Z">Nov 21, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p><a href="https://github.com/mattto" class="user-mention">@mattto</a></p>
<blockquote>
<p>The complexity was about implementing resolve-after-store without waiting for active</p>
</blockquote>
<p>But store can only happen once there's an active worker. If the tab closes before a worker becomes active, nothing is stored, so I'm not sure why we'd need to store anything outside the registration.</p>
<blockquote>
<p>It's still simplest to just reject when there is no active worker though. Since Chrome's push API has done this since inception, it's probably OK to keep doing it.</p>
</blockquote>
<p>Hmm, yeah, background spec also does the same even though it's spec'd to "wait". <a href="https://github.com/wanderview" class="user-mention">@wanderview</a> how do you feel about this change? I'm happy with it.</p>
<p>If we agree I'll submit PRs in push, sync &amp; update NPS.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/wanderview"></a>
    

<div id="issuecomment-261992903" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="2d55af8f30fadb5c2156d6eb3b4005bd">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/wanderview" class="author">wanderview</a> 
    </strong>

    commented

      <a href="#issuecomment-261992903" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-11-21T16:41:25Z">Nov 21, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>Works for me as long as we update the spec to match.  Thanks.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/mattto"></a>
    

<div id="issuecomment-262163095" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="4650c8c47c59b898c02d398e4741c302">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>



  <div class="timeline-comment-header-text">

    <strong>
      <a href="/mattto" class="author">mattto</a> 
    </strong>

    commented

      <a href="#issuecomment-262163095" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-11-22T07:00:24Z">Nov 22, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <blockquote>
<blockquote>
<p>The complexity was about implementing resolve-after-store without waiting for active</p>
</blockquote>
</blockquote>
<blockquote>
<p>But store can only happen once there's an active worker. If the tab closes before a worker becomes active, nothing is stored, so I'm not sure why we'd need to store anything outside the registration.</p>
</blockquote>
<p>Ah yes, this is getting into implementation details that are probably not worth going into. The proposals to reject on non-active or wait for active are OK with me, with a preference for rejection. Again my complexity feedback was about trying to implement a solution that neither waits for active nor rejects on non-active, yet still has the properties that upon resolution:</p>
<ul>
<li>the NPS has been stored, or</li>
<li>the NPS will be stored once the registration is stored (in case of no active worker yet)</li>
</ul>
<p>For this solution, itâ€™s not enough to just set the NPS in memory on our â€œIOâ€ thread (where live service worker registrations are managed) and expect it to be stored once the registration is stored because of race conditions: the store operation may already be queued up or running on the â€œDBâ€ thread. So I was thinking the DB thread should always write the newest NPS state: either in the registration if it exists or outside if not, and swap in outside NPS once the registration is stored. But I guess alternatively the DB thread could keep unstored NPS in memory and check that whenever storing a registration, so yes it could be possible. Still a bit clunky though.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/jakearchibald"></a>
    

<div id="issuecomment-262212670" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="74c8d6e909c92ae24cbeb57655c898db">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/jakearchibald" class="author">jakearchibald</a> 
    </strong>

    commented

      <a href="#issuecomment-262212670" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-11-22T11:08:03Z">Nov 22, 2016</relative-time></a>

      â€¢
      <span class="timestamp timestamp-edited tooltipped tooltipped-n" aria-label="jakearchibald edited this comment 13 days ago">
        edited
      </span>
  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body commonmark-format js-comment-body">
              <p>I'm going to update the PR so we reject if there's no active SW. I'll submit PRs for background sync and push to do the same.</p>
<p><strong>Update:</strong> I'm going to tackle <a href="https://github.com/w3c/ServiceWorker/issues/965" class="issue-link js-issue-link" data-url="https://github.com/w3c/ServiceWorker/issues/965" data-id="173737065" data-error-text="Failed to load issue title" data-permission-text="Issue title is private">#965</a> then this</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>
  


        <div class="discussion-item discussion-item-ref">
    <div class="discussion-item-header" id="ref-commit-9349b66">
      <span class="discussion-item-icon">
        <svg aria-hidden="true" class="octicon octicon-bookmark" height="16" version="1.1" viewBox="0 0 10 16" width="10"><path fill-rule="evenodd" d="M9 0H1C.27 0 0 .27 0 1v15l5-3.09L10 16V1c0-.73-.27-1-1-1zm-.78 4.25L6.36 5.61l.72 2.16c.06.22-.02.28-.2.17L5 6.6 3.12 7.94c-.19.11-.25.05-.2-.17l.72-2.16-1.86-1.36c-.17-.16-.14-.23.09-.23l2.3-.03.7-2.16h.25l.7 2.16 2.3.03c.23 0 .27.08.09.23h.01z"></path></svg>
      </span>

      
      <a href="/jakearchibald" class="author" truncate="true">jakearchibald</a>

        added a commit
          to w3c/push-api
        that referenced
        this issue

      <a href="#ref-commit-9349b66" class="timestamp">
        <relative-time datetime="2016-12-02T12:22:22Z">Dec 2, 2016</relative-time>
      </a>
    </div>

    <table class="timeline-commits">
      
<tbody><tr class="commit js-details-container js-socket-channel js-updatable-content" data-channel="tenant:1:repo:19316848:commit:9349b6616d991aff7396083d6048a04642abee2e" data-url="/w3c/push-api/commit/9349b6616d991aff7396083d6048a04642abee2e/show_partial?partial=commit%2Fcondensed">
  <td class="commit-icon">
    <svg aria-hidden="true" class="octicon octicon-git-commit" height="16" version="1.1" viewBox="0 0 14 16" width="14"><path fill-rule="evenodd" d="M10.86 7c-.45-1.72-2-3-3.86-3-1.86 0-3.41 1.28-3.86 3H0v2h3.14c.45 1.72 2 3 3.86 3 1.86 0 3.41-1.28 3.86-3H14V7h-3.14zM7 10.2c-1.22 0-2.2-.98-2.2-2.2 0-1.22.98-2.2 2.2-2.2 1.22 0 2.2.98 2.2 2.2 0 1.22-.98 2.2-2.2 2.2z"></path></svg>
  </td>

  <td class="commit-gravatar">
      <a href="/jakearchibald">
    
  </a>

  </td>

  <td class="commit-author">
    <strong><a href="/jakearchibald" class="author" rel="contributor">jakearchibald</a></strong>
  </td>

  <td class="commit-message">
    <code><a href="/w3c/push-api/commit/9349b6616d991aff7396083d6048a04642abee2e" class="message" data-pjax="true" title="Reject if there's no active service worker

This matches current implementations https://github.com/w3c/ServiceWorker/issues/920#issuecomment-261989472">Reject if there's no active service worker</a></code>

      <span class="hidden-text-expander inline">
        <button type="button" class="ellipsis-expander js-details-target">â€¦</button>
      </span>
      <div class="commit-desc"><pre>This matches current implementations <a href="https://github.com/w3c/ServiceWorker/issues/920#issuecomment-261989472" class="issue-link js-issue-link" data-url="https://github.com/w3c/ServiceWorker/issues/920" data-id="162585129" data-error-text="Failed to load issue title" data-permission-text="Issue title is private">w3c/ServiceWorker#920 (comment)</a></pre></div>

  </td>

  <td class="commit-sig-status">
    

  </td>

  <td class="commit-ci-status">
  </td>

  <td class="commit-meta">
    <code><a href="/w3c/push-api/commit/9349b6616d991aff7396083d6048a04642abee2e" class="commit-id">9349b66</a></code>
  </td>
</tr>

    </tbody></table>
  </div>


  
      <div class="discussion-item discussion-item-ref">
    <div class="discussion-item-header" id="ref-pullrequest-193104183">
      <span class="discussion-item-icon">
        <svg aria-hidden="true" class="octicon octicon-bookmark" height="16" version="1.1" viewBox="0 0 10 16" width="10"><path fill-rule="evenodd" d="M9 0H1C.27 0 0 .27 0 1v15l5-3.09L10 16V1c0-.73-.27-1-1-1zm-.78 4.25L6.36 5.61l.72 2.16c.06.22-.02.28-.2.17L5 6.6 3.12 7.94c-.19.11-.25.05-.2-.17l.72-2.16-1.86-1.36c-.17-.16-.14-.23.09-.23l2.3-.03.7-2.16h.25l.7 2.16 2.3.03c.23 0 .27.08.09.23h.01z"></path></svg>
      </span>

      
      <a href="/jakearchibald" class="author" truncate="true">jakearchibald</a>
      

      referenced
      this issue
        in <strong>w3c/push-api</strong>
      <a class="timestamp" href="#ref-pullrequest-193104183">
        <relative-time datetime="2016-12-02T12:22:29Z">Dec 2, 2016</relative-time>
      </a>
    </div>

      <span class="state state-open float-right">
          <svg aria-hidden="true" class="octicon octicon-git-pull-request" height="14" version="1.1" viewBox="0 0 12 16" width="10"><path fill-rule="evenodd" d="M11 11.28V5c-.03-.78-.34-1.47-.94-2.06C9.46 2.35 8.78 2.03 8 2H7V0L4 3l3 3V4h1c.27.02.48.11.69.31.21.2.3.42.31.69v6.28A1.993 1.993 0 0 0 10 15a1.993 1.993 0 0 0 1-3.72zm-1 2.92c-.66 0-1.2-.55-1.2-1.2 0-.65.55-1.2 1.2-1.2.65 0 1.2.55 1.2 1.2 0 .65-.55 1.2-1.2 1.2zM4 3c0-1.11-.89-2-2-2a1.993 1.993 0 0 0-1 3.72v6.56A1.993 1.993 0 0 0 2 15a1.993 1.993 0 0 0 1-3.72V4.72c.59-.34 1-.98 1-1.72zm-.8 10c0 .66-.55 1.2-1.2 1.2-.65 0-1.2-.55-1.2-1.2 0-.65.55-1.2 1.2-1.2.65 0 1.2.55 1.2 1.2zM2 4.2C1.34 4.2.8 3.65.8 3c0-.65.55-1.2 1.2-1.2.65 0 1.2.55 1.2 1.2 0 .65-.55 1.2-1.2 1.2z"></path></svg>
        Open
      </span>



    <h4 class="discussion-item-ref-title">
      <a href="/w3c/push-api/issues/230" class="title-link">
        Reject if there's no active service worker
        <span class="issue-num">#230</span>
</a>    </h4>
    
  </div>


  


        <div class="discussion-item discussion-item-ref">
    <div class="discussion-item-header" id="ref-commit-296bfcc">
      <span class="discussion-item-icon">
        <svg aria-hidden="true" class="octicon octicon-bookmark" height="16" version="1.1" viewBox="0 0 10 16" width="10"><path fill-rule="evenodd" d="M9 0H1C.27 0 0 .27 0 1v15l5-3.09L10 16V1c0-.73-.27-1-1-1zm-.78 4.25L6.36 5.61l.72 2.16c.06.22-.02.28-.2.17L5 6.6 3.12 7.94c-.19.11-.25.05-.2-.17l.72-2.16-1.86-1.36c-.17-.16-.14-.23.09-.23l2.3-.03.7-2.16h.25l.7 2.16 2.3.03c.23 0 .27.08.09.23h.01z"></path></svg>
      </span>

      
      <a href="/jakearchibald" class="author" truncate="true">jakearchibald</a>

        added a commit
          to jakearchibald/BackgroundSync
        that referenced
        this issue

      <a href="#ref-commit-296bfcc" class="timestamp">
        <relative-time datetime="2016-12-02T12:28:56Z">Dec 2, 2016</relative-time>
      </a>
    </div>

    <table class="timeline-commits">
      
<tbody><tr class="commit js-details-container js-socket-channel js-updatable-content" data-channel="tenant:1:repo:30543187:commit:296bfcc7cd0046383073f664829b2e8e681a8491" data-url="/jakearchibald/BackgroundSync/commit/296bfcc7cd0046383073f664829b2e8e681a8491/show_partial?partial=commit%2Fcondensed">
  <td class="commit-icon">
    <svg aria-hidden="true" class="octicon octicon-git-commit" height="16" version="1.1" viewBox="0 0 14 16" width="14"><path fill-rule="evenodd" d="M10.86 7c-.45-1.72-2-3-3.86-3-1.86 0-3.41 1.28-3.86 3H0v2h3.14c.45 1.72 2 3 3.86 3 1.86 0 3.41-1.28 3.86-3H14V7h-3.14zM7 10.2c-1.22 0-2.2-.98-2.2-2.2 0-1.22.98-2.2 2.2-2.2 1.22 0 2.2.98 2.2 2.2 0 1.22-.98 2.2-2.2 2.2z"></path></svg>
  </td>

  <td class="commit-gravatar">
      <a href="/jakearchibald">
    
  </a>

  </td>

  <td class="commit-author">
    <strong><a href="/jakearchibald" class="author" rel="contributor">jakearchibald</a></strong>
  </td>

  <td class="commit-message">
    <code><a href="/jakearchibald/BackgroundSync/commit/296bfcc7cd0046383073f664829b2e8e681a8491" class="message" data-pjax="true" title="Reject if active worker is null.
As per agreement in https://github.com/w3c/ServiceWorker/issues/920#issuecomment-261989472">Reject if active worker is null.</a></code>

      <span class="hidden-text-expander inline">
        <button type="button" class="ellipsis-expander js-details-target">â€¦</button>
      </span>
      <div class="commit-desc"><pre>As per agreement in <a href="https://github.com/w3c/ServiceWorker/issues/920#issuecomment-261989472" class="issue-link js-issue-link" data-url="https://github.com/w3c/ServiceWorker/issues/920" data-id="162585129" data-error-text="Failed to load issue title" data-permission-text="Issue title is private">w3c/ServiceWorker#920 (comment)</a></pre></div>

  </td>

  <td class="commit-sig-status">
    

  </td>

  <td class="commit-ci-status">
  </td>

  <td class="commit-meta">
    <code><a href="/jakearchibald/BackgroundSync/commit/296bfcc7cd0046383073f664829b2e8e681a8491" class="commit-id">296bfcc</a></code>
  </td>
</tr>

    </tbody></table>
  </div>




        <div class="discussion-item discussion-item-ref">
    <div class="discussion-item-header" id="ref-commit-e05a71d">
      <span class="discussion-item-icon">
        <svg aria-hidden="true" class="octicon octicon-bookmark" height="16" version="1.1" viewBox="0 0 10 16" width="10"><path fill-rule="evenodd" d="M9 0H1C.27 0 0 .27 0 1v15l5-3.09L10 16V1c0-.73-.27-1-1-1zm-.78 4.25L6.36 5.61l.72 2.16c.06.22-.02.28-.2.17L5 6.6 3.12 7.94c-.19.11-.25.05-.2-.17l.72-2.16-1.86-1.36c-.17-.16-.14-.23.09-.23l2.3-.03.7-2.16h.25l.7 2.16 2.3.03c.23 0 .27.08.09.23h.01z"></path></svg>
      </span>

      
      <a href="/jakearchibald" class="author" truncate="true">jakearchibald</a>

        added a commit
          to jakearchibald/BackgroundSync
        that referenced
        this issue

      <a href="#ref-commit-e05a71d" class="timestamp">
        <relative-time datetime="2016-12-02T12:31:20Z">Dec 2, 2016</relative-time>
      </a>
    </div>

    <table class="timeline-commits">
      
<tbody><tr class="commit js-details-container js-socket-channel js-updatable-content" data-channel="tenant:1:repo:30543187:commit:e05a71d4c6cc1fa0f8ba7c21ec646eff0829950d" data-url="/jakearchibald/BackgroundSync/commit/e05a71d4c6cc1fa0f8ba7c21ec646eff0829950d/show_partial?partial=commit%2Fcondensed">
  <td class="commit-icon">
    <svg aria-hidden="true" class="octicon octicon-git-commit" height="16" version="1.1" viewBox="0 0 14 16" width="14"><path fill-rule="evenodd" d="M10.86 7c-.45-1.72-2-3-3.86-3-1.86 0-3.41 1.28-3.86 3H0v2h3.14c.45 1.72 2 3 3.86 3 1.86 0 3.41-1.28 3.86-3H14V7h-3.14zM7 10.2c-1.22 0-2.2-.98-2.2-2.2 0-1.22.98-2.2 2.2-2.2 1.22 0 2.2.98 2.2 2.2 0 1.22-.98 2.2-2.2 2.2z"></path></svg>
  </td>

  <td class="commit-gravatar">
      <a href="/jakearchibald">
    
  </a>

  </td>

  <td class="commit-author">
    <strong><a href="/jakearchibald" class="author" rel="contributor">jakearchibald</a></strong>
  </td>

  <td class="commit-message">
    <code><a href="/jakearchibald/BackgroundSync/commit/e05a71d4c6cc1fa0f8ba7c21ec646eff0829950d" class="message" data-pjax="true" title="Reject if active worker is null.
As per agreement in https://github.com/w3c/ServiceWorker/issues/920#issuecomment-261989472">Reject if active worker is null.</a></code>

      <span class="hidden-text-expander inline">
        <button type="button" class="ellipsis-expander js-details-target">â€¦</button>
      </span>
      <div class="commit-desc"><pre>As per agreement in <a href="https://github.com/w3c/ServiceWorker/issues/920#issuecomment-261989472" class="issue-link js-issue-link" data-url="https://github.com/w3c/ServiceWorker/issues/920" data-id="162585129" data-error-text="Failed to load issue title" data-permission-text="Issue title is private">w3c/ServiceWorker#920 (comment)</a></pre></div>

  </td>

  <td class="commit-sig-status">
    

  </td>

  <td class="commit-ci-status">
  </td>

  <td class="commit-meta">
    <code><a href="/jakearchibald/BackgroundSync/commit/e05a71d4c6cc1fa0f8ba7c21ec646eff0829950d" class="commit-id">e05a71d</a></code>
  </td>
</tr>

    </tbody></table>
  </div>


  
      <div class="discussion-item discussion-item-ref">
    <div class="discussion-item-header" id="ref-pullrequest-193105719">
      <span class="discussion-item-icon">
        <svg aria-hidden="true" class="octicon octicon-bookmark" height="16" version="1.1" viewBox="0 0 10 16" width="10"><path fill-rule="evenodd" d="M9 0H1C.27 0 0 .27 0 1v15l5-3.09L10 16V1c0-.73-.27-1-1-1zm-.78 4.25L6.36 5.61l.72 2.16c.06.22-.02.28-.2.17L5 6.6 3.12 7.94c-.19.11-.25.05-.2-.17l.72-2.16-1.86-1.36c-.17-.16-.14-.23.09-.23l2.3-.03.7-2.16h.25l.7 2.16 2.3.03c.23 0 .27.08.09.23h.01z"></path></svg>
      </span>

      
      <a href="/jakearchibald" class="author" truncate="true">jakearchibald</a>
      

      referenced
      this issue
        in <strong>WICG/BackgroundSync</strong>
      <a class="timestamp" href="#ref-pullrequest-193105719">
        <relative-time datetime="2016-12-02T12:31:28Z">Dec 2, 2016</relative-time>
      </a>
    </div>

      <span class="state state-open float-right">
          <svg aria-hidden="true" class="octicon octicon-git-pull-request" height="14" version="1.1" viewBox="0 0 12 16" width="10"><path fill-rule="evenodd" d="M11 11.28V5c-.03-.78-.34-1.47-.94-2.06C9.46 2.35 8.78 2.03 8 2H7V0L4 3l3 3V4h1c.27.02.48.11.69.31.21.2.3.42.31.69v6.28A1.993 1.993 0 0 0 10 15a1.993 1.993 0 0 0 1-3.72zm-1 2.92c-.66 0-1.2-.55-1.2-1.2 0-.65.55-1.2 1.2-1.2.65 0 1.2.55 1.2 1.2 0 .65-.55 1.2-1.2 1.2zM4 3c0-1.11-.89-2-2-2a1.993 1.993 0 0 0-1 3.72v6.56A1.993 1.993 0 0 0 2 15a1.993 1.993 0 0 0 1-3.72V4.72c.59-.34 1-.98 1-1.72zm-.8 10c0 .66-.55 1.2-1.2 1.2-.65 0-1.2-.55-1.2-1.2 0-.65.55-1.2 1.2-1.2.65 0 1.2.55 1.2 1.2zM2 4.2C1.34 4.2.8 3.65.8 3c0-.65.55-1.2 1.2-1.2.65 0 1.2.55 1.2 1.2 0 .65-.55 1.2-1.2 1.2z"></path></svg>
        Open
      </span>



    <h4 class="discussion-item-ref-title">
      <a href="/WICG/BackgroundSync/issues/134" class="title-link">
        Reject if active worker is null.
        <span class="issue-num">#134</span>
</a>    </h4>
    
  </div>


  <div class="timeline-comment-wrapper js-comment-container">
    <a href="/jakearchibald"></a>
    

<div id="issuecomment-264444440" class="comment previewable-edit timeline-comment js-comment js-task-list-container
                    
                      " data-body-version="d50dd8a8bbc25707e663f8a99e1a7211">

  
<div class="timeline-comment-header ">

  <div class="timeline-comment-actions">


  </div>

    <span class="timeline-comment-label
      
        tooltipped tooltipped-multiline tooltipped-s" aria-label="This user has been invited to collaborate on the ServiceWorker repository.
      ">
      Collaborator
    </span>


  <div class="timeline-comment-header-text">

    <strong>
      <a href="/jakearchibald" class="author">jakearchibald</a> 
    </strong>

    commented

      <a href="#issuecomment-264444440" class="timestamp" aria-label="Link to this comment"><relative-time datetime="2016-12-02T12:32:19Z">Dec 2, 2016</relative-time></a>

  </div>
</div>


  <div class="edit-comment-hide">
    <table class="d-block">
      <tbody class="d-block">
        <tr class="d-block">
          <td class="d-block comment-body markdown-body markdown-format js-comment-body">
              <p>Ok, I've updated the spec to update if there's no active worker. Also filed <a href="https://github.com/w3c/push-api/pull/230" class="issue-link js-issue-link" data-url="https://github.com/w3c/push-api/issues/230" data-id="193104183" data-error-text="Failed to load issue title" data-permission-text="Issue title is private">w3c/push-api#230</a> and <a href="https://github.com/WICG/BackgroundSync/pull/134" class="issue-link js-issue-link" data-url="https://github.com/WICG/BackgroundSync/issues/134" data-id="193105719" data-error-text="Failed to load issue title" data-permission-text="Issue title is private">WICG/BackgroundSync#134</a>.</p>
          </td>
        </tr>
      </tbody>
    </table>

      

<div class="comment-reactions  js-reactions-container ">
</div>

  </div>

</div>

  </div>





<!-- Rendered timeline since 2016-12-02 04:32:19 -->
<div id="partial-timeline-marker" class="js-timeline-marker js-socket-channel js-updatable-content" data-channel="tenant:1:issue:162585129" data-url="/w3c/ServiceWorker/issues/920/show_partial?partial=issues%2Ftimeline_marker&amp;since=1480681939" data-last-modified="Fri, 02 Dec 2016 12:32:19 GMT">

    <!-- '"` --><!-- </textarea></xmp> --><form accept-charset="UTF-8" action="/w3c/ServiceWorker/notifications/mark?ids=150907465" class="d-none js-timeline-marker-form" data-form-nonce="9a0bc17f76f8d6da455f8f22f97c74fd59cdd74c" data-remote="true" method="post"><div style="margin:0;padding:0;display:inline"><input name="utf8" type="hidden" value="âœ“"><input name="authenticity_token" type="hidden" value="h3SmM+T5c/WF+ku4fI9Qh53VCDF3Z2LwvIOIvI615iYx8JqE58MYDU5wCpZuMLtEwdPjIVOCyUieo2UtSoBZWg=="></div>
</form></div>


        </div>
      </div>

    </div>
    <div class="clear"></div>
  </div>

</div>


  </div>
</div>
</div>
</body>
</html>